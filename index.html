<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Neon J.B - AI Training</title>
    <meta name="theme-color" content="#00D0FF">
    <meta name="description" content="Fitness Tracker: Tu sistema de entrenamiento en casa">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Design System: Clean Fitbit-inspired */
        :root {
            --bg-color: #0b1221; /* deep navy */
            --card-bg: #121a2b; /* card surface */
            --primary: #e6f2ff; /* text on dark */
            --secondary: #9fb3c8; /* muted text */
            --accent: #2ad1c9; /* teal accent */
            --accent-hover: #24b8b1;
            --metabolic: #ff4d8d; /* energetic pink for highlights */
            --border: #234161; /* subtle borders */
            --success: #4ade80; /* green */
            --warning: #f59e0b; /* amber */
            --danger: #ef4444; /* red */
            --shadow-soft: 0 8px 24px rgba(0,0,0,0.25);
        }

        body {
            background: var(--bg-color);
            color: var(--primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding-bottom: 3rem;
            padding-top: 1rem;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5 {
            font-family: 'Lora', serif;
        }

        .main-container {
            max-width: 980px;
            background-color: var(--card-bg);
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
        }

        .progress-bar-container {
            height: 0.5rem;
            background-color: rgba(255, 255, 255, 0.06);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent);
            transition: width 0.4s ease;
            border-radius: 9999px;
        }

        /* Navigation */
        .nav-tab {
            transition: color 0.2s ease, border-color 0.2s ease;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--secondary);
        }

        .nav-tab.tab-active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 1rem 0;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Calendar */
        .calendar-container {
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .calendar-headers {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-bottom: 0.5rem;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--secondary);
            background: transparent;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        /* Mobile: List view */
        @media (max-width: 768px) {
            .calendar-grid {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                max-height: 70vh;
                overflow-y: auto;
                padding-right: 0.5rem;
            }
            .calendar-grid::-webkit-scrollbar {
                width: 6px;
            }
            .calendar-grid::-webkit-scrollbar-track {
                background: rgba(0, 212, 255, 0.1);
                border-radius: 10px;
            }
            .calendar-grid::-webkit-scrollbar-thumb {
                background: rgba(0, 212, 255, 0.4);
                border-radius: 10px;
            }
            .calendar-grid::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 212, 255, 0.6);
            }
        }

        .calendar-day {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
            position: relative;
            padding: 0.75rem;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            color: var(--primary);
            border-radius: 10px;
            overflow: hidden;
        }

        /* Desktop: Square grid */
        @media (min-width: 769px) {
            .calendar-day {
                aspect-ratio: 1 / 1.1;
            }
        }

        /* Mobile: Full width list items */
        @media (max-width: 768px) {
            .calendar-day {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                padding: 1rem;
                min-height: 70px;
                width: 100%;
            }
            .calendar-day > div:first-child {
                display: flex;
                align-items: center;
                gap: 1rem;
                flex: 1;
            }
            .calendar-day .font-bold {
                font-size: 1.25rem;
                min-width: 40px;
            }
        }
        .calendar-day::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.05), rgba(29, 255, 127, 0.05));
            pointer-events: none;
            border-radius: inherit;
        }
        .calendar-day > * {
            position: relative;
            z-index: 1;
        }
        .calendar-day .font-bold { font-size: 0.875rem; color: var(--accent); }
        .calendar-day .text-xs { font-size: 0.6rem; }

        .calendar-day[data-date]:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }
        .calendar-day.today {
            border-color: var(--accent);
            background-color: rgba(42, 209, 201, 0.08) !important;
            border-width: 2px;
        }

        /* Animations and Visuals */
        .animated-text-glow {
            text-shadow: var(--glow-metabolic);
            color: var(--primary);
        }

        .metabolic-text {
            color: var(--metabolic) !important;
            text-shadow: 0 0 15px rgba(255, 0, 110, 0.8), 0 0 30px rgba(255, 0, 110, 0.5);
        }

        .metabolic-border {
            border-color: var(--metabolic) !important;
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.4) inset, 0 0 30px rgba(255, 0, 110, 0.3);
        }

        .metabolic-shadow {
            box-shadow: 0 0 25px rgba(255, 0, 110, 0.6), 0 0 15px rgba(255, 0, 110, 0.3);
        }

        /* Exercise Library Cards */
        .exercise-card {
            margin-bottom: 1.25rem;
            padding: 1.25rem;
            border-radius: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-soft);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .exercise-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .exercise-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .section-title {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.75rem;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
        }
        
        /* Celebration Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 100;
            animation: fall linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto main-container rounded-lg shadow-2xl border border-border">
        
        <header class="text-center my-6 mb-8 relative px-4">
            <div class="inline-block relative group cursor-default">
                <h1 class="text-6xl md:text-7xl lg:text-8xl font-bold italic tracking-tight mb-0" 
                    style="color: #7dd3fc; text-shadow: 0 0 40px rgba(125, 211, 252, 0.8), 0 0 80px rgba(125, 211, 252, 0.5), 0 0 120px rgba(125, 211, 252, 0.3);">
                    BERNI
                </h1>
                <h2 class="text-5xl md:text-6xl lg:text-7xl font-bold italic tracking-tight my-2" 
                    style="color: #f472b6; text-shadow: 0 0 40px rgba(244, 114, 182, 0.8), 0 0 80px rgba(244, 114, 182, 0.5);">
                    AI
                </h2>
                <h2 class="text-5xl md:text-6xl lg:text-7xl font-bold italic tracking-tight mb-4" 
                    style="color: #7dd3fc; text-shadow: 0 0 40px rgba(125, 211, 252, 0.8), 0 0 80px rgba(125, 211, 252, 0.5), 0 0 120px rgba(125, 211, 252, 0.3);">
                    TRAINING
                </h2>
                
                <div class="flex items-center justify-center gap-4 mt-6">
                    <span class="flex-1 h-px bg-gradient-to-r from-transparent to-accent/50"></span>
                    <p class="text-xs md:text-sm tracking-widest font-semibold text-secondary/70">HOME WORKOUTS</p>
                    <span class="text-accent/50">‚ö°</span>
                    <p class="text-xs md:text-sm tracking-widest font-semibold text-secondary/70">OPTIMIZE. EXECUTE. EVOLVE.</p>
                    <span class="flex-1 h-px bg-gradient-to-l from-transparent to-accent/50"></span>
                </div>
            </div>
        </header>

        <div class="mb-6 p-4 bg-black/40 rounded-lg shadow-lg border border-accent/50 backdrop-blur-sm">
            <h2 class="text-center text-lg font-bold text-accent mb-3">üìä Progreso Mensual</h2>
            <div id="global-progress-text" class="text-center font-bold text-xl mb-2 text-emerald-400">0%</div>
            <div class="progress-bar-container">
                <div id="global-progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <div id="global-stats" class="mt-4"></div>
        </div>

        <nav class="flex justify-between items-center border-b border-border mb-6">
            <div class="flex flex-wrap justify-center -mb-px overflow-x-auto flex-1">
                <button data-tab="hoy" class="nav-tab text-md py-3 px-3 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üóìÔ∏è <span data-key="today">Hoy</span></button>
                <button data-tab="calendario" class="nav-tab text-md py-3 px-3 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üìÖ <span data-key="calendar">Calendario</span></button>
                <button data-tab="rutinas" class="nav-tab text-md py-3 px-3 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üèãÔ∏è‚Äç‚ôÇÔ∏è <span data-key="routines">Rutinas</span></button>
                <button data-tab="biblioteca" class="nav-tab text-md py-3 px-3 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üìö <span data-key="library">Biblioteca</span></button>
            </div>
        </nav>

        <main id="main-content">
            <section id="hoy" class="content-section"></section>
            
            <section id="calendario" class="content-section">
                <div class="calendar-container w-full">
                    <div class="text-center mb-6">
                        <h2 id="calendar-title" class="text-2xl md:text-3xl font-bold text-accent mb-2" style="text-shadow: 0 0 15px rgba(0, 212, 255, 0.6);">üìÖ Diciembre 2025</h2>
                        <p class="text-sm text-secondary/70">Tu plan de entrenamiento mensual</p>
                    </div>
                    <div class="calendar-headers hidden md:grid">
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mi√©</div>
                        <div class="calendar-day-header">Jue</div>
                        <div class="calendar-day-header">Vie</div>
                        <div class="calendar-day-header">S√°b</div>
                        <div class="calendar-day-header">Dom</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
            </section>
            
            <section id="rutinas" class="content-section">
                <div class="mb-6 text-center">
                    <h2 class="text-2xl md:text-3xl font-bold text-accent mb-2" style="text-shadow: 0 0 15px rgba(0, 212, 255, 0.6);">üèãÔ∏è Rutinas de Entrenamiento</h2>
                    <p class="text-sm text-secondary/70">Selecciona una rutina para ver los ejercicios</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
                    <button data-routine="TORSO_PUSH" class="routine-selector bg-gradient-to-br from-sky-900/40 to-sky-800/20 hover:from-sky-800/60 hover:to-sky-700/40 text-sky-400 font-semibold py-4 px-4 border-2 border-sky-500/50 rounded-xl shadow-lg transition-all hover:scale-105 hover:shadow-sky-500/30">
                        <div class="text-2xl mb-1">üí™</div>
                        <span class="text-sm">Push</span>
                    </button>
                    <button data-routine="LEGS_ANKLES" class="routine-selector bg-gradient-to-br from-amber-900/40 to-amber-800/20 hover:from-amber-800/60 hover:to-amber-700/40 text-amber-400 font-semibold py-4 px-4 border-2 border-amber-500/50 rounded-xl shadow-lg transition-all hover:scale-105 hover:shadow-amber-500/30">
                        <div class="text-2xl mb-1">ü¶µ</div>
                        <span class="text-sm">Piernas</span>
                    </button>
                    <button data-routine="CORE_CARDIO" class="routine-selector bg-gradient-to-br from-pink-900/40 to-pink-800/20 hover:from-pink-800/60 hover:to-pink-700/40 text-pink-400 font-semibold py-4 px-4 border-2 border-pink-500/50 rounded-xl shadow-lg transition-all hover:scale-105 hover:shadow-pink-500/30">
                        <div class="text-2xl mb-1">üî•</div>
                        <span class="text-sm">Core & Cardio</span>
                    </button>
                    <button data-routine="TORSO_PULL" class="routine-selector bg-gradient-to-br from-sky-900/40 to-sky-800/20 hover:from-sky-800/60 hover:to-sky-700/40 text-sky-400 font-semibold py-4 px-4 border-2 border-sky-500/50 rounded-xl shadow-lg transition-all hover:scale-105 hover:shadow-sky-500/30">
                        <div class="text-2xl mb-1">üèãÔ∏è</div>
                        <span class="text-sm">Pull</span>
                    </button>
                    <button data-routine="GLUTES_CORE" class="routine-selector bg-gradient-to-br from-amber-900/40 to-amber-800/20 hover:from-amber-800/60 hover:to-amber-700/40 text-amber-400 font-semibold py-4 px-4 border-2 border-amber-500/50 rounded-xl shadow-lg transition-all hover:scale-105 hover:shadow-amber-500/30">
                        <div class="text-2xl mb-1">üçë</div>
                        <span class="text-sm">Gl√∫teos</span>
                    </button>
                    <button data-routine="METABOLIC" class="routine-selector bg-gradient-to-br from-pink-900/40 to-pink-800/20 hover:from-pink-800/60 hover:to-pink-700/40 text-pink-400 font-semibold py-4 px-4 border-2 border-pink-500/50 rounded-xl shadow-lg transition-all hover:scale-105 hover:shadow-pink-500/30">
                        <div class="text-2xl mb-1">‚ö°</div>
                        <span class="text-sm">Metab√≥lico</span>
                    </button>
                </div>
                <div id="routine-details-container"></div>
            </section>
            
            <section id="biblioteca" class="content-section">
                <div class="mb-8 text-center">
                    <h2 class="text-2xl md:text-3xl font-bold text-accent mb-2" style="text-shadow: 0 0 15px rgba(0, 212, 255, 0.6);">üìö Biblioteca de Ejercicios</h2>
                    <p class="text-sm text-secondary/70">Gu√≠a completa con t√©cnica y forma correcta</p>
                </div>
                <div id="exercise-library"></div>
            </section>
        </main>
    </div>

    <div id="exercise-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-black/70 p-6 rounded-xl shadow-2xl border border-accent/50 w-full max-w-lg relative">
            <button id="modal-close" class="absolute top-3 right-3 text-2xl text-secondary hover:text-accent transition">‚ùå</button>
            <h2 id="guide-title" class="text-3xl font-bold text-accent mb-4 border-b border-accent/30 pb-2">Detalles del Ejercicio</h2>
            <div id="guide-content" class="space-y-4 text-white">
                <p>Cargando detalles...</p>
            </div>
        </div>
    </div>

    <script>
        // --- App Configuration ---
        const routines = {
            TORSO_PUSH: {
                title: 'üí™ C√ìDIGO: PUSH-ARMAMENTO SUPERIOR',
                description: 'En casa (35‚Äì50 min). Enfoque: pecho/hombro/tr√≠ceps con t√©cnica limpia. Deja 1‚Äì2 repeticiones en reserva (RIR 1‚Äì2) en los ejercicios principales.',
                details: {
                    exercises: [
                        { name: 'Push-ups', series: 4, reps: '8‚Äì15 (RIR 1‚Äì2)', rest: '75s', notes: 'Cuerpo en bloque; codos ~45¬∞; controla 2s la bajada.' },
                        { name: 'Pilates Bar Shoulder Press', series: 3, reps: '10‚Äì14', rest: '75s', notes: 'Costillas ‚Äúabajo‚Äù; gl√∫teos firmes; no arquees la espalda.' },
                        { name: 'Band Flys', series: 3, reps: '12‚Äì20', rest: '60s', notes: 'Abrazo controlado; pausa 1s apretando el pecho.' },
                        { name: 'Band Lateral Raises', series: 3, reps: '12‚Äì18', rest: '60s', notes: 'Codo lidera; hombros lejos de orejas; rango sin dolor.' },
                        { name: 'Band Triceps Pushdowns', series: 3, reps: '12‚Äì20', rest: '45‚Äì60s', notes: 'Codos pegados; extiende completo sin balanceo.' },
                        { name: 'Wrist Extension (Palms down)', series: 2, reps: '15‚Äì25', rest: '30‚Äì45s', notes: 'Solo mu√±eca; tempo lento para antebrazo saludable.' }
                    ]
                }
            },
            LEGS_ANKLES: {
                title: 'ü¶µ C√ìDIGO: LEGS-UNIDAD DE MOVILIDAD',
                description: 'En casa (40‚Äì55 min). Enfoque: fuerza de piernas + estabilidad de tobillo/rodilla. Prioriza rango c√≥modo y control; si hay dolor articular, reduce profundidad.',
                details: {
                    exercises: [
                        { name: 'Pilates Bar Squat', series: 4, reps: '8‚Äì12', rest: '90s', notes: 'Tal√≥n completo; rodillas siguen la punta del pie; sube ‚Äúempujando el piso‚Äù.' },
                        { name: 'Band Romanian Deadlift', series: 3, reps: '10‚Äì14', rest: '90s', notes: 'Bisagra de cadera; espalda neutra; siente estiramiento en isquios.' },
                        { name: 'Pilates Ball Hamstring Curl', series: 3, reps: '8‚Äì15', rest: '75‚Äì90s', notes: 'Puente + curl: cadera alta, tira con isquios. Si tiembla mucho, reduce rango.' },
                        { name: 'Static Lunge (Ankle Focus)', series: 3, reps: '8‚Äì12/lado', rest: '75s', notes: 'Controla la rodilla; torso alto; pie tr√≠pode (dedo gordo‚Äìdedo chico‚Äìtal√≥n).' },
                        { name: 'Banded Glute Bridge', series: 3, reps: '12‚Äì20', rest: '60s', notes: 'Pausa 2s arriba; costillas abajo; empuja rodillas hacia afuera.' },
                        { name: 'Calf Raises (Ankle Focus)', series: 4, reps: '12‚Äì20', rest: '45‚Äì60s', notes: 'Rango completo; 1s arriba/2s abajo; sin rebote.' }
                    ]
                }
            },
            CORE_CARDIO: {
                title: 'üßò‚Äç‚ôÄÔ∏è C√ìDIGO: PILATES-CORE + CARDIO',
                description: 'En casa (25‚Äì40 min). Enfoque: pilates/core (control + respiraci√≥n) + cardio sostenible. Objetivo: terminar con energ√≠a (RPE 6‚Äì7), no reventado. Si tu t√©cnica se rompe, baja el ritmo.',
                details: {
                    exercises: [
                        { name: 'Dead Bug (Pilates Ball Press)', series: 3, reps: '8‚Äì12/lado', rest: '30‚Äì45s', notes: 'Aprieta la pelota (presi√≥n constante). Exhala largo; costillas abajo.' },
                        { name: 'Side Plank', series: 3, reps: '25‚Äì45s/lado', rest: '30‚Äì45s', notes: 'Cadera alta; hombro lejos de oreja; respiraci√≥n controlada.' },
                        { name: 'Pilates Ball Rollout', series: 3, reps: '8‚Äì12', rest: '45‚Äì60s', notes: 'Rueda la pelota sin perder costillas abajo. Rango corto si arqueas.' },
                        { name: 'Plank Hold', series: 2, reps: '35‚Äì60s', rest: '45s', notes: 'Gl√∫teos firmes; ‚Äúempuja‚Äù el suelo; sin aguantar la respiraci√≥n.' },
                        { name: 'Jumping Jacks', series: 4, reps: '40‚Äì60s', rest: '30‚Äì45s', notes: 'Versi√≥n low-impact si lo necesitas. Ritmo sostenible.' },
                        { name: 'Mountain Climbers', series: 3, reps: '25‚Äì40s', rest: '45s', notes: 'Cadera estable; pasos silenciosos. Si te acelera mucho, baja ritmo.' }
                    ]
                }
            },
            TORSO_PULL: {
                title: 'üèãÔ∏è‚Äç‚ôÇÔ∏è C√ìDIGO: PULL-CADENA POSTERIOR',
                description: 'En casa (35‚Äì50 min). Enfoque: espalda/postura + b√≠ceps + progreso de dominadas (pull-ups). Prioriza esc√°pulas activas y rango controlado; mejor pocas reps perfectas que muchas con trampa.',
                details: {
                    exercises: [
                        { name: 'Scapular Pull-ups', series: 3, reps: '6‚Äì10', rest: '60‚Äì75s', notes: 'Sin doblar codos: baja/eleva esc√°pulas. Activa la espalda antes de tirar.' },
                        { name: 'Negative Pull-ups', series: 4, reps: '3‚Äì6', rest: '90‚Äì120s', notes: 'Sube con apoyo y baja 3‚Äì5s. Si no tienes barra, reemplaza por Lat Pulldown.' },
                        { name: 'Pilates Bar Lat Pulldown', series: 3, reps: '10‚Äì14', rest: '75‚Äì90s', notes: 'Codos hacia abajo/atr√°s; pausa 1s abajo; sin balanceo.' },
                        { name: 'Dumbbell Bent-Over Row', series: 3, reps: '8‚Äì12', rest: '75‚Äì90s', notes: 'Bisagra estable; tira hacia costillas; 2s bajada.' },
                        { name: 'Band Face Pulls', series: 2, reps: '12‚Äì20', rest: '60s', notes: 'Codos altos; termina con manos cerca de sienes; control total.' },
                        { name: 'Pilates Bar Bicep Curl', series: 3, reps: '10‚Äì15', rest: '60s', notes: 'Codos fijos; sube sin impulso; aprieta 1s arriba.' }
                    ]
                }
            },
            GLUTES_CORE: {
                title: 'üçë C√ìDIGO: GLUTES-N√öCLEO ESTABILIZADOR',
                description: 'En casa (30‚Äì45 min). Enfoque: gl√∫teo medio/mayor + estabilidad lumbar. Siente el trabajo en gl√∫teos, no en espalda baja.',
                details: {
                    exercises: [
                        { name: 'Pull Through', series: 4, reps: '12‚Äì18', rest: '75s', notes: 'Bisagra; ‚Äúempuja‚Äù cadera atr√°s y luego aprieta gl√∫teos arriba.' },
                        { name: 'Banded Lateral Walk', series: 3, reps: '10‚Äì14 pasos/lado', rest: '45‚Äì60s', notes: 'Rodillas afuera; pasos cortos; tensi√≥n constante.' },
                        { name: 'Pilates Ball Glute Bridge', series: 3, reps: '10‚Äì18', rest: '60‚Äì75s', notes: 'Talones en pelota, cadera alta. Si se complica: glute bridge sin pelota.' },
                        { name: 'Pilates Bar Russian Twists', series: 3, reps: '16‚Äì24 giros', rest: '45‚Äì60s', notes: 'Gira costillas, no solo brazos; exhala al rotar.' },
                        { name: 'Plank', series: 3, reps: '35‚Äì60s', rest: '60s', notes: 'P√©lvis neutra; gl√∫teos firmes; respiraci√≥n nasal si puedes.' },
                        { name: 'Bird-Dog', series: 3, reps: '10‚Äì14/lado', rest: '30‚Äì45s', notes: 'Pausa 1s extendido; cadera cuadrada; lento y estable.' }
                    ]
                }
            },
            METABOLIC: {
                title: '‚ö° C√ìDIGO: SHOCK-CIRCUITO MAX. VEL.',
                description: 'En casa (20‚Äì35 min). Circuito para sudar sin destruir t√©cnica. Mant√©n el ritmo ‚Äúsostenible‚Äù: debes poder hablar frases cortas. Descanso corto entre estaciones.',
                details: {
                    exercises: [
                        { name: 'Pilates Bar Thrusters', series: '3 Rounds', reps: '10‚Äì15', rest: '20‚Äì30s', notes: 'Sentadilla + press; no arquees; exhala arriba.' },
                        { name: 'Fast Band Rows', series: '3 Rounds', reps: '15‚Äì25', rest: '20‚Äì30s', notes: 'R√°pido pero controlado; hombros lejos de orejas.' },
                        { name: 'Lunge with Twist', series: '3 Rounds', reps: '8‚Äì12/lado', rest: '20‚Äì30s', notes: 'Estabilidad primero; rota desde el core.' },
                        { name: 'Push-ups', series: '3 Rounds', reps: '6‚Äì12', rest: '20‚Äì30s', notes: 'Escala a rodillas o manos elevadas si hace falta.' },
                        { name: 'Jumping Jacks', series: '3 Rounds', reps: '30‚Äì45s', rest: '90s', notes: 'Descanso largo al final de cada ronda.' }
                    ]
                }
            },
            REST: {
                title: 'ESTADO: REGENERACI√ìN DE SISTEMAS',
                description: 'D√≠a de descanso activo opcional: 20‚Äì40 min caminata suave + 8‚Äì12 min movilidad (cadera/tobillo/columna) + 5 min respiraci√≥n. Prioriza sue√±o e hidrataci√≥n.'
            }
        };

        const exerciseLibrary = {
            'Dumbbell Bench Press': { category: 'Chest', equipment: 'üèãÔ∏è Mancuernas', difficulty: 'Intermedio', form: { es: ['1. Acu√©state en un banco', '2. Sost√©n las mancernas a nivel del pecho', '3. Empuja las mancernas hacia arriba hasta extender los brazos'] }, tips: { es: ['‚úì Controla el peso en la bajada', '‚úó Evita: Codos muy abiertos'] }, muscleGroups: ['Pectoral', 'Tr√≠ceps'] },
            'Push-ups': { category: 'Pecho/Tr√≠ceps', equipment: 'üõèÔ∏è Tapete', difficulty: 'Principiante‚ÄìIntermedio', form: { es: ['1. Manos bajo hombros (o un poco m√°s abiertas), dedos bien apoyados', '2. Cuerpo en l√≠nea recta: gl√∫teos firmes y abdomen activo', '3. Baja en 2‚Äì3s hasta que el pecho quede a pocos cm del suelo', '4. Codos a ~30‚Äì60¬∞ del torso (no totalmente abiertos)', '5. Empuja el suelo, sube manteniendo la l√≠nea y exhala'] }, tips: { es: ['‚úì Escala: rodillas al suelo o manos elevadas (mesa/sill√≥n)', '‚úì Progresi√≥n: pies elevados o pausa 1s abajo', '‚úì Mant√©n cuello largo (mirada al piso)', '‚úó Evita: caderas ca√≠das o ‚Äúpico‚Äù con cadera alta', '‚úó Evita: hombros encogidos hacia orejas'] }, muscleGroups: ['Pectoral', 'Tr√≠ceps', 'Core'] },
            'Pilates Bar Shoulder Press': { category: 'Shoulders', equipment: 'üéØ Barra Pilates', difficulty: 'Principiante', form: { es: ['1. Pisa la banda con ambos pies (estable) y toma la barra a altura de hombros', '2. Aprieta gl√∫teos y abdomen (costillas abajo) para evitar arquear la espalda', '3. Empuja la barra hacia arriba en l√≠nea ligeramente al frente de la cabeza', '4. Pausa 1s arriba sin encoger hombros', '5. Baja controlado hasta volver a hombros (2s)'] }, tips: { es: ['‚úì Exhala al empujar, inhala al bajar', '‚úì Mant√©n mu√±ecas neutras (no dobladas)', '‚úì Si molesta el hombro: reduce rango o usa agarre m√°s estrecho', '‚úó Evita: arquear la espalda baja para ‚Äúganar‚Äù repeticiones', '‚úó Evita: hombros hacia orejas en la parte alta'] }, muscleGroups: ['Hombros', 'Tr√≠ceps (sec.)', 'Core (est.)'] },
            'Band Flys': { category: 'Chest', equipment: 'üü∞ Bandas', difficulty: 'Principiante', form: { es: ['1. Ancla la banda detr√°s (altura pecho) y toma las asas con brazos semi-flexionados', '2. Da un paso adelante para crear tensi√≥n inicial', '3. Junta las manos al frente (como ‚Äúabrazar un √°rbol‚Äù) sin bloquear codos', '4. Pausa 1s apretando el pecho', '5. Regresa lento abriendo brazos hasta sentir estiramiento controlado'] }, tips: { es: ['‚úì Mant√©n hombros abajo/atr√°s', '‚úì Movimiento desde el pecho, no desde el trapecio', '‚úì Ajusta tensi√≥n alej√°ndote o acerc√°ndote al anclaje', '‚úó Evita: hiperextender hombro al abrir demasiado', '‚úó Evita: codos completamente rectos'] }, muscleGroups: ['Pectoral', 'Deltoide anterior (sec.)'] },
            'Band Lateral Raises': { category: 'Shoulders', equipment: 'üü∞ Bandas', difficulty: 'Principiante', form: { es: ['1. P√°rate sobre la banda (un pie o ambos) y toma extremos con manos a los lados', '2. Ligera flexi√≥n de codos y torso estable', '3. Eleva brazos hacia los lados hasta altura de hombros (o un poco menos si molesta)', '4. Pausa 1s arriba sin encoger hombros', '5. Baja en 2‚Äì3s manteniendo tensi√≥n'] }, tips: { es: ['‚úì Codo ‚Äúlidera‚Äù el movimiento; mu√±eca relajada', '‚úì Hombros lejos de orejas', '‚úì Trabaja en rango sin dolor', '‚úó Evita: balancearte o usar impulso', '‚úó Evita: subir por encima de lo controlable si duele'] }, muscleGroups: ['Hombros (Lateral)'] },
            'Band Triceps Pushdowns': { category: 'Triceps', equipment: 'üü∞ Bandas', difficulty: 'Principiante', form: { es: ['1. Ancla la banda arriba, codos pegados al cuerpo a ~90¬∞', '2. Pecho alto, abdomen firme', '3. Extiende codos hacia abajo hasta bloquear suave (sin dolor)', '4. Pausa 1s apretando tr√≠ceps', '5. Regresa controlado manteniendo codos fijos'] }, tips: { es: ['‚úì Mant√©n hombros estables y codos quietos', '‚úì Si se abre el codo: baja la tensi√≥n', '‚úó Evita: inclinarte demasiado y convertirlo en ‚Äújal√≥n‚Äù de espalda', '‚úó Evita: mover hombros adelante/atr√°s'] }, muscleGroups: ['Tr√≠ceps'] },
            'Wrist Extension (Palms down)': { category: 'Forearms', equipment: 'üéØ Barra Pilates', difficulty: 'Principiante', form: { es: ['1. Apoya antebrazo en muslo o banco, palma hacia abajo, mu√±eca fuera del borde', '2. Deja que la mu√±eca baje controlado (extensi√≥n al final del rango)', '3. Sube la mano extendiendo mu√±eca sin despegar el antebrazo', '4. Pausa 1s arriba', '5. Baja lento (2‚Äì3s)'] }, tips: { es: ['‚úì Rango peque√±o pero controlado', '‚úì Mant√©n el codo quieto', '‚úó Evita: dolor punzante (reduce rango/tensi√≥n)', '‚úó Evita: mover todo el brazo'] }, muscleGroups: ['Antebrazos (Extensores)'] },
            'Pilates Bar Squat': { category: 'Legs', equipment: 'üéØ Barra Pilates', difficulty: 'Intermedio', form: { es: ['1. Barra sobre espalda alta (no cuello) y banda bajo los pies', '2. Inhala y baja: cadera atr√°s y abajo, rodillas siguen la punta del pie', '3. Mant√©n talones apoyados y torso estable', '4. Llega a profundidad que controles sin perder postura', '5. Exhala y sube empujando el piso; aprieta gl√∫teos al final'] }, tips: { es: ['‚úì Mant√©n ‚Äúpie tr√≠pode‚Äù (tal√≥n + base dedo gordo + base dedo chico)', '‚úì Rodillas hacia afuera, sin colapsar', '‚úì Si hay dolor: reduce profundidad o usa apoyo (silla) como referencia', '‚úó Evita: levantar talones o colapsar rodillas', '‚úó Evita: redondear espalda en el fondo'] }, muscleGroups: ['Cu√°driceps', 'Gl√∫teos', 'Aductores (sec.)'] },
            'Band Romanian Deadlift': { category: 'Isquios/Gl√∫teos', equipment: 'üü∞ Bandas', difficulty: 'Intermedio', form: { es: ['1. Pisa la banda con ambos pies, toma extremos o usa barra Pilates', '2. Rodillas con leve flexi√≥n, pecho abierto y espalda neutra', '3. Empuja cadera atr√°s (bisagra) manteniendo la banda cerca del cuerpo', '4. Baja hasta sentir estiramiento en isquiotibiales (sin redondear)', '5. Sube ‚Äúempujando el suelo‚Äù y apretando gl√∫teos al final'] }, tips: { es: ['‚úì Piensa: cadera atr√°s, no ‚Äúbajar con la espalda‚Äù', '‚úì Mant√©n peso en mediopi√©-tal√≥n', '‚úì Tempo: 2‚Äì3s bajada, 1s subida', '‚úó Evita: redondear espalda baja o mirar al frente exagerado', '‚úó Evita: bajar m√°s all√° del rango que puedas controlar'] }, muscleGroups: ['Isquiotibiales', 'Gl√∫teos', 'Erectores (estabilizaci√≥n)'] },
            'Static Lunge (Ankle Focus)': { category: 'Legs', equipment: 'üõèÔ∏è Tapete', difficulty: 'Intermedio', form: { es: ['1. Posici√≥n de estocada: pie adelante firme, pie atr√°s en punta', '2. Baja vertical: ambas rodillas flexionan, torso erguido', '3. Mant√©n rodilla frontal alineada con 2¬∫‚Äì3¬∫ dedo del pie', '4. Pausa 1s abajo sin ‚Äúrebotar‚Äù', '5. Sube empujando el suelo con el pie delantero'] }, tips: { es: ['‚úì Pie delantero tr√≠pode: no colapses el arco', '‚úì Usa apoyo (pared/silla) si pierdes equilibrio', '‚úó Evita: rodilla frontal colapsando hacia adentro', '‚úó Evita: inclinarte demasiado hacia adelante'] }, muscleGroups: ['Cu√°driceps', 'Gl√∫teos', 'Estabilizadores'] },
            'Banded Glute Bridge': { category: 'Glutes', equipment: 'üü∞ Bandas', difficulty: 'Principiante', form: { es: ['1. Acu√©state boca arriba, pies al ancho de cadera, banda sobre rodillas', '2. Aprieta abdomen (zona lumbar neutra) y abre rodillas contra la banda', '3. Eleva caderas hasta alinear rodillas‚Äìcadera‚Äìhombros', '4. Pausa 2s apretando gl√∫teos', '5. Baja lento sin perder tensi√≥n'] }, tips: { es: ['‚úì Empuja desde talones', '‚úì Mant√©n costillas abajo (sin arquear)', '‚úó Evita: empujar con espalda baja', '‚úó Evita: rodillas colapsando hacia adentro'] }, muscleGroups: ['Gl√∫teos', 'Isquiotibiales', 'Gl√∫teo medio (est.)'] },
            'Calf Raises (Ankle Focus)': { category: 'Calves', equipment: 'üéØ Barra Pilates', difficulty: 'Principiante', form: { es: ['1. De pie, ap√≥yate suave en pared si hace falta', '2. Eleva talones lo m√°s alto posible manteniendo control', '3. Pausa 1s arriba', '4. Baja lento 2‚Äì3s hasta estirar gemelo', '5. Repite sin rebote'] }, tips: { es: ['‚úì Piensa en ‚Äúsubir alto y bajar lento‚Äù', '‚úì Haz una pierna si te queda f√°cil', '‚úó Evita: rebotar o acortar el rango', '‚úó Evita: rodillas bloqueadas con tensi√≥n'] }, muscleGroups: ['Pantorrillas', 'S√≥leo', 'Tobillo'] },
            'Pilates Bar Lat Pulldown': { category: 'Back', equipment: 'üéØ Barra Pilates', difficulty: 'Principiante', form: { es: ['1. Fija banda alta, agarre ancho', '2. Jala la barra hacia abajo hasta nivel del pecho', '3. Regresa con control'] }, tips: { es: ['‚úì Contrae la espalda en la parte inferior', '‚úó Evita: Usar los brazos en lugar de la espalda'] }, muscleGroups: ['Dorsales', 'Espalda'] },
            'Dumbbell Bent-Over Row': { category: 'Back', equipment: 'üèãÔ∏è Mancuernas', difficulty: 'Intermedio', form: { es: ['1. Bisagra desde cadera, espalda paralela al suelo', '2. Jala las mancernas hacia la caja tor√°cica', '3. Baja con control'] }, tips: { es: ['‚úì Mant√©n core contra√≠do', '‚úó Evita: Redondear la espalda baja'] }, muscleGroups: ['Espalda', 'Dorsales'] },
            'Band Face Pulls': { category: 'Shoulders', equipment: 'üü∞ Bandas', difficulty: 'Principiante', form: { es: ['1. Fija banda a altura de la cara', '2. Jala la banda hacia la cara/cabeza', '3. Rota las manos hacia afuera al final'] }, tips: { es: ['‚úì Codos altos', '‚úó Evita: Jalar hacia abajo'] }, muscleGroups: ['Hombros (Posterior)', 'Espalda Superior'] },
            'Band Pull-Aparts': { category: 'Espalda superior/Postura', equipment: 'üü∞ Bandas', difficulty: 'Principiante', form: { es: ['1. Banda al frente a la altura del pecho, brazos extendidos', '2. Hombros abajo/atr√°s, pecho abierto', '3. Separa manos hasta que la banda toque el pecho (o lo m√°ximo controlado)', '4. Pausa 1s apretando esc√°pulas', '5. Regresa lento sin perder tensi√≥n'] }, tips: { es: ['‚úì Mant√©n costillas abajo (sin arquear)', '‚úì Piensa en ‚Äúmeter esc√°pulas en el bolsillo trasero‚Äù', '‚úó Evita: encoger hombros o doblar demasiado codos', '‚úó Evita: ir r√°pido y perder control'] }, muscleGroups: ['Romboides', 'Trapecio medio', 'Deltoide posterior'] },
            'Pilates Bar Bicep Curl': { category: 'Biceps', equipment: 'üéØ Barra Pilates', difficulty: 'Principiante', form: { es: ['1. Pisa la banda, brazos extendidos', '2. Dobla los codos, curva la barra hacia los hombros', '3. Baja con control'] }, tips: { es: ['‚úì Contrae los b√≠ceps en la parte superior', '‚úó Evita: Balancearte o usar impulso'] }, muscleGroups: ['B√≠ceps'] },
            'Wrist Flexion (Palms up)': { category: 'Forearms', equipment: 'üéØ Barra Pilates', difficulty: 'Principiante', form: { es: ['1. Antebrazo apoyado, palma hacia arriba', '2. Curva la mu√±eca hacia arriba', '3. Baja con control'] }, tips: { es: ['‚úì Mu√©vete solo desde la mu√±eca', '‚úó Evita: Mover antebrazo o codo'] }, muscleGroups: ['Antebrazos (Flexores)'] },
            'Pull Through': { category: 'Glutes', equipment: 'üü∞ Bandas', difficulty: 'Intermedio', form: { es: ['1. Fija la banda baja, de espaldas al anclaje', '2. Bisagra de cadera, empuja banda entre piernas', '3. Empuja las caderas hacia adelante (extensi√≥n completa)'] }, tips: { es: ['‚úì La fuerza viene de las caderas, no de los brazos', '‚úó Evita: Redondear la espalda baja'] }, muscleGroups: ['Gl√∫teos', 'Isquiotibiales'] },
            'Banded Lateral Walk': { category: 'Glutes', equipment: 'üü∞ Bandas', difficulty: 'Principiante', form: { es: ['1. Banda en rodillas/tobillos, semi-sentadilla', '2. Pasos laterales manteniendo tensi√≥n', '3. Alterna direcciones'] }, tips: { es: ['‚úì Mant√©n las rodillas dobladas', '‚úó Evita: Banda afloj√°ndose'] }, muscleGroups: ['Gl√∫teos (Medio)'] },
            'Pilates Bar Russian Twists': { category: 'Core', equipment: 'üéØ Barra Pilates', difficulty: 'Intermedio', form: { es: ['1. Sentado, torso inclinado (45¬∞)', '2. Sost√©n la barra, rota torso a izquierda/derecha', '3. Toca el suelo con la barra (opcional)'] }, tips: { es: ['‚úì La rotaci√≥n viene del core', '‚úó Evita: Moverte demasiado r√°pido'] }, muscleGroups: ['Oblicuos', 'Core'] },
            'Plank': { category: 'Core', equipment: 'üõèÔ∏è Tapete', difficulty: 'Principiante', form: { es: ['1. Plancha de antebrazos, codos bajo hombros', '2. Cuerpo en l√≠nea recta desde cabeza hasta talones', '3. Mant√©n la posici√≥n'] }, tips: { es: ['‚úì Core y gl√∫teos apretados', '‚úó Evita: Dejar caer las caderas'] }, muscleGroups: ['Core', 'Hombros'] },
            'Bird-Dog': { category: 'Core', equipment: 'üõèÔ∏è Tapete', difficulty: 'Principiante', form: { es: ['1. En cuatro patas', '2. Extiende brazo y pierna opuestos', '3. Regresa lentamente al inicio'] }, tips: { es: ['‚úì Mant√©n el cuerpo alineado', '‚úó Evita: Rotar caderas u hombros'] }, muscleGroups: ['Core', 'Gl√∫teos'] },
            'Pilates Bar Thrusters': { category: 'Full Body', equipment: 'üéØ Barra Pilates', difficulty: 'Avanzado', form: { es: ['1. Sentadilla completa', '2. Explota hacia arriba', '3. Empuja la barra sobre la cabeza en un solo movimiento'] }, tips: { es: ['‚úì Movimiento fluido y explosivo', '‚úó Evita: Profundidad incompleta de sentadilla'] }, muscleGroups: ['Cu√°driceps', 'Hombros', 'Full Body'] },
            'Fast Band Rows': { category: 'Back', equipment: 'üü∞ Bandas', difficulty: 'Intermedio', form: { es: ['1. Fija banda a altura del pecho', '2. Jala r√°pidamente la banda hacia el pecho', '3. Regreso r√°pido y controlado'] }, tips: { es: ['‚úì Ritmo r√°pido pero controlado', '‚úó Evita: Impulso excesivo'] }, muscleGroups: ['Espalda', 'Dorsales'] },
            'Lunge with Twist': { category: 'Full Body', equipment: 'üéØ Barra Pilates', difficulty: 'Intermedio', form: { es: ['1. Estocada, ambas rodillas a 90¬∞', '2. Sost√©n la barra, gira el torso sobre la pierna frontal', '3. Regresa y cambia de lado'] }, tips: { es: ['‚úì Gira desde el core, no desde los brazos', '‚úó Evita: Girar antes de estar estable'] }, muscleGroups: ['Cu√°driceps', 'Core', 'Gl√∫teos'] },
            'Jumping Jacks': { category: 'Cardio', equipment: 'üõèÔ∏è Espacio', difficulty: 'Principiante', form: { es: ['1. Salta abriendo piernas y brazos simult√°neamente', '2. Salta cerrando', '3. Repite en movimiento continuo'] }, tips: { es: ['‚úì Aterriza suavemente', '‚úó Evita: Golpear los pies al aterrizar'] }, muscleGroups: ['Full Body', 'Cardio'] },
            'Plank Hold': { category: 'Core', equipment: 'üõèÔ∏è Tapete', difficulty: 'Principiante', form: { es: ['1. Plancha de antebrazos', '2. Mant√©n el cuerpo en l√≠nea recta', '3. Contrae core y gl√∫teos'] }, tips: { es: ['‚úì Aprieta gl√∫teos para proteger la espalda baja', '‚úó Evita: Aguantar la respiraci√≥n'] }, muscleGroups: ['Core', 'Hombros'] },
            'Bicycle Crunches': { category: 'Core', equipment: 'üõèÔ∏è Tapete', difficulty: 'Intermedio', form: { es: ['1. Acu√©state, manos detr√°s de la cabeza', '2. Lleva codo a rodilla opuesta, extiende la otra pierna', '3. Contin√∫a alternando'] }, tips: { es: ['‚úì Toca codo con rodilla opuesta', '‚úó Evita: Jalar el cuello'] }, muscleGroups: ['Abs', 'Oblicuos'] },
            'Burpees': { category: 'Full Body', equipment: 'üõèÔ∏è Espacio', difficulty: 'Intermedio', form: { es: ['1. Baja a sentadilla', '2. Salta pies atr√°s a plancha', '3. Salta pies adelante a sentadilla', '4. Explota hacia arriba en salto'] }, tips: { es: ['‚úì Movimiento explosivo completo', '‚úó Evita: Forma descuidada cuando est√°s cansado'] }, muscleGroups: ['Full Body', 'Cardio', 'Core'] },
            'Mountain Climbers': { category: 'Cardio', equipment: 'üõèÔ∏è Tapete', difficulty: 'Intermedio', form: { es: ['1. Plancha alta', '2. Lleva rodilla al pecho, cambia r√°pidamente de pierna', '3. Contin√∫a alternando a ritmo r√°pido'] }, tips: { es: ['‚úì Ritmo r√°pido pero controlado', '‚úó Evita: Dejar rebotar las caderas'] }, muscleGroups: ['Core', 'Cardio'] },
            'Russian Twists': { category: 'Core', equipment: 'üéØ Barra Pilates', difficulty: 'Intermedio', form: { es: ['1. Sentado, torso inclinado (45¬∞)', '2. Gira el torso de lado a lado'] }, tips: { es: ['‚úì La rotaci√≥n viene del core', '‚úó Evita: Rotar demasiado lejos'] }, muscleGroups: ['Oblicuos', 'Core'] },
            'Leg Raises': { category: 'Core', equipment: 'üõèÔ∏è Tapete', difficulty: 'Intermedio', form: { es: ['1. Acu√©state, manos bajo gl√∫teos', '2. Eleva piernas hasta 90 grados', '3. Baja lentamente sin tocar el piso'] }, tips: { es: ['‚úì Presiona la espalda baja contra el piso', '‚úó Evita: Arquear la espalda baja'] }, muscleGroups: ['Abs (Bajo)', 'Flexores'] },
            'Jump Squats': { category: 'Legs', equipment: 'üõèÔ∏è Espacio', difficulty: 'Intermedio', form: { es: ['1. Baja a sentadilla completa', '2. Explota hacia arriba en salto', '3. Aterriza suave y vuelve a cargar la sentadilla'] }, tips: { es: ['‚úì Aterriza silencioso con rodillas ‚Äúsuaves‚Äù', '‚úó Evita: colapsar rodillas hacia adentro'] }, muscleGroups: ['Cu√°driceps', 'Gl√∫teos', 'Cardio'] },

            'Dead Bug': { category: 'Core / Pilates', equipment: 'üõèÔ∏è Tapete', difficulty: 'Principiante', form: { es: ['1. Boca arriba: caderas y rodillas a 90¬∞, brazos al techo', '2. Exhala largo y ‚Äúbaja costillas‚Äù (core activo)', '3. Extiende pierna y brazo contrarios sin despegar zona lumbar', '4. Pausa 1s extendido', '5. Regresa controlado y alterna'] }, tips: { es: ['‚úì Calidad > cantidad: rango peque√±o si lo necesitas', '‚úì Mant√©n cuello relajado', '‚úó Evita: arquear la espalda baja', '‚úó Evita: apurar y perder control'] }, muscleGroups: ['Transverso', 'Recto abdominal', 'Control lumbo-p√©lvico'] },

            'Side Plank': { category: 'Core / Pilates', equipment: 'üõèÔ∏è Tapete', difficulty: 'Intermedio', form: { es: ['1. Apoya antebrazo bajo el hombro, piernas extendidas (o rodillas como escala)', '2. Eleva la cadera formando una l√≠nea recta hombro‚Äìcadera‚Äìtobillo', '3. Mant√©n hombro lejos de la oreja y cuello largo', '4. Respira controlado durante toda la serie', '5. Baja con control y cambia de lado'] }, tips: { es: ['‚úì Escala: rodillas apoyadas o apoyo de mano', '‚úì Mant√©n gl√∫teos firmes', '‚úó Evita: hundir el hombro', '‚úó Evita: cadera ca√≠da o rotar el torso'] }, muscleGroups: ['Oblicuos', 'Gl√∫teo medio', 'Estabilizadores del hombro'] },

            'Scapular Pull-ups': { category: 'Pull-ups / Espalda', equipment: 'üß± Barra de dominadas', difficulty: 'Principiante', form: { es: ['1. Cuelga de la barra con agarre c√≥modo (sin dolor)', '2. Sin doblar codos: baja hombros (depresi√≥n) y junta levemente esc√°pulas', '3. Sube el pecho 2‚Äì4 cm (micro-movimiento) manteniendo brazos rectos', '4. Pausa 1s arriba', '5. Vuelve lento a colgar relajando sin perder control'] }, tips: { es: ['‚úì Este ejercicio ‚Äúenciende‚Äù la espalda para dominar la dominada', '‚úì Mant√©n abdomen firme para evitar balanceo', '‚úó Evita: doblar codos (ya no es escapular)', '‚úó Evita: encoger hombros hacia orejas'] }, muscleGroups: ['Dorsal (activaci√≥n)', 'Trapecio inferior', 'Romboides'] },

            'Negative Pull-ups': { category: 'Pull-ups / Espalda', equipment: 'üß± Barra de dominadas', difficulty: 'Intermedio', form: { es: ['1. Sube a la posici√≥n alta (barbilla sobre barra) usando un banco o salto suave', '2. Activa esc√°pulas (hombros abajo) antes de bajar', '3. Baja en 3‚Äì5 segundos hasta brazos casi extendidos', '4. Pausa 1s abajo sin colgarte ‚Äúmuerto‚Äù si puedes', '5. Repite manteniendo control (pocas reps, m√°xima calidad)'] }, tips: { es: ['‚úì Meta: controlar la bajada; si caes en 1s, usa m√°s apoyo', '‚úì Mant√©n piernas quietas (sin kipping)', '‚úó Evita: dolor en codo/hombro (reduce volumen o rango)', '‚úó Evita: bajar muy r√°pido sin control'] }, muscleGroups: ['Dorsales', 'B√≠ceps', 'Agarre'] },

            'Dead Bug (Pilates Ball Press)': { category: 'Core / Pilates', equipment: '‚ö™ Pelota Pilates', difficulty: 'Principiante', form: { es: ['1. Boca arriba: caderas y rodillas a 90¬∞', '2. Coloca la pelota entre mano y rodilla contrarias (o entre ambas manos y rodillas)', '3. Aprieta la pelota con presi√≥n constante (20‚Äì40%) y exhala largo', '4. Extiende la pierna contraria (la que no presiona) sin perder zona lumbar neutra', '5. Regresa controlado y alterna lados'] }, tips: { es: ['‚úì La clave es la exhalaci√≥n y mantener costillas abajo', '‚úì Rango corto si arqueas la espalda', '‚úó Evita: apretar al 100% y tensionar cuello', '‚úó Evita: perder presi√≥n en la pelota (core se ‚Äúapaga‚Äù)'] }, muscleGroups: ['Transverso', 'Oblicuos', 'Control lumbo-p√©lvico'] },

            'Pilates Ball Rollout': { category: 'Core / Pilates', equipment: '‚ö™ Pelota Pilates', difficulty: 'Intermedio', form: { es: ['1. De rodillas, antebrazos/manos sobre la pelota (seg√∫n comodidad)', '2. Aprieta abdomen y baja costillas (no arquees)', '3. Rueda la pelota hacia adelante 10‚Äì40 cm manteniendo control', '4. Pausa 1s en el punto m√°s lejano que controles', '5. Regresa tirando con el core, sin colapsar hombros'] }, tips: { es: ['‚úì Empieza con recorridos cortos y aumenta gradual', '‚úì Mant√©n gl√∫teos firmes para proteger la zona lumbar', '‚úó Evita: arquear la espalda baja al alejar la pelota', '‚úó Evita: hombros encogidos hacia orejas'] }, muscleGroups: ['Recto abdominal', 'Transverso', 'Serrato/estabilizadores'] },

            'Pilates Ball Glute Bridge': { category: 'Glutes / Core', equipment: '‚ö™ Pelota Pilates', difficulty: 'Intermedio', form: { es: ['1. Boca arriba, talones sobre la pelota (piernas al ancho de cadera)', '2. Activa abdomen (costillas abajo) y eleva la cadera a puente', '3. Mant√©n la pelota estable: presi√≥n pareja con ambos talones', '4. Pausa 1‚Äì2s arriba apretando gl√∫teos', '5. Baja lento sin perder control'] }, tips: { es: ['‚úì Si se hace dif√≠cil: haz puente sin pelota o con pies en el suelo', '‚úì Mant√©n rodillas alineadas (no colapsen)', '‚úó Evita: hiperextender la espalda baja en la parte alta', '‚úó Evita: empujar con isquios sin activar gl√∫teos (piensa ‚Äúaprieta gl√∫teos‚Äù)'] }, muscleGroups: ['Gl√∫teo mayor', 'Isquios (sec.)', 'Core (est.)'] },

            'Pilates Ball Hamstring Curl': { category: 'Isquios / Gl√∫teos', equipment: '‚ö™ Pelota Pilates', difficulty: 'Intermedio', form: { es: ['1. Boca arriba, talones sobre la pelota, brazos al costado', '2. Eleva cadera a puente (cuerpo en l√≠nea hombro‚Äìcadera‚Äìrodilla)', '3. Flexiona rodillas trayendo la pelota hacia ti (sin que caiga la cadera)', '4. Extiende piernas alejando la pelota de nuevo con control', '5. Mant√©n cadera alta todo el set (o baja a versi√≥n m√°s f√°cil)'] }, tips: { es: ['‚úì Prioriza control: mejor 8 buenas que 15 con cadera cayendo', '‚úì Si tiembla mucho: reduce rango o baja la cadera (curl parcial)', '‚úó Evita: cadera que sube/baja como ‚Äúserrucho‚Äù', '‚úó Evita: calambres por ir demasiado r√°pido (hazlo lento)'] }, muscleGroups: ['Isquiotibiales', 'Gl√∫teos (est.)', 'Core (est.)'] }
        };

        function getExerciseSlug(name) {
            return name.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        }
        function getExerciseName(englishName) { return englishName; } 
        function getExerciseDescription(englishName) {
            const allExercises = Object.values(routines).flatMap(r => r.details ? r.details.exercises : []);
            const ex = allExercises.find(e => e.name === englishName);
            return ex ? ex.notes : '';
        }

        // --- Date & Schedule ---
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const day = today.getDate();
        let currentViewDate = new Date();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const STREAK_COMPLETION_THRESHOLD = 0.8; // % m√≠nimo para contar el d√≠a como ‚Äúcompletado‚Äù

        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        function normalizeDateKey(key) {
            const m = /^(\d{4})-(\d{1,2})-(\d{1,2})$/.exec(String(key || '').trim());
            if (!m) return null;
            const y = Number(m[1]);
            const mo = Number(m[2]);
            const da = Number(m[3]);
            if (!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(da)) return null;
            if (mo < 1 || mo > 12 || da < 1 || da > 31) return null;
            return `${y}-${pad2(mo)}-${pad2(da)}`;
        }

        function dateFromKey(key) {
            const norm = normalizeDateKey(key);
            if (!norm) return null;
            const [y, m, d] = norm.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function dateKeyFromDate(d) {
            return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        }

        const LOCAL_STORAGE_KEY = 'ftber_progress';
        const schedulePattern = ['TORSO_PUSH', 'LEGS_ANKLES', 'CORE_CARDIO', 'TORSO_PULL', 'GLUTES_CORE', 'METABOLIC', 'REST'];
        const monthlySchedule = {};

        function generateMonthlySchedule() {
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dayOfWeek = date.getDay(); 
                const patternIndex = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
                monthlySchedule[d] = schedulePattern[patternIndex];
            }
        }
        generateMonthlySchedule();

        // --- Language ---
        const translations = { es: { today: 'Hoy', calendar: 'Calendario', routines: 'Rutinas', library: 'Biblioteca', dailyProgress: 'Progreso del d√≠a', equipmentNeeded: 'Equipo', exercise: 'Ejercicio', sets: 'Series', reps: 'Repeticiones', rest: 'Descanso', notes: 'Notas', done: 'Hecho', selectRoutineDesc: 'Selecciona una rutina para ver los ejercicios.', exerciseLibraryDesc: 'Gu√≠a de ejercicios con t√©cnica y consejos.' } };
        function t(key) { return translations.es[key] || key; }

        function updateLanguageDisplay() {
            document.querySelectorAll('[data-key]').forEach(el => el.textContent = t(el.getAttribute('data-key')));
            document.querySelectorAll('[data-routine-key]').forEach(el => {
                const r = routines[el.getAttribute('data-routine-key')];
                if (r && r.title) el.textContent = r.title.includes(':') ? r.title.split(':')[1].split(' ')[1] : 'REGENERACI√ìN';
            });
        }

        // --- Core UI Functions ---
        function getRoutineColorClass(routineKey) {
            const isHighIntensity = routineKey === 'METABOLIC' || routineKey === 'CORE_CARDIO';
            if (isHighIntensity) return { text: 'text-metabolic', border: 'border-metabolic/50', shadow: 'shadow-metabolic', bg: 'bg-metabolic/10' };
            if (routineKey === 'REST') return { text: 'text-emerald-300', border: 'border-emerald-500/50', shadow: 'shadow-emerald-500', bg: 'bg-emerald-500/10' };
            if (routineKey.includes('PUSH') || routineKey.includes('PULL')) return { text: 'text-sky-400', border: 'border-sky-400/50', shadow: 'shadow-sky-400', bg: 'bg-sky-400/10' };
            if (routineKey.includes('LEGS') || routineKey.includes('GLUTES')) return { text: 'text-amber-400', border: 'border-amber-400/50', shadow: 'shadow-amber-400', bg: 'bg-amber-400/10' };
            return { text: 'text-secondary', border: 'border-border', shadow: '', bg: 'bg-card-bg/80' };
        }

        function createRoutineHeaderHTML(routineData, routineKey, isTodayView, dateParam) {
            const isHighIntensity = routineKey === 'METABOLIC' || routineKey === 'CORE_CARDIO';
            const isCurrentDay = isTodayView && dateParam && dateKeyFromDate(dateParam) === dateKeyFromDate(today);
            const dateLabel = dateParam ? dateParam.toLocaleDateString('es-ES', { weekday: 'long', month: 'short', day: 'numeric' }) : '';
            
            let progressHTML = '';
            let saveButtonHTML = '';
            if (isTodayView && routineData.details) {
                progressHTML = `
                    <div class="mb-6">
                        <h3 class="text-center font-bold text-xl mb-2 text-primary">${t('dailyProgress')}</h3>
                        <div id="progress-text" class="text-center font-bold text-lg text-accent" style="text-shadow: var(--glow-accent);">0% Completado</div>
                        <div id="progress-count" class="text-center text-secondary text-sm mt-1">0 de ${routineData.details.exercises.length} ejercicios</div>
                        <div class="progress-bar-container mt-3" style="height: 1rem;"><div id="progress-bar" class="progress-bar" style="width: 0%;"></div></div>
                    </div>`;
                
                // Mostrar bot√≥n de guardar cuando no es el d√≠a actual
                if (!isCurrentDay) {
                    saveButtonHTML = `<div class="mt-6 p-4 bg-accent/15 border-2 border-accent rounded-lg"><button id="save-day-btn" class="w-full px-4 py-3 bg-accent/25 hover:bg-accent/50 border border-accent text-accent rounded-lg font-bold transition text-base md:text-lg" style="text-shadow: 0 0 8px rgba(0, 212, 255, 0.8); box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);">üíæ GUARDAR CAMBIOS DEL D√çA</button></div>`;
                }
            }
            return `<div class="relative bg-card-bg/80 p-4 md:p-6 lg:p-8 rounded-lg shadow-lg border ${isHighIntensity ? 'metabolic-border metabolic-shadow' : 'border-border'}">
                        ${!isCurrentDay && isTodayView ? `<div class="text-center text-base md:text-lg text-accent-hover mb-4 font-bold px-3 py-2 bg-accent-hover/10 rounded-lg" style="text-shadow: 0 0 10px rgba(29, 255, 127, 0.8);">üìÖ EDITANDO: ${dateLabel.toUpperCase()}</div>` : ''}
                        ${progressHTML}
                        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold mb-1 text-center ${isHighIntensity ? 'metabolic-text' : 'text-primary'}">${routineData.title}</h2>
                        <p class="text-center text-secondary mb-2 text-sm md:text-base">${routineData.description}</p>
                        ${saveButtonHTML}
                    </div>`;
        }

        function createRoutineTableHTML(exercises, isTodayView, routineKey) {
            const rows = exercises.map((ex, index) => `
                <tr class="border-b border-border last:border-b-0 hover:bg-black/20 transition">
                    <td class="p-2 md:p-3 lg:p-4 font-medium text-primary text-sm md:text-base">
                        <div class="font-semibold flex items-center gap-1 md:gap-2"><span>${getExerciseName(ex.name)}</span><button class="exercise-info-btn text-[10px] px-1 py-0.5 rounded text-secondary/60 hover:text-accent/80 hover:bg-accent/10 transition" data-exercise="${ex.name}">üìö</button></div>
                        <div class="text-xs text-secondary hidden md:block">${getExerciseDescription(ex.name)}</div>
                    </td>
                    <td class="p-2 md:p-3 lg:p-4 text-center text-secondary text-sm md:text-base">${ex.series}</td>
                    <td class="p-2 md:p-3 lg:p-4 text-center text-secondary text-sm md:text-base">${ex.reps}</td>
                    <td class="p-2 md:p-3 lg:p-4 text-center text-secondary text-sm md:text-base">
                        <div class="flex justify-center items-center gap-1 md:gap-2"><span class="rest-text text-xs md:text-sm">${ex.rest}</span>
                        ${isTodayView ? `<button class="rest-timer-btn text-[10px] px-1 py-0.5 rounded text-accent/60 hover:text-accent hover:bg-accent/10 transition" data-rest="${ex.rest}">‚è±Ô∏è</button><span class="rest-countdown text-secondary text-xs"></span>` : ''}</div>
                    </td>
                    <td class="p-2 md:p-3 lg:p-4 text-xs md:text-sm text-secondary hidden md:table-cell">${ex.notes || ''}</td>
                    ${isTodayView ? `<td class="p-2 md:p-3 lg:p-4 text-center"><input type="checkbox" data-exercise-index="${index}" class="h-4 w-4 rounded bg-card-bg border-border accent-accent"></td>` : ''}
                </tr>
            `).join('');
            return `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-black/30"><tr><th class="p-2 text-xs text-secondary uppercase">${t('exercise')}</th><th class="p-2 text-xs text-center text-secondary uppercase">${t('sets')}</th><th class="p-2 text-xs text-center text-secondary uppercase">${t('reps')}</th><th class="p-2 text-xs text-center text-secondary uppercase">${t('rest')}</th><th class="p-2 text-xs text-secondary uppercase hidden md:table-cell">${t('notes')}</th>${isTodayView ? `<th class="p-2 text-xs text-center text-secondary uppercase">${t('done')}</th>` : ''}</tr></thead><tbody>${rows}</tbody></table></div>`;
        }

        function createRoutineHTML(routineKey, isTodayView, date) {
            const routineData = routines[routineKey];
            const colors = getRoutineColorClass(routineKey);
            
            if (routineKey === 'REST') {
                if (isTodayView) {
                    const allProgress = getStoredProgress();
                    const key = dateKeyFromDate(currentViewDate);
                    const restCompleted = allProgress[key] && allProgress[key][0];
                    return `<div class="space-y-6">
                                <div class="relative bg-card-bg/80 p-4 md:p-6 lg:p-8 rounded-lg shadow-lg border border-border">
                                    <div class="text-center">
                                        <h3 class="text-center font-bold text-xl mb-2 text-primary">ESTADO DE LA SECUENCIA DIARIA</h3>
                                        <div id="progress-text" class="text-center font-bold text-lg text-accent-hover" style="text-shadow: 0 0 15px rgba(29, 255, 127, 0.8);">${restCompleted ? '100% COMPLETADO' : '0% COMPLETADO'}</div>
                                        <div id="progress-count" class="text-center text-secondary text-sm mt-1">${restCompleted ? '‚úì' : '‚úó'} Descanso</div>
                                        <div class="progress-bar-container mt-3" style="height: 1rem;"><div id="progress-bar" class="progress-bar" style="width: ${restCompleted ? '100' : '0'}%; background: linear-gradient(90deg, ${restCompleted ? '#1dff7f' : '#00d4ff'} 0%, ${restCompleted ? '#1dff7f' : '#00f0ff'} 100%);"></div></div>
                                    </div>
                                </div>
                                <div class="p-8 text-center ${colors.bg} border ${colors.border} rounded-xl shadow-lg">
                                    <div class="text-4xl mb-4">üõå</div>
                                    <h2 class="text-3xl font-bold ${colors.text}">${routineData.title}</h2>
                                    <p class="text-secondary mt-2">${routineData.description}</p>
                                    <div class="mt-6 flex items-center justify-center gap-3">
                                        <input type="checkbox" id="rest-completed" class="w-6 h-6 accent-accent cursor-pointer" data-index="0" ${restCompleted ? 'checked' : ''} style="cursor: pointer;">
                                        <label for="rest-completed" class="text-accent font-bold cursor-pointer text-lg">D√≠a de Descanso Completado</label>
                                    </div>
                                </div>
                            </div>`;
                } else {
                    return `<div class="p-8 text-center ${colors.bg} border ${colors.border} rounded-xl shadow-lg">
                                <div class="text-4xl mb-4">üõå</div>
                                <h2 class="text-3xl font-bold ${colors.text}">${routineData.title}</h2>
                                <p class="text-secondary mt-2">${routineData.description}</p>
                            </div>`;
                }
            }
            if (!routineData || !routineData.details) return `<div class="p-8 text-center bg-card-bg/80">No hay rutina asignada.</div>`;

            const headerHTML = createRoutineHeaderHTML(routineData, routineKey, isTodayView, date);
            const tableHTML = createRoutineTableHTML(routineData.details.exercises, isTodayView, routineKey);
            
            const equipmentSet = new Set();
            routineData.details.exercises.forEach(ex => {
                const lib = exerciseLibrary[ex.name];
                if (lib && lib.equipment) {
                    equipmentSet.add(lib.equipment);
                    return;
                }
                if (ex.name.includes('Dumbbell')) equipmentSet.add('üèãÔ∏è Mancuernas');
                if (ex.name.includes('Pilates Bar')) equipmentSet.add('üéØ Barra Pilates');
                if (ex.name.includes('Band')) equipmentSet.add('üü∞ Bandas');
                if (ex.name.includes('Plank')) equipmentSet.add('üõèÔ∏è Tapete');
            });
            
            let equipmentHTML = equipmentSet.size > 0 && isTodayView ? `<div class="mt-8 p-5 bg-gradient-to-br from-black/50 to-black/30 border-2 border-metabolic/60 rounded-lg shadow-lg" style="box-shadow: 0 0 20px rgba(255, 0, 110, 0.3), inset 0 0 15px rgba(255, 0, 110, 0.1);"><h4 class="font-bold text-lg text-metabolic mb-4 flex items-center gap-2" style="text-shadow: 0 0 10px rgba(255, 0, 110, 0.8);">‚öôÔ∏è ${t('equipmentNeeded')}</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${Array.from(equipmentSet).map(eq => `<div class="text-base font-semibold text-white bg-black/40 p-3 rounded-lg border border-metabolic/40 flex items-center gap-2" style="text-shadow: 0 0 5px rgba(255, 0, 110, 0.6);">${eq}</div>`).join('')}</div></div>` : '';

            return `<div class="space-y-6">${headerHTML}<div class="bg-card-bg/80 border border-border rounded-lg shadow-lg">${tableHTML}</div>${equipmentHTML}</div>`;
        }

        async function displayTodaysPlan(dateOverride) {
            const viewDate = dateOverride instanceof Date ? dateOverride : currentViewDate;
            const routineKey = monthlySchedule[viewDate.getDate()];
            document.getElementById('hoy').innerHTML = createRoutineHTML(routineKey, true, viewDate);
            await loadProgress();
        }

        // --- Logic ---
        function getStoredProgress() {
            try {
                const raw = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || {};
                const normalized = {};
                let mutated = false;

                for (const [k, v] of Object.entries(raw)) {
                    const nk = normalizeDateKey(k) || k;
                    if (nk !== k) mutated = true;

                    if (Array.isArray(v)) {
                        if (!Array.isArray(normalized[nk])) {
                            normalized[nk] = v;
                        } else {
                            const a = normalized[nk];
                            const maxLen = Math.max(a.length, v.length);
                            const merged = new Array(maxLen).fill(false);
                            for (let i = 0; i < maxLen; i++) merged[i] = !!a[i] || !!v[i];
                            normalized[nk] = merged;
                            mutated = true;
                        }
                    } else {
                        normalized[nk] = v;
                    }
                }

                if (mutated) localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(normalized));
                return normalized;
            } catch {
                return {};
            }
        }

        function getHistoricalStats() {
            const allProgress = getStoredProgress();
            let stats = {
                totalWorkouts: 0,
                totalExercisesCompleted: 0,
                longestStreak: 0,
                currentStreak: 0,
                lastWorkoutDate: null,
                completedDays: []
            };
            
            const completed = [];

            for (const [dateKey, dayData] of Object.entries(allProgress)) {
                if (!Array.isArray(dayData) || dayData.length === 0) continue;
                const done = dayData.filter(Boolean).length;
                const total = dayData.length;
                stats.totalExercisesCompleted += done;
                const pct = total > 0 ? (done / total) : 0;
                if (pct >= STREAK_COMPLETION_THRESHOLD) {
                    const dt = dateFromKey(dateKey);
                    if (dt) completed.push({ key: normalizeDateKey(dateKey) || dateKey, date: dt });
                }
            }

            completed.sort((a, b) => a.date - b.date);
            stats.completedDays = completed.map(x => x.key);
            stats.totalWorkouts = stats.completedDays.length;
            stats.lastWorkoutDate = stats.completedDays.length ? stats.completedDays[stats.completedDays.length - 1] : null;

            // Mejor racha
            let best = 0;
            let run = 0;
            for (let i = 0; i < completed.length; i++) {
                if (i === 0) {
                    run = 1;
                } else {
                    const prev = completed[i - 1].date;
                    const curr = completed[i].date;
                    const diffDays = Math.round((curr - prev) / (1000 * 60 * 60 * 24));
                    run = (diffDays === 1) ? (run + 1) : 1;
                }
                best = Math.max(best, run);
            }
            stats.longestStreak = best;

            // Racha actual (hasta hoy)
            const completedSet = new Set(stats.completedDays);
            let streak = 0;
            let cursor = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            while (completedSet.has(dateKeyFromDate(cursor))) {
                streak++;
                cursor.setDate(cursor.getDate() - 1);
            }
            stats.currentStreak = streak;
            
            return stats;
        }

        function loadProgress() {
            const allProgress = getStoredProgress();
            const key = dateKeyFromDate(currentViewDate);
            const todaysData = allProgress[key] || [];
            document.querySelectorAll('#hoy input[type="checkbox"]').forEach((cb, idx) => cb.checked = !!todaysData[idx]);
            updateProgressUI();
        }

        function saveProgress() {
            const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
            const state = Array.from(checkboxes).map(cb => cb.checked);
            const allProgress = getStoredProgress();
            allProgress[dateKeyFromDate(currentViewDate)] = state;
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allProgress));
            updateProgressUI();
            updateGlobalProgress();
            generateCalendar();
            checkDayCompletion();
        }

        function updateProgressUI() {
            const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
            if(checkboxes.length === 0) return;
            const checked = Array.from(checkboxes).filter(c => c.checked).length;
            const pct = Math.round((checked/checkboxes.length)*100);
            const bar = document.getElementById('progress-bar');
            const text = document.getElementById('progress-text');
            const count = document.getElementById('progress-count');
            const routineKey = monthlySchedule[currentViewDate.getDate()];
            const isRestDay = routineKey === 'REST';
            if(bar) bar.style.width = `${pct}%`;
            if(text) text.innerText = `${pct}% COMPLETADO`;
            if(count) {
                if (isRestDay) {
                    count.innerText = `${checked > 0 ? '‚úì' : '‚úó'} Descanso`;
                } else {
                    count.innerText = `${checked} de ${checkboxes.length} ejercicios`;
                }
            }
        }

        function updateGlobalProgress() {
            const allProgress = getStoredProgress();
            const stats = getHistoricalStats();
            let total = 0, completed = 0;
            for (let d = 1; d <= daysInMonth; d++) {
                const routineKey = monthlySchedule[d];
                const r = routines[routineKey];
                const key = dateKeyFromDate(new Date(year, month, d));
                const dayP = allProgress[key] || [];

                if (routineKey === 'REST') {
                    total += 1;
                    completed += (dayP[0] ? 1 : 0);
                } else if (r && r.details) {
                    total += r.details.exercises.length;
                    completed += dayP.filter(Boolean).length;
                }
            }
            const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('global-progress-bar').style.width = `${pct}%`;
            document.getElementById('global-progress-text').textContent = `${pct}% CONSOLIDADO`;
            
            // Update global stats if element exists
            const globalStatsEl = document.getElementById('global-stats');
            if (globalStatsEl) {
                globalStatsEl.innerHTML = `
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div class="p-2 bg-black/30 rounded border border-accent/30">
                            <div class="text-secondary text-xs">RACHA ACTUAL</div>
                            <div class="text-accent font-bold">${stats.currentStreak}d</div>
                            <div class="text-secondary/70 text-[10px] mt-1">Mejor: ${stats.longestStreak}d</div>
                        </div>
                        <div class="p-2 bg-black/30 rounded border border-accent/30">
                            <div class="text-secondary text-xs">D√çAS COMPLETOS</div>
                            <div class="text-accent font-bold">${stats.totalWorkouts}</div>
                        </div>
                        <div class="p-2 bg-black/30 rounded border border-accent/30">
                            <div class="text-secondary text-xs">EJERCICIOS</div>
                            <div class="text-accent font-bold">${stats.totalExercisesCompleted}</div>
                        </div>
                    </div>
                `;
            }
        }

        function generateCalendar() {
            const calendarBody = document.getElementById('calendar-body');
            if (!calendarBody) return;
            const titleEl = document.getElementById('calendar-title');
            if (titleEl) {
                const monthLabelRaw = new Date(year, month, 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const monthLabel = monthLabelRaw.charAt(0).toUpperCase() + monthLabelRaw.slice(1);
                titleEl.textContent = `üìÖ ${monthLabel}`;
            }
            const firstDay = new Date(year, month, 1).getDay();
            const offset = (firstDay === 0) ? 6 : firstDay - 1;
            const allProgress = getStoredProgress();
            const isMobile = window.innerWidth <= 768;
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

            let html = '';
            
            // Only add offset for desktop grid
            if (!isMobile) {
                for (let i = 0; i < offset; i++) html += `<div class="bg-black/20 rounded-md"></div>`;
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const key = monthlySchedule[d];
                const act = routines[key];
                const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const colors = getRoutineColorClass(key);
                const dateObj = new Date(year, month, d);
                const dayP = allProgress[dateKeyFromDate(dateObj)] || [];
                const dayOfWeek = dayNames[dateObj.getDay()];
                
                // Get emoji and short description
                let emoji = '';
                let shortDesc = '';
                if (key === 'REST') {
                    emoji = 'üõå';
                    shortDesc = 'Descanso';
                } else {
                    const titleParts = act.title.split(':');
                    emoji = titleParts[0].trim().split(' ')[0];
                    shortDesc = titleParts[1] ? titleParts[1].trim().split(' ').slice(0, 3).join(' ') : 'Entrenamiento';
                }
                
                // Calculate progress percentage
                let badge = '';
                let progressBar = '';
                let pct = 0;
                if (key === 'REST') {
                    pct = dayP[0] ? 100 : 0;
                    if (pct > 0) {
                        badge = `<span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 font-bold">‚úì ${pct}%</span>`;
                        progressBar = `<div class="w-full h-1 bg-black/40 rounded-full overflow-hidden mt-1"><div class="h-full bg-emerald-500 transition-all" style="width: ${pct}%"></div></div>`;
                    } else {
                        progressBar = `<div class="w-full h-1 bg-black/40 rounded-full mt-1"></div>`;
                    }
                } else if (act.details) {
                    pct = act.details.exercises.length > 0 ? Math.round((dayP.filter(Boolean).length / act.details.exercises.length) * 100) : 0;
                    if(pct > 0) {
                        const barColor = pct === 100 ? 'bg-emerald-500' : 'bg-amber-500';
                        badge = `<span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full ${pct===100?'bg-emerald-500/20 text-emerald-300':'bg-amber-500/20 text-amber-300'} font-bold">${pct===100?'‚úì':''} ${pct}%</span>`;
                        progressBar = `<div class="w-full h-1 bg-black/40 rounded-full overflow-hidden mt-1"><div class="h-full ${barColor} transition-all" style="width: ${pct}%"></div></div>`;
                    } else {
                        progressBar = `<div class="w-full h-1 bg-black/40 rounded-full mt-1"></div>`;
                    }
                }

                if (isMobile) {
                    // Mobile list layout - improved with day name
                    html += `<div class="calendar-day ${colors.bg} rounded-lg border-2 ${colors.border} cursor-pointer hover:shadow-lg transition-all ${isToday ? 'today ring-2 ring-accent' : ''}" data-date="${year}-${month + 1}-${d}">
                                <div class="flex items-center gap-4 flex-1">
                                    <div class="flex flex-col items-center min-w-[50px]">
                                        <div class="text-[10px] uppercase text-secondary/70 font-semibold">${dayOfWeek}</div>
                                        <div class="text-2xl font-bold ${isToday ? 'text-accent' : 'text-primary'}">${d}</div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold ${colors.text}">${shortDesc}</div>
                                        ${act.details ? `<div class="text-xs text-secondary/60">${act.details.exercises.length} ejercicios</div>` : '<div class="text-xs text-secondary/60">Recuperaci√≥n activa</div>'}
                                        ${progressBar}
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-1">
                                    <div class="text-3xl">${emoji}</div>
                                    ${badge}
                                </div>
                            </div>`;
                } else {
                    // Desktop grid layout - improved
                    html += `<div class="calendar-day ${colors.bg} rounded-lg border-2 ${colors.border} flex flex-col cursor-pointer hover:shadow-lg hover:scale-105 transition-all ${isToday ? 'today ring-2 ring-accent ring-offset-2 ring-offset-black' : ''}" data-date="${year}-${month + 1}-${d}" style="min-height: 110px;">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="font-bold text-base ${isToday ? 'text-accent' : 'text-primary'}">${d}</div>
                                    <div class="text-xl">${emoji}</div>
                                </div>
                                <div class="text-[11px] font-semibold ${colors.text} leading-tight mb-1">${shortDesc}</div>
                                ${act.details ? `<div class="text-[10px] text-secondary/60">${act.details.exercises.length} ejercicios</div>` : '<div class="text-[10px] text-secondary/60">Recuperaci√≥n</div>'}
                                <div class="mt-auto">
                                    ${progressBar}
                                    <div class="mt-1">${badge}</div>
                                </div>
                             </div>`;
                }
            }
            calendarBody.innerHTML = html;
        }

        function launchConfetti() {
            for(let i=0; i<50; i++) {
                const c = document.createElement('div');
                c.classList.add('confetti');
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }

        function checkDayCompletion() {
            const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
            if (checkboxes.length === 0) return;
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const key = `celebrated_${dateKeyFromDate(currentViewDate)}`;
            if (allChecked && !sessionStorage.getItem(key)) {
                sessionStorage.setItem(key, 'true');
                launchConfetti();
                document.getElementById('progress-text').innerText = '¬°PROTOCOLO CUMPLIDO! üéâ';
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const modal = document.getElementById('exercise-modal');
            const title = document.getElementById('guide-title');
            const content = document.getElementById('guide-content');
            
            window.openExerciseInfo = (name) => {
                const data = exerciseLibrary[name] || { category: 'N/A', equipment: 'N/A', difficulty: 'N/A', form: { es: ['N/A'] }, tips: { es: ['N/A'] }, muscleGroups: ['N/A'] };
                title.textContent = name;
                content.innerHTML = `<div class="space-y-4"><div class="flex flex-wrap gap-2"><span class="px-3 py-1 bg-accent/20 text-accent text-xs font-semibold rounded-full">${data.category}</span></div><h4 class="font-bold">Forma:</h4><ul class="list-decimal pl-4 text-sm">${(data.form.es||[]).map(s=>`<li>${s}</li>`).join('')}</ul><h4 class="font-bold">Tips:</h4><div class="text-sm">${(data.tips.es||[]).map(t=>`<p>${t}</p>`).join('')}</div></div>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            document.getElementById('modal-close').addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', async () => {
                    // Si es el bot√≥n "Hoy", siempre regresa a la fecha actual
                    if (tab.dataset.tab === 'hoy') {
                        currentViewDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                        await displayTodaysPlan(currentViewDate);
                    }
                    
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('tab-active'));
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    tab.classList.add('tab-active');
                });
            });

            document.getElementById('rutinas').addEventListener('click', (e) => {
                const btn = e.target.closest('.routine-selector');
                if (btn) document.getElementById('routine-details-container').innerHTML = createRoutineHTML(btn.dataset.routine, false, null);
            });

            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.exercise-info-btn')) openExerciseInfo(e.target.closest('.exercise-info-btn').dataset.exercise);
                if(e.target.closest('.rest-timer-btn')) {
                    const btn = e.target.closest('.rest-timer-btn');
                    let val = parseInt(btn.dataset.rest);
                    const display = btn.nextElementSibling;
                    btn.textContent = '‚èπ';
                    const int = setInterval(() => { val--; display.innerText = val+'s'; if(val<=0){ clearInterval(int); btn.textContent='‚è±Ô∏è'; display.innerText='LISTO'; } }, 1000);
                }
                // Bot√≥n de guardar d√≠a del calendario
                if(e.target.closest('#save-day-btn')) {
                    saveProgress();
                    const btn = e.target.closest('#save-day-btn');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì GUARDADO';
                    btn.style.backgroundColor = 'rgba(29, 255, 127, 0.3)';
                    btn.style.borderColor = 'rgb(29, 255, 127)';
                    btn.style.color = 'rgb(29, 255, 127)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = '';
                        btn.style.borderColor = '';
                        btn.style.color = '';
                    }, 2000);
                }
            });

            document.getElementById('hoy').addEventListener('change', (e) => { if(e.target.matches('input')) saveProgress(); });
            
            document.getElementById('calendar-body').addEventListener('click', (e) => {
                const cell = e.target.closest('.calendar-day');
                if(cell) {
                    const [y,m,d] = cell.dataset.date.split('-').map(Number);
                    currentViewDate = new Date(y, m-1, d);
                    displayTodaysPlan(currentViewDate);
                    // No hacemos click en 'hoy', el calendario es independiente
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('tab-active'));
                    document.getElementById('hoy').classList.add('active');
                    document.querySelector('[data-tab="hoy"]').classList.add('tab-active');
                }
            });

            updateLanguageDisplay();
            await displayTodaysPlan();
            generateCalendar();
            updateGlobalProgress();
            
            // Regenerate calendar on window resize for responsive behavior
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    generateCalendar();
                }, 250);
            });
            
            // Generate Library
            const libContainer = document.getElementById('exercise-library');
            const allEx = new Set();
            Object.values(routines).forEach(r=>r.details?.exercises.forEach(e=>allEx.add(e.name)));
            // Ordenar alfab√©ticamente
            const sortedEx = Array.from(allEx).sort((a, b) => a.localeCompare(b, 'es'));
            libContainer.innerHTML = `<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">${sortedEx.map((name, idx) => {
                const firstLetter = name.charAt(0).toUpperCase();
                const showLetter = idx === 0 || sortedEx[idx - 1].charAt(0).toUpperCase() !== firstLetter;
                return `${showLetter ? `<div class="col-span-full"><h3 class="text-2xl font-bold text-accent mt-4 mb-2" style="text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);">üìå ${firstLetter}</h3></div>` : ''}
                <div class="p-4 bg-gradient-to-br from-black/50 to-black/30 border border-accent/50 rounded-lg cursor-pointer hover:border-accent/80 hover:bg-accent/15 hover:shadow-lg shadow-md transition duration-300 transform hover:scale-105" onclick="openExerciseInfo('${name}')" style="box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);">
                    <h3 class="font-bold text-accent text-base leading-tight">${name}</h3>
                    <div class="text-xs text-secondary/70 mt-1 opacity-0 group-hover:opacity-100 transition">Click para detalles ‚Üí</div>
                </div>`;
            }).join('')}</div>`;

            document.querySelector('[data-tab="hoy"]').classList.add('tab-active');
            document.getElementById('hoy').classList.add('active');
        });
    </script>
</body>
</html>

