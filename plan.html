<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bernie - Online Fitness Tracker | Your 4:20 Retro-Futuristic AI Training Workouts</title>
    <meta name="theme-color" content="#00D0FF">
    <link rel="manifest" id="manifest-link" href="manifest.json">
    <link rel="apple-touch-icon" href="imagenes/logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aldrich&family=Inter:wght@400;600&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #10001C;
            --card-bg: #1A0A2A;
            --text-primary: #F0E6FF;
            --text-secondary: #A094B7;
            --accent: #00D0FF;
            --accent-hover: #9effff;
            --metabolic: #FF00FF;
            --border: #3C1E5A;
            --glow-accent: 0 0 3px var(--accent), 0 0 6px var(--accent), 0 0 10px var(--accent);
            --glow-metabolic: 0 0 3px var(--metabolic), 0 0 6px var(--metabolic), 0 0 10px var(--metabolic);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            /* Updated background with logo and gradient */
            background-image: 
                linear-gradient(rgba(16, 0, 28, 0.95), rgba(16, 0, 28, 0.95)), /* Dark overlay for text readability */
                url('https://i.imgur.com/your-logo-image.png'), /* Replace with your uploaded logo URL */
                linear-gradient(var(--accent), transparent 1px),
                linear-gradient(90deg, var(--accent), transparent 1px);
            background-size: 
                cover, /* For the overlay */
                30% auto, /* Adjust logo size as needed */
                40px 40px,
                40px 40px;
            background-repeat: 
                no-repeat, 
                no-repeat, 
                repeat, 
                repeat;
            background-position: 
                center center, /* For the overlay */
                center 10%, /* Adjust logo position */
                -1px -1px,
                -1px -1px;
            background-blend-mode: overlay, normal, normal, normal; /* Blend the overlay with the logo */
            animation: bg-scroll 3s linear infinite;
        }
        @keyframes bg-scroll {
            0% { background-position: center center, center 10%, 0 0, 0 0; } /* Include logo position */
            100% { background-position: center center, center 10%, 40px 40px, 40px 40px; } /* Include logo position */
        }
        @keyframes text-glow {
            0%, 100% { text-shadow: 0 0 4px var(--accent), 0 0 8px var(--accent), 0 0 12px var(--accent); }
            50% { text-shadow: 0 0 8px var(--accent-hover), 0 0 16px var(--accent-hover), 0 0 24px var(--accent-hover); }
        }
        @keyframes box-glow {
            0%, 100% { box-shadow: 0 0 10px var(--accent), 0 0 15px var(--accent); border-color: var(--accent); }
            50% { box-shadow: 0 0 15px var(--accent-hover), 0 0 30px var(--accent-hover); border-color: var(--accent-hover); }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .main-container {
            background-color: rgba(16, 0, 28, 0.9);
            backdrop-filter: blur(5px);
        }
        h1 {
             font-family: 'Press Start 2P', cursive;
             color: var(--text-primary);
             text-shadow: var(--glow-accent);
             font-size: clamp(1.5rem, 5vw, 3rem);
        }
        .animated-text-glow {
            animation: text-glow 2.5s ease-in-out infinite;
        }
        .animated-box-glow {
            animation: box-glow 2.5s ease-in-out infinite;
        }
        h2, h3, h4, h5 {
             font-family: 'Aldrich', sans-serif;
             color: var(--text-primary);
             text-transform: uppercase;
        }
        .tab-active {
            border-color: var(--accent);
            color: var(--accent);
            text-shadow: var(--glow-accent);
        }
        .content-section { 
            display: none;
        }
        .content-section.active { 
            display: block;
            animation: fade-in 0.4s ease-in-out;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day { 
            min-height: 100px; 
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            border-color: var(--accent) !important;
            box-shadow: var(--glow-accent);
            z-index: 10;
        }
        .calendar-day-header {
            font-size: 0.75rem;
            text-align: center;
            padding: 4px 0;
            color: var(--text-secondary);
            font-family: 'Aldrich', sans-serif;
        }
        .today {
            border-width: 2px;
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(0, 208, 255, 0.7);
        }
        .progress-bar-container {
            background-color: #334155;
            border-radius: 9999px;
            height: 1.25rem;
            width: 100%;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: inset 0 0 5px #000;
        }
        .progress-bar {
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            box-shadow: var(--glow-accent);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(16, 0, 28, 0.8);
            backdrop-filter: blur(8px);
            display: none; /* Changed from opacity */
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0; /* Use opacity for transition */
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .modal-overlay.active {
            display: flex; /* Use display to show/hide */
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 60rem;
            color: var(--text-primary);
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .prose { color: var(--text-secondary); }
        .prose h3 { color: var(--text-primary); text-shadow: var(--glow-accent); }
        .prose h5 { color: var(--text-secondary); }
        .prose a { color: var(--accent); }
        .prose a:hover { color: var(--accent-hover); }
        .prose ul { list-style-type: '‚ö° '; }
        .prose hr { border-color: var(--border); }
        .img-placeholder {
            background-color: var(--bg-color);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            min-height: 200px;
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
        }
        .routine-selector, .nav-tab {
            transition: all 0.2s ease-in-out;
        }
        .routine-selector:hover, .nav-tab:hover {
            transform: translateY(-2px);
            text-shadow: var(--glow-accent);
        }
        .metabolic-text {
            color: var(--metabolic);
            text-shadow: var(--glow-metabolic);
        }
        .metabolic-border {
            border-color: var(--metabolic);
        }
        .metabolic-shadow {
            box-shadow: 0 0 12px rgba(255, 0, 255, 0.7);
        }
        .stats-card {
            background: linear-gradient(135deg, var(--card-bg), rgba(60, 30, 90, 0.5));
            border: 1px solid var(--accent);
            box-shadow: 0 0 8px rgba(0, 208, 255, 0.3);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        @media (max-width: 640px) {
            .calendar-grid {
                gap: 2px;
            }
            .calendar-day {
                min-height: 80px;
                font-size: 0.75rem;
            }
            h2, h3, h4, h5 {
                font-size: clamp(1rem, 3vw, 1.5rem);
            }
        }
        .edit-exercise-modal .modal-content {
            width: 90vw;
            max-width: 500px;
        }
        .routine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .routine-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto max-w-5xl p-4 sm:p-6 main-container rounded-lg shadow-2xl border border-border">
        
        <header class="text-center my-8 mb-12 relative">
            <button id="lang-toggle" class="absolute top-0 right-0 px-3 py-2 rounded-lg bg-card-bg/80 border border-border text-secondary hover:text-accent transition-colors font-semibold text-sm whitespace-nowrap">üåê EN</button>
            <!-- Hero Logo Section --><div class="relative mb-8">
                <div class="absolute inset-0 rounded-full blur-3xl opacity-50" style="background: linear-gradient(135deg, #00D0FF, #FF00FF);"></div>
                <a href="#" id="logo-link" class="relative inline-block transition-transform hover:scale-105 cursor-pointer" onclick="window.location.reload(); return false;">
                    <img id="logo-img" src="imagenes/logo.png" alt="Ber Online Fitness Logo" class="w-40 h-40 rounded-full shadow-2xl border-4 border-accent" style="box-shadow: 0 0 40px rgba(0, 208, 255, 0.8), 0 0 80px rgba(255, 0, 255, 0.4);">
                </a>
            </div>
            <div class="flex justify-center items-center gap-4 mb-4">
            </div>
            <h1 class="text-6xl sm:text-7xl animated-text-glow font-bold tracking-wider">Bernie</h1>
            <p class="text-lg text-secondary mt-4 font-['Aldrich'] uppercase tracking-widest">Online Fitness Tracker</p>
            <p class="text-sm text-secondary/70 mt-2 font-light tracking-wider">Your 4:20 Retro-Futuristic AI Training Workouts</p>
            <div class="mt-4 w-24 h-1 bg-gradient-to-r from-accent via-metabolic to-accent mx-auto rounded-full"></div>
        </header>

        <div class="mb-8 p-4 bg-card-bg/80 rounded-lg shadow-lg border border-border">
            <h2 class="text-center text-xl font-bold text-primary mb-3">Global Monthly Progress</h2>
            <div id="global-progress-text" class="text-center font-bold text-lg mb-2 text-accent" style="text-shadow: var(--glow-accent);">0%</div>
            <div class="progress-bar-container">
                <div id="global-progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
        </div>

        <nav class="flex justify-between items-center border-b border-border mb-8">
            <div class="flex flex-wrap justify-center -mb-px overflow-x-auto flex-1">
                <button data-tab="hoy" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üóìÔ∏è <span data-key="today">Today</span></button>
                <button data-tab="stats" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üìä <span data-key="stats">Stats</span></button>
                <button data-tab="calendario" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üìÖ <span data-key="calendar">Calendar</span></button>
                <button data-tab="rutinas" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üèãÔ∏è‚Äç‚ôÇÔ∏è <span data-key="routines">Routines</span></button>
                <button data-tab="biblioteca" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent whitespace-nowrap">üìö <span data-key="library">Library</span></button>
        </nav>

        <main id="main-content">
            <section id="hoy" class="content-section"></section>
            <section id="stats" class="content-section">
                <div class="bg-card-bg/80 p-4 sm:p-6 rounded-lg shadow-lg border border-border">
                    <h2 class="text-2xl font-bold mb-6 text-center">üìä <span data-key="weeklyStats">Weekly Statistics</span></h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Weekly Completion</p>
                            <div class="stat-number" id="weekly-completion">0%</div>
                            <p class="text-xs text-secondary mt-2">Last 7 days</p>
                        </div>
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Workouts Done</p>
                            <div class="stat-number" id="workouts-done">0</div>
                            <p class="text-xs text-secondary mt-2">This week</p>
                        </div>
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Total Exercises</p>
                            <div class="stat-number" id="total-exercises">0</div>
                            <p class="text-xs text-secondary mt-2">Completed</p>
                        </div>
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Streak</p>
                            <div class="stat-number" id="current-streak">0</div>
                            <p class="text-xs text-secondary mt-2">Days active</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-bold mb-4 text-primary">Daily Breakdown</h3>
                        <div id="weekly-breakdown" class="space-y-2"></div>
                    </div>
                </div>
            </section>
            <section id="calendario" class="content-section">
                 <div class="bg-card-bg/80 p-4 sm:p-6 rounded-lg shadow-lg border border-border">
                    <div class="text-center mb-6">
                        <h2 id="calendar-title" class="text-2xl font-bold"></h2>
                        <p class="text-secondary mt-1">A complete overview of your training month.</p>
                    </div>
                    <div class="calendar-grid font-semibold text-secondary">
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                        <div class="calendar-day-header">Sun</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
            </section>
            <section id="rutinas" class="content-section">
                <div class="mb-6 text-center">
                    <p class="text-secondary">Here you can check the details of each routine. Select one to see the exercises.</p>
                </div>
                <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                    <button data-routine="TORSO_PUSH" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md" data-title="push">üí™ <span data-routine-key="TORSO_PUSH">Push</span></button>
                    <button data-routine="LEGS_ANKLES" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md" data-title="legsAnkles">ü¶µ <span data-routine-key="LEGS_ANKLES">Legs & Ankles</span></button>
                    <button data-routine="TORSO_PULL" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md" data-title="pull">üèãÔ∏è‚Äç‚ôÇÔ∏è <span data-routine-key="TORSO_PULL">Pull</span></button>
                    <button data-routine="GLUTES_CORE" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md" data-title="glutesCore">üçë <span data-routine-key="GLUTES_CORE">Glutes & Core</span></button>
                    <button data-routine="METABOLIC" class="routine-selector bg-card-bg hover:bg-border text-metabolic font-semibold py-2 px-4 border border-border rounded-lg shadow-md" data-title="metabolic">‚ö° <span data-routine-key="METABOLIC">Metabolic</span></button>
                </div>
                <div id="routine-details-container"></div>
            </section>
            <section id="biblioteca" class="content-section">
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-bold mb-2">üìö <span data-key="library">Library</span></h2>
                    <p class="text-secondary"><span data-key="exerciseLibraryDesc">Complete guide to all exercises with proper form and technique</span></p>
                </div>
                <div id="exercise-library"></div>
            </section>
        </main>
    </div>

    <!-- Modal for Exercise Guide --><div id="guide-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="guide-title" class="text-2xl font-bold"></h2>
                <button id="close-guide-btn" class="text-2xl font-bold text-secondary hover:text-white">&times;</button>
            </div>
            <div id="guide-content" class="prose max-w-none"></div>
        </div>
    </div>

    <!-- Modal for Exercise Editor -->
    <div id="edit-exercise-modal" class="modal-overlay edit-exercise-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Edit Exercise</h2>
                <button id="close-edit-modal" class="text-2xl font-bold text-secondary hover:text-white">&times;</button>
            </div>
            <form id="edit-exercise-form" class="space-y-4">
                <div>
                    <label class="block text-secondary mb-2">Exercise Name</label>
                    <input id="edit-exercise-name" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-secondary mb-2">Series</label>
                        <input id="edit-exercise-series" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                    </div>
                    <div>
                        <label class="block text-secondary mb-2">Reps</label>
                        <input id="edit-exercise-reps" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                    </div>
                </div>
                <div>
                    <label class="block text-secondary mb-2">Rest Time</label>
                    <input id="edit-exercise-rest" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                </div>
                <div>
                    <label class="block text-secondary mb-2">Notes</label>
                    <textarea id="edit-exercise-notes" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" rows="3"></textarea>
                </div>
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="flex-1 bg-accent text-bg-color font-bold py-2 rounded hover:bg-accent-hover transition">Save</button>
                    <button type="button" id="delete-exercise-btn" class="flex-1 bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition">Delete</button>
                </div>
            </form>
        </div>
    </div>

<!-- Firebase SDK Imports --><script type="module">

    // --- Detect Environment (Local vs GitHub Pages) ---
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    // Detect if running on GitHub Pages subdirectory vs custom domain
    const isGitHubPages = window.location.hostname.includes('github.io');
    const BASE_PATH = (isLocalhost || !isGitHubPages) ? '' : '/training_tracker';
    
    // Function to get correct path
    function getPath(filePath) {
        return BASE_PATH + filePath;
    }

    // --- App Configuration ---
    const routines = {
        TORSO_PUSH: {
            title: () => t('push'),
            hasGuide: false,
            description: () => t('chestShouldersTricepsStr'),
            details: {
                exercises: [
                    { name: 'Dumbbell Bench Press', series: 4, reps: '8-12', rest: '60s', notes: 'Chest base strength' },
                    { name: 'Pilates Bar Shoulder Press', series: 4, reps: '12-15', rest: '60s', notes: 'Step on the band for resistance' },
                    { name: 'Band Flys', series: 3, reps: '15-20', rest: '45s', notes: 'Isolate and stretch chest' },
                    { name: 'Dumbbell Lateral Raises', series: 3, reps: '15-20', rest: '45s', notes: 'Shoulder width' },
                    { name: 'Band Triceps Pushdowns', series: 3, reps: '15-20', rest: '45s', notes: 'Isolate triceps' },
                    { name: 'Wrist Extension (Palms down)', series: 3, reps: '15-20', rest: '30s', notes: 'Joint health, with pilates bar' }
                ]
            }
        },
        LEGS_ANKLES: {
            title: () => t('legsAnkles'),
            hasGuide: true,
            description: () => t('legsGlutesStr'),
            details: {
                exercises: [
                    { name: 'Pilates Bar Squat', series: 4, reps: '12-15', rest: '60s', notes: 'Step on band, bar on back' },
                    { name: 'Dumbbell Romanian Deadlift', series: 3, reps: '12-15', rest: '75s', notes: 'Focus on hamstrings' },
                    { name: 'Static Lunge (Ankle Focus)', series: 3, reps: '10-12/side', rest: '60s', notes: 'Control ankle stability' },
                    { name: 'Banded Glute Bridge', series: 3, reps: '15-20', rest: '45s', notes: 'Band on knees, push outwards' },
                    { name: 'Calf Raises (Ankle Focus)', series: 4, reps: '20-25', rest: '45s', notes: 'With pilates bar for resistance' }
                ]
            }
        },
        TORSO_PULL: {
            title: () => t('pull'),
            hasGuide: false,
            description: () => t('backBicepsStr'),
            details: {
                exercises: [
                    { name: 'Pilates Bar Lat Pulldown', series: 4, reps: '12-15', rest: '60s', notes: 'High anchor on door' },
                    { name: 'Dumbbell Bent-Over Row', series: 4, reps: '8-12', rest: '60s', notes: 'Back strength and density' },
                    { name: 'Band Face Pulls', series: 3, reps: '15-20', rest: '45s', notes: 'Shoulder health and posture' },
                    { name: 'Pilates Bar Bicep Curl', series: 3, reps: '12-15', rest: '45s', notes: 'Step on band for resistance' },
                    { name: 'Wrist Flexion (Palms up)', series: 3, reps: '15-20', rest: '30s', notes: 'Joint health, with pilates bar' }
                ]
            }
        },
        GLUTES_CORE: {
            title: () => t('glutesCore'),
            hasGuide: false,
            description: () => t('posteriorChainAbs'),
            details: {
                exercises: [
                    { name: 'Pull Through', series: 4, reps: '15-20', rest: '60s', notes: 'Low anchor, focus on glutes' },
                    { name: 'Banded Lateral Walk', series: 3, reps: '12 steps/side', rest: '45s', notes: 'Band on knees or ankles' },
                    { name: 'Pilates Bar Russian Twists', series: 3, reps: '20 twists', rest: '45s', notes: 'Hold the bar, twist the torso' },
                    { name: 'Plank', series: 3, reps: '45-75s', rest: '60s', notes: 'Keep body straight' },
                    { name: 'Bird-Dog', series: 3, reps: '12/side', rest: '30s', notes: 'Slow and controlled movement' }
                ]
            }
        },
        METABOLIC: {
            title: () => t('metabolic'),
            hasGuide: false,
            description: () => t('fatBurningCardio'),
            details: {
                exercises: [
                    { name: 'Pilates Bar Thrusters', series: '4 Rounds', reps: '15', rest: '15s', notes: 'Squat + Shoulder Press' },
                    { name: 'Fast Band Rows', series: '4 Rounds', reps: '20', rest: '15s', notes: 'Fast and steady pace' },
                    { name: 'Lunge with Twist', series: '4 Rounds', reps: '10/side', rest: '15s', notes: 'With pilates bar' },
                    { name: 'Jumping Jacks', series: '4 Rounds', reps: '45s', rest: '90s', notes: 'Long rest at the end of the round' }
                ]
            }
        },
        YOGA_REST: { 
            title: () => t('yoga'), 
            description: () => t('recoveryYoga')
        },
        REST: { 
            title: () => t('rest'), 
            description: () => t('recoveryGrowth')
        }
    };

    const guides = {
        LEGS: {
            title: { en: 'Visual Guide: Legs & Ankles', es: 'Gu√≠a Visual: Piernas y Tobillos' },
            content: function() {
                const lang = currentLanguage;
                const content = {
                    en: `
                        <div class="space-y-6">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-accent mb-2">ü¶µ Legs & Ankles Training Guide</h2>
                                <p class="text-secondary">Complete leg and ankle stability training for maximum strength and joint health</p>
                            </div>

                            <!-- Pilates Bar Squat -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">1. Pilates Bar Squat</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Form Steps:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Step on band with both feet, hip-width apart</li>
                                            <li>Hold pilates bar across shoulders (behind neck)</li>
                                            <li>Keep chest up and core engaged</li>
                                            <li>Bend knees and hips, lower to parallel (thighs parallel to floor)</li>
                                            <li>Knees track over toes (don't cave inward)</li>
                                            <li>Drive through heels to stand</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Pro Tips:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Chest upright throughout - no forward lean</li>
                                            <li>‚úì Weight in heels, not toes</li>
                                            <li>‚úì Full depth: hips below knees</li>
                                            <li>‚úì Band tension increases resistance</li>
                                            <li>‚úó Avoid: Knees caving inward</li>
                                            <li>‚úó Avoid: Heels lifting off ground</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ Muscles:</p>
                                        <p class="text-accent font-bold">Quads, Glutes, Hamstrings</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipment:</p>
                                        <p class="text-accent font-bold">Pilates Bar, Band</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Dumbbell Romanian Deadlift -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">2. Dumbbell Romanian Deadlift</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Form Steps:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Stand with feet hip-width apart</li>
                                            <li>Hold dumbbells in front of thighs</li>
                                            <li>Slight bend in knees (not locked)</li>
                                            <li>Hinge at hips, lower weight down legs</li>
                                            <li>Feel stretch in hamstrings at bottom</li>
                                            <li>Drive hips forward to return to standing</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Pro Tips:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Keep back straight - slight natural curve</li>
                                            <li>‚úì Dumbbells stay close to legs</li>
                                            <li>‚úì Feel hamstring stretch at bottom</li>
                                            <li>‚úì Hip hinge is key, not bending knees</li>
                                            <li>‚úó Avoid: Rounding lower back</li>
                                            <li>‚úó Avoid: Bending knees too much</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ Muscles:</p>
                                        <p class="text-accent font-bold">Hamstrings, Glutes, Lower Back</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipment:</p>
                                        <p class="text-accent font-bold">Dumbbells</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Static Lunge (Ankle Focus) -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">3. Static Lunge (Ankle Focus)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Form Steps:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Stand with feet together</li>
                                            <li>Step forward with one leg</li>
                                            <li>Lower until both knees are at 90¬∞</li>
                                            <li>Front knee aligned directly above ankle</li>
                                            <li>Back knee hovers just above ground</li>
                                            <li>Keep torso upright, focus on ankle stability</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Pro Tips:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Front knee tracks over toes</li>
                                            <li>‚úì Balance weight between both legs</li>
                                            <li>‚úì Activate ankle stabilizers</li>
                                            <li>‚úì Control during descent and ascent</li>
                                            <li>‚úó Avoid: Front knee past toes</li>
                                            <li>‚úó Avoid: Leaning forward</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ Muscles:</p>
                                        <p class="text-accent font-bold">Quads, Glutes, Ankle Stabilizers</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipment:</p>
                                        <p class="text-accent font-bold">Bodyweight</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Banded Glute Bridge -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">4. Banded Glute Bridge</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Form Steps:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Lie on back, knees bent, feet flat</li>
                                            <li>Place band above knees</li>
                                            <li>Push knees outward against band</li>
                                            <li>Drive through heels, lift hips</li>
                                            <li>Squeeze glutes hard at top</li>
                                            <li>Lower hips with control</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Pro Tips:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Maintain tension on band throughout</li>
                                            <li>‚úì Squeeze glutes - don't use lower back</li>
                                            <li>‚úì Knees push against band all movement</li>
                                            <li>‚úì Full glute contraction at top</li>
                                            <li>‚úó Avoid: Lower back hyperextending</li>
                                            <li>‚úó Avoid: Losing band tension</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ Muscles:</p>
                                        <p class="text-accent font-bold">Glutes, Hamstrings, Core</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipment:</p>
                                        <p class="text-accent font-bold">Band, Mat</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Calf Raises (Ankle Focus) -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">5. Calf Raises (Ankle Focus)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Form Steps:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Hold pilates bar for balance</li>
                                            <li>Stand with feet hip-width apart</li>
                                            <li>Rise up on toes, lifting heels high</li>
                                            <li>Pause briefly at the top</li>
                                            <li>Lower heels back to ground slowly</li>
                                            <li>Focus on ankle control and stability</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Pro Tips:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Full range: heels up, then fully down</li>
                                            <li>‚úì Move through ankle joint only</li>
                                            <li>‚úì Controlled pace - not bouncy</li>
                                            <li>‚úì Balance on balls of feet</li>
                                            <li>‚úó Avoid: Bouncing at bottom</li>
                                            <li>‚úó Avoid: Turning feet inward/outward</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ Muscles:</p>
                                        <p class="text-accent font-bold">Calves, Ankles</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipment:</p>
                                        <p class="text-accent font-bold">Pilates Bar</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Banded Lateral Walk -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">6. Banded Lateral Walk</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Form Steps:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Place band above knees or at ankles</li>
                                            <li>Stand with feet hip-width apart</li>
                                            <li>Slight bend in knees and hips</li>
                                            <li>Maintain tension on band</li>
                                            <li>Step to side, keeping band tight</li>
                                            <li>Alternate directions for reps</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Pro Tips:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Keep knees bent throughout</li>
                                            <li>‚úì Never let knees cave inward</li>
                                            <li>‚úì Push against band each step</li>
                                            <li>‚úì Controlled, deliberate steps</li>
                                            <li>‚úó Avoid: Standing upright - bend knees</li>
                                            <li>‚úó Avoid: Band going slack</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ Muscles:</p>
                                        <p class="text-accent font-bold">Glutes, Hip Abductors</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipment:</p>
                                        <p class="text-accent font-bold">Resistance Band</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-accent/10 border border-accent/30 rounded-lg p-6 mt-8">
                                <h4 class="font-bold text-accent mb-2">‚ö° Key Takeaways:</h4>
                                <ul class="space-y-2 text-secondary text-sm">
                                    <li>üéØ <strong>Ankle Stability:</strong> Focus on controlled movements and body awareness</li>
                                    <li>üí™ <strong>Progressive Overload:</strong> Gradually increase band resistance or add weight</li>
                                    <li>üîÑ <strong>Full Range:</strong> Complete every rep with full range of motion</li>
                                    <li>‚è±Ô∏è <strong>Tempo:</strong> Control descent - 2-3 seconds down, 1 second up</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    es: `
                        <div class="space-y-6">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-accent mb-2">ü¶µ Gu√≠a de Entrenamiento: Piernas y Tobillos</h2>
                                <p class="text-secondary">Entrenamiento completo de piernas y estabilidad de tobillos para m√°xima fuerza y salud articular</p>
                            </div>

                            <!-- Sentadilla con Barra Pilates -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">1. Sentadilla con Barra Pilates</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Pasos de Forma:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>P√°rate sobre la banda, pies a ancho de cadera</li>
                                            <li>Sost√©n la barra pilates sobre los hombros (detr√°s del cuello)</li>
                                            <li>Mant√©n pecho arriba y core contra√≠do</li>
                                            <li>Dobla rodillas y caderas, baja a paralelo (muslos paralelos al suelo)</li>
                                            <li>Las rodillas siguen los dedos (no colapsen hacia adentro)</li>
                                            <li>Empuja desde los talones para incorporarte</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Consejos Pro:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Pecho erguido durante todo el movimiento - sin inclinarte</li>
                                            <li>‚úì Peso en los talones, no en los dedos</li>
                                            <li>‚úì Profundidad completa: caderas debajo de rodillas</li>
                                            <li>‚úì La tensi√≥n de la banda aumenta la resistencia</li>
                                            <li>‚úó Evita: Rodillas colapsando hacia adentro</li>
                                            <li>‚úó Evita: Talones levant√°ndose del suelo</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ M√∫sculos:</p>
                                        <p class="text-accent font-bold">Cu√°driceps, Gl√∫teos, Isquiotibiales</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipamiento:</p>
                                        <p class="text-accent font-bold">Barra Pilates, Banda</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Peso Muerto Rumano -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">2. Peso Muerto Rumano con Mancernas</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Pasos de Forma:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>P√°rate con pies a ancho de cadera</li>
                                            <li>Sost√©n mancernas frente a los muslos</li>
                                            <li>Ligero doblez en rodillas (no bloqueadas)</li>
                                            <li>Bisagra desde las caderas, baja el peso bajando las piernas</li>
                                            <li>Siente el estiramiento en los isquiotibiales al fondo</li>
                                            <li>Empuja las caderas hacia adelante para incorporarte</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Consejos Pro:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Mant√©n espalda recta - ligera curva natural</li>
                                            <li>‚úì Mancernas cerca de las piernas</li>
                                            <li>‚úì Siente el estiramiento de isquiotibiales al fondo</li>
                                            <li>‚úì La bisagra de cadera es clave, no doblar rodillas</li>
                                            <li>‚úó Evita: Redondear la espalda baja</li>
                                            <li>‚úó Evita: Doblar rodillas demasiado</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ M√∫sculos:</p>
                                        <p class="text-accent font-bold">Isquiotibiales, Gl√∫teos, Espalda Baja</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipamiento:</p>
                                        <p class="text-accent font-bold">Mancernas</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Estocada Est√°tica -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">3. Estocada Est√°tica (Enfoque en Tobillo)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Pasos de Forma:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>P√°rate con pies juntos</li>
                                            <li>Da un paso adelante con una pierna</li>
                                            <li>Baja hasta que ambas rodillas est√©n a 90¬∞</li>
                                            <li>Rodilla frontal alineada directamente sobre el tobillo</li>
                                            <li>Rodilla trasera flota justo sobre el suelo</li>
                                            <li>Mant√©n torso erguido, enf√≥cate en la estabilidad del tobillo</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Consejos Pro:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Rodilla frontal sigue los dedos del pie</li>
                                            <li>‚úì Equilibra peso entre ambas piernas</li>
                                            <li>‚úì Activa los estabilizadores del tobillo</li>
                                            <li>‚úì Controla el descenso y ascenso</li>
                                            <li>‚úó Evita: Rodilla frontal pasando los dedos</li>
                                            <li>‚úó Evita: Inclinarse hacia adelante</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ M√∫sculos:</p>
                                        <p class="text-accent font-bold">Cu√°driceps, Gl√∫teos, Estabilizadores de Tobillo</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipamiento:</p>
                                        <p class="text-accent font-bold">Peso Corporal</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Puente de Gl√∫teos con Banda -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">4. Puente de Gl√∫teos con Banda</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Pasos de Forma:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Acu√©state de espaldas, rodillas dobladas, pies planos</li>
                                            <li>Coloca banda sobre las rodillas</li>
                                            <li>Empuja rodillas hacia afuera contra la banda</li>
                                            <li>Empuja a trav√©s de los talones, levanta caderas</li>
                                            <li>Aprieta gl√∫teos fuertemente en la parte superior</li>
                                            <li>Baja caderas con control</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Consejos Pro:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Mant√©n tensi√≥n en la banda durante todo el movimiento</li>
                                            <li>‚úì Aprieta gl√∫teos - no uses espalda baja</li>
                                            <li>‚úì Las rodillas empujan contra la banda todo el tiempo</li>
                                            <li>‚úì Contracci√≥n completa de gl√∫teos en la parte superior</li>
                                            <li>‚úó Evita: Hiperextensi√≥n de espalda baja</li>
                                            <li>‚úó Evita: Perder tensi√≥n de la banda</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ M√∫sculos:</p>
                                        <p class="text-accent font-bold">Gl√∫teos, Isquiotibiales, Core</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipamiento:</p>
                                        <p class="text-accent font-bold">Banda, Tapete</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Elevaciones de Pantorrilla -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">5. Elevaciones de Pantorrilla (Enfoque en Tobillo)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Pasos de Forma:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Sost√©n la barra pilates para equilibrio</li>
                                            <li>P√°rate con pies a ancho de cadera</li>
                                            <li>Lev√°ntate sobre los dedos, eleva talones alto</li>
                                            <li>Pausa brevemente en la parte superior</li>
                                            <li>Baja talones al suelo lentamente</li>
                                            <li>Enf√≥cate en el control y estabilidad del tobillo</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Consejos Pro:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Rango completo: talones arriba, luego completamente abajo</li>
                                            <li>‚úì Mu√©vete solo a trav√©s de la articulaci√≥n del tobillo</li>
                                            <li>‚úì Ritmo controlado - no rebotes</li>
                                            <li>‚úì Equilibrio sobre la parte anterior del pie</li>
                                            <li>‚úó Evita: Rebotar en la parte inferior</li>
                                            <li>‚úó Evita: Girar los pies hacia adentro/afuera</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ M√∫sculos:</p>
                                        <p class="text-accent font-bold">Pantorrillas, Tobillos</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipamiento:</p>
                                        <p class="text-accent font-bold">Barra Pilates</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Caminata Lateral con Banda -->
                            <div class="bg-card-bg/60 border border-accent/30 rounded-lg p-6">
                                <h3 class="text-2xl font-bold text-accent mb-4">6. Caminata Lateral con Banda</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üìã Pasos de Forma:</h4>
                                        <ol class="list-decimal list-inside space-y-2 text-secondary text-sm">
                                            <li>Coloca banda sobre rodillas o tobillos</li>
                                            <li>P√°rate con pies a ancho de cadera</li>
                                            <li>Ligero doblez en rodillas y caderas</li>
                                            <li>Mant√©n tensi√≥n en la banda</li>
                                            <li>Da un paso al lado, mant√©n la banda tensa</li>
                                            <li>Alterna direcciones para las repeticiones</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-primary mb-2">üí° Consejos Pro:</h4>
                                        <ul class="space-y-2 text-secondary text-sm">
                                            <li>‚úì Mant√©n rodillas dobladas durante todo</li>
                                            <li>‚úì Nunca dejes que las rodillas colapsen hacia adentro</li>
                                            <li>‚úì Empuja contra la banda en cada paso</li>
                                            <li>‚úì Pasos controlados y deliberados</li>
                                            <li>‚úó Evita: Estar erguido - dobla rodillas</li>
                                            <li>‚úó Evita: La banda afloj√°ndose</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">üí™ M√∫sculos:</p>
                                        <p class="text-accent font-bold">Gl√∫teos, Abductores de Cadera</p>
                                    </div>
                                    <div class="bg-black/30 p-3 rounded">
                                        <p class="text-secondary text-sm">‚öôÔ∏è Equipamiento:</p>
                                        <p class="text-accent font-bold">Banda de Resistencia</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-accent/10 border border-accent/30 rounded-lg p-6 mt-8">
                                <h4 class="font-bold text-accent mb-2">‚ö° Puntos Clave:</h4>
                                <ul class="space-y-2 text-secondary text-sm">
                                    <li>üéØ <strong>Estabilidad de Tobillo:</strong> Enf√≥cate en movimientos controlados y conciencia corporal</li>
                                    <li>üí™ <strong>Sobrecarga Progresiva:</strong> Aumenta gradualmente la resistencia de la banda o agrega peso</li>
                                    <li>üîÑ <strong>Rango Completo:</strong> Completa cada repetici√≥n con rango completo de movimiento</li>
                                    <li>‚è±Ô∏è <strong>Tempo:</strong> Controla el descenso - 2-3 segundos abajo, 1 segundo arriba</li>
                                </ul>
                            </div>
                        </div>
                    `
                };
                return content[lang] || content.en;
            }
        }
    };
    
    // --- Comprehensive Exercise Library ---
    const exerciseLibrary = {
        'Dumbbell Bench Press': {
            category: 'Chest',
            equipment: 'üèãÔ∏è Dumbbells',
            difficulty: 'Intermediate',
            form: [
                '1. Lie flat on a bench (or floor for home gym)',
                '2. Hold dumbbells at chest level, elbows at 90¬∞',
                '3. Press dumbbells upward until arms are extended',
                '4. Lower back to chest with control',
                '5. Keep your core engaged and back flat'
            ],
            tips: [
                '‚úì Elbows should be at ~75¬∞ angle from body',
                '‚úì Full range of motion: chest to full extension',
                '‚úì Breathe out on press, in on lower',
                '‚úó Avoid: Bouncing or rushing the movement',
                '‚úó Avoid: Elbows too wide (risk of injury)'
            ],
            muscleGroups: ['Chest', 'Triceps', 'Shoulders'],
            source: 'ACE (American Council on Exercise)'
        },
        'Pilates Bar Shoulder Press': {
            category: 'Shoulders',
            equipment: 'üéØ Pilates Bar + Resistance Band',
            difficulty: 'Beginner',
            form: [
                '1. Stand with feet shoulder-width apart',
                '2. Step on band with both feet (for resistance)',
                '3. Hold pilates bar at shoulder height',
                '4. Press bar overhead until arms extend',
                '5. Lower back to shoulder height with control',
                '6. Keep core engaged throughout'
            ],
            tips: [
                '‚úì Keep wrists neutral and stable',
                '‚úì Press straight overhead, not forward',
                '‚úì Maintain good posture - no arching',
                '‚úó Avoid: Using momentum to press',
                '‚úó Avoid: Pressing too far forward'
            ],
            muscleGroups: ['Shoulders', 'Triceps', 'Core'],
            source: 'NASM (National Academy of Sports Medicine)'
        },
        'Band Flys': {
            category: 'Chest',
            equipment: 'üü∞ Resistance Bands',
            difficulty: 'Beginner',
            form: [
                '1. Attach band at chest height to door anchor',
                '2. Stand with side to anchor, hold band',
                '3. Extend arm straight out to side',
                '4. Bring arm across body in a hugging motion',
                '5. Slow and controlled - no swinging',
                '6. Return to starting position'
            ],
            tips: [
                '‚úì Keep slight bend in elbow throughout',
                '‚úì Move only at shoulder joint',
                '‚úì Squeeze chest at end of movement',
                '‚úó Avoid: Locking elbow straight',
                '‚úó Avoid: Using momentum or swinging'
            ],
            muscleGroups: ['Chest', 'Front Shoulders'],
            source: 'ACE Fitness'
        },
        'Dumbbell Lateral Raises': {
            category: 'Shoulders',
            equipment: 'üèãÔ∏è Dumbbells',
            difficulty: 'Beginner',
            form: [
                '1. Stand with feet hip-width apart',
                '2. Hold dumbbells at sides with slight bend in elbows',
                '3. Raise dumbbells out to sides to shoulder height',
                '4. Slight bend at elbow - not locked',
                '5. Lower with control back to starting position'
            ],
            tips: [
                '‚úì Elbow should be slightly higher than hand',
                '‚úì Move slowly - avoid momentum',
                '‚úì Full range from hip to shoulder height',
                '‚úó Avoid: Swinging the weights',
                '‚úó Avoid: Raising above shoulder height'
            ],
            muscleGroups: ['Lateral Shoulders', 'Upper Back'],
            source: 'ISSA (International Sports Sciences Association)'
        },
        'Band Triceps Pushdowns': {
            category: 'Triceps',
            equipment: 'üü∞ Resistance Band + Door Anchor',
            difficulty: 'Beginner',
            form: [
                '1. Attach band high on door',
                '2. Face away from door, hold band at chest',
                '3. Keep elbows at 90¬∞ angle close to body',
                '4. Push band down until arms are extended',
                '5. Hold briefly at bottom',
                '6. Return to chest level with control'
            ],
            tips: [
                '‚úì Elbows stay close to ribs throughout',
                '‚úì Only elbow joint moves - no shoulder',
                '‚úì Squeeze triceps at bottom',
                '‚úó Avoid: Letting elbows flare out',
                '‚úó Avoid: Using back muscles for movement'
            ],
            muscleGroups: ['Triceps'],
            source: 'NASM'
        },
        'Wrist Extension (Palms down)': {
            category: 'Forearms',
            equipment: 'üéØ Pilates Bar',
            difficulty: 'Beginner',
            form: [
                '1. Sit or stand with forearm flat on table',
                '2. Hold pilates bar with palm facing down',
                '3. Hand extends just past table edge',
                '4. Lift bar by extending wrist upward',
                '5. Lower back down with control',
                '6. Keep forearm flat throughout'
            ],
            tips: [
                '‚úì Move only at wrist joint',
                '‚úì Full range: curl up then extend down',
                '‚úì Use light weight for proper form',
                '‚úó Avoid: Moving forearm or elbow',
                '‚úó Avoid: Jerky movements'
            ],
            muscleGroups: ['Forearm Extensors', 'Wrist'],
            source: 'ACE Fitness'
        },
        'Pilates Bar Squat': {
            category: 'Legs',
            equipment: 'üéØ Pilates Bar + Resistance Band',
            difficulty: 'Intermediate',
            form: [
                '1. Step on band with both feet, hip-width apart',
                '2. Hold pilates bar across shoulders (behind neck)',
                '3. Keep chest up and core engaged',
                '4. Bend knees and hips, lower to parallel',
                '5. Knees track over toes',
                '6. Drive through heels to stand'
            ],
            tips: [
                '‚úì Keep chest upright throughout',
                '‚úì Weight in heels, not toes',
                '‚úì Full depth: hips below knees',
                '‚úó Avoid: Knees caving inward',
                '‚úó Avoid: Heels lifting off ground'
            ],
            muscleGroups: ['Quads', 'Glutes', 'Hamstrings'],
            source: 'ACE Fitness'
        },
        'Dumbbell Romanian Deadlift': {
            category: 'Hamstrings',
            equipment: 'üèãÔ∏è Dumbbells',
            difficulty: 'Intermediate',
            form: [
                '1. Stand with feet hip-width apart',
                '2. Hold dumbbells in front of thighs',
                '3. Slight bend in knees (not locked)',
                '4. Hinge at hips, lowering weight down legs',
                '5. Feel stretch in hamstrings',
                '6. Drive hips forward to return to standing'
            ],
            tips: [
                '‚úì Keep back straight - slight curve natural',
                '‚úì Dumbbells stay close to legs',
                '‚úì Feel hamstring stretch at bottom',
                '‚úó Avoid: Rounding lower back',
                '‚úó Avoid: Bending knees too much'
            ],
            muscleGroups: ['Hamstrings', 'Glutes', 'Lower Back'],
            source: 'NASM'
        },
        'Static Lunge (Ankle Focus)': {
            category: 'Legs',
            equipment: 'üõèÔ∏è Mat/Floor',
            difficulty: 'Intermediate',
            form: [
                '1. Stand with feet together',
                '2. Step forward with one leg',
                '3. Both knees bend to 90¬∞',
                '4. Front knee aligned with ankle',
                '5. Back knee hovers just above ground',
                '6. Keep torso upright, focus on ankle stability'
            ],
            tips: [
                '‚úì Front knee tracks over toes',
                '‚úì Keep weight balanced between legs',
                '‚úì Activate ankle stabilizers',
                '‚úó Avoid: Front knee past toes',
                '‚úó Avoid: Leaning forward'
            ],
            muscleGroups: ['Quads', 'Glutes', 'Ankle Stabilizers'],
            source: 'NASM'
        },
        'Banded Glute Bridge': {
            category: 'Glutes',
            equipment: 'üü∞ Resistance Band + Mat',
            difficulty: 'Beginner',
            form: [
                '1. Lie on back, knees bent, feet flat',
                '2. Place band above knees',
                '3. Push knees outward against band',
                '4. Drive through heels, lift hips',
                '5. Squeeze glutes at top',
                '6. Lower hips with control'
            ],
            tips: [
                '‚úì Maintain tension on band throughout',
                '‚úì Squeeze glutes - don\'t use lower back',
                '‚úì Knees push against band all movement',
                '‚úó Avoid: Lower back hyperextending',
                '‚úó Avoid: Losing band tension'
            ],
            muscleGroups: ['Glutes', 'Hamstrings', 'Core'],
            source: 'ACE Fitness'
        },
        'Calf Raises (Ankle Focus)': {
            category: 'Calves',
            equipment: 'üéØ Pilates Bar',
            difficulty: 'Beginner',
            form: [
                '1. Hold pilates bar for balance',
                '2. Stand with feet hip-width apart',
                '3. Rise up on toes, lifting heels high',
                '4. Pause briefly at the top',
                '5. Lower heels back to ground',
                '6. Focus on ankle control and stability'
            ],
            tips: [
                '‚úì Full range: heels up, then fully down',
                '‚úì Move through ankle joint only',
                '‚úì Controlled pace - not bouncy',
                '‚úó Avoid: Bouncing at bottom',
                '‚úó Avoid: Turning feet inward/outward'
            ],
            muscleGroups: ['Calves', 'Ankle'],
            source: 'ACE Fitness'
        },
        'Pilates Bar Lat Pulldown': {
            category: 'Back',
            equipment: 'üéØ Pilates Bar + Door Anchor',
            difficulty: 'Beginner',
            form: [
                '1. Attach band at top of door',
                '2. Hold pilates bar with hands shoulder-width',
                '3. Sit with knees bent, feet flat',
                '4. Pull bar down to chest level',
                '5. Keep elbows pointing down',
                '6. Return with control'
            ],
            tips: [
                '‚úì Elbows follow straight path downward',
                '‚úì Pull elbows back and down',
                '‚úì Squeeze back muscles at bottom',
                '‚úó Avoid: Pulling bar too far down',
                '‚úó Avoid: Using arms instead of back'
            ],
            muscleGroups: ['Lats', 'Back', 'Biceps'],
            source: 'NASM'
        },
        'Dumbbell Bent-Over Row': {
            category: 'Back',
            equipment: 'üèãÔ∏è Dumbbells',
            difficulty: 'Intermediate',
            form: [
                '1. Stand with feet hip-width apart',
                '2. Hold dumbbells at sides',
                '3. Hinge at hips, back nearly parallel to floor',
                '4. Pull dumbbells to rib cage',
                '5. Squeeze back muscles at top',
                '6. Lower dumbbells with control'
            ],
            tips: [
                '‚úì Keep back straight - engaged core',
                '‚úì Pull elbows close to body',
                '‚úì Full range from hang to chest',
                '‚úó Avoid: Rounding lower back',
                '‚úó Avoid: Using momentum'
            ],
            muscleGroups: ['Back', 'Lats', 'Biceps'],
            source: 'ACE Fitness'
        },
        'Band Face Pulls': {
            category: 'Shoulders',
            equipment: 'üü∞ Resistance Band + Door Anchor',
            difficulty: 'Beginner',
            form: [
                '1. Attach band at face height on door',
                '2. Stand facing door, hold band',
                '3. Pull band toward face/head',
                '4. Elbows stay high and flared',
                '5. Pause briefly at end',
                '6. Return with control'
            ],
            tips: [
                '‚úì Elbows high - at or above shoulder',
                '‚úì Rotate hands outward at end',
                '‚úì Squeeze rear shoulders and upper back',
                '‚úó Avoid: Pulling down instead of to face',
                '‚úó Avoid: Letting elbows drop'
            ],
            muscleGroups: ['Rear Shoulders', 'Upper Back'],
            source: 'NASM'
        },
        'Pilates Bar Bicep Curl': {
            category: 'Biceps',
            equipment: 'üéØ Pilates Bar + Resistance Band',
            difficulty: 'Beginner',
            form: [
                '1. Stand with feet hip-width apart',
                '2. Step on band with both feet',
                '3. Hold pilates bar, arms extended',
                '4. Bend elbows, curl bar to shoulders',
                '5. Squeeze biceps at top',
                '6. Lower with control'
            ],
            tips: [
                '‚úì Keep elbows close to body',
                '‚úì Only elbow joint moves',
                '‚úì Full range: extended to shoulders',
                '‚úó Avoid: Swinging or using momentum',
                '‚úó Avoid: Elbows flaring out'
            ],
            muscleGroups: ['Biceps', 'Forearms'],
            source: 'ACE Fitness'
        },
        'Wrist Flexion (Palms up)': {
            category: 'Forearms',
            equipment: 'üéØ Pilates Bar',
            difficulty: 'Beginner',
            form: [
                '1. Sit with forearm flat on table',
                '2. Hold pilates bar with palm facing up',
                '3. Hand extends just past table edge',
                '4. Curl wrist upward',
                '5. Lower back down with control',
                '6. Keep forearm flat throughout'
            ],
            tips: [
                '‚úì Move only at wrist joint',
                '‚úì Full range: down then up fully',
                '‚úì Use light weight for control',
                '‚úó Avoid: Moving forearm or elbow',
                '‚úó Avoid: Bouncing at bottom'
            ],
            muscleGroups: ['Forearm Flexors', 'Wrist'],
            source: 'ACE Fitness'
        },
        'Pull Through': {
            category: 'Glutes',
            equipment: 'üîî Kettlebell + Cable Anchor (Low)',
            difficulty: 'Intermediate',
            form: [
                '1. Attach band low on door or anchor',
                '2. Stand facing away, hold band between legs',
                '3. Feet hip-width apart, slight bend in knees',
                '4. Hinge at hips, push band between legs',
                '5. Drive hips forward',
                '6. Return to standing'
            ],
            tips: [
                '‚úì Power comes from hips, not arms',
                '‚úì Keep core engaged throughout',
                '‚úì Full hip extension at top',
                '‚úó Avoid: Rounding lower back',
                '‚úó Avoid: Using arms to pull'
            ],
            muscleGroups: ['Glutes', 'Hamstrings', 'Lower Back'],
            source: 'NASM'
        },
        'Banded Lateral Walk': {
            category: 'Glutes',
            equipment: 'üü∞ Resistance Band',
            difficulty: 'Beginner',
            form: [
                '1. Place band above knees or at ankles',
                '2. Stand with feet hip-width apart',
                '3. Slight bend in knees and hips',
                '4. Maintain tension on band',
                '5. Step to side, keeping band tight',
                '6. Alternate directions'
            ],
            tips: [
                '‚úì Keep knees bent throughout',
                '‚úì Never let knees cave inward',
                '‚úì Push against band each step',
                '‚úó Avoid: Standing upright - bend knees',
                '‚úó Avoid: Band going slack'
            ],
            muscleGroups: ['Glutes', 'Hip Abductors'],
            source: 'ACE Fitness'
        },
        'Pilates Bar Russian Twists': {
            category: 'Core',
            equipment: 'üéØ Pilates Bar',
            difficulty: 'Intermediate',
            form: [
                '1. Sit on floor with knees bent',
                '2. Lean back slightly (45¬∞ angle)',
                '3. Hold pilates bar with hands',
                '4. Rotate torso left, tap bar to ground',
                '5. Rotate to right, tap to ground',
                '6. Keep core engaged throughout'
            ],
            tips: [
                '‚úì Rotation comes from abs, not arms',
                '‚úì Keep chest up - don\'t slouch',
                '‚úì Move with control, not speed',
                '‚úó Avoid: Jerking or bouncing',
                '‚úó Avoid: Over-rotating too far'
            ],
            muscleGroups: ['Obliques', 'Core'],
            source: 'NASM'
        },
        'Plank': {
            category: 'Core',
            equipment: 'üõèÔ∏è Mat/Floor',
            difficulty: 'Beginner',
            form: [
                '1. Get into push-up position',
                '2. Lower to forearms, elbows under shoulders',
                '3. Body in straight line from head to heels',
                '4. Engage core throughout',
                '5. Hold position without sagging hips',
                '6. Breathe steadily - don\'t hold breath'
            ],
            tips: [
                '‚úì Hips level with body - not sagging',
                '‚úì Shoulders over elbows',
                '‚úì Core squeezed tight',
                '‚úó Avoid: Hips dropping or rising',
                '‚úó Avoid: Holding breath'
            ],
            muscleGroups: ['Core', 'Shoulders', 'Back'],
            source: 'ACE Fitness'
        },
        'Bird-Dog': {
            category: 'Core',
            equipment: 'üõèÔ∏è Mat/Floor',
            difficulty: 'Beginner',
            form: [
                '1. Start on hands and knees',
                '2. Shoulders over hands, hips over knees',
                '3. Extend opposite arm and leg',
                '4. Hold briefly - maintain balance',
                '5. Return slowly to start',
                '6. Alternate sides'
            ],
            tips: [
                '‚úì Keep body aligned - no rotation',
                '‚úì Move slowly and controlled',
                '‚úì Squeeze core for stability',
                '‚úó Avoid: Rotating hips or shoulders',
                '‚úó Avoid: Moving too quickly'
            ],
            muscleGroups: ['Core', 'Lower Back', 'Glutes'],
            source: 'NASM'
        },
        'Pilates Bar Thrusters': {
            category: 'Full Body',
            equipment: 'üéØ Pilates Bar + Resistance Band',
            difficulty: 'Advanced',
            form: [
                '1. Stand on band with feet shoulder-width',
                '2. Hold bar at shoulder height',
                '3. Squat down to parallel',
                '4. Drive through heels, stand up',
                '5. Press bar overhead in one motion',
                '6. Return bar to shoulders'
            ],
            tips: [
                '‚úì Squat and press as one fluid motion',
                '‚úì Drive power from legs through upper body',
                '‚úì Full extension overhead',
                '‚úó Avoid: Pressing without full leg drive',
                '‚úó Avoid: Incomplete squat depth'
            ],
            muscleGroups: ['Quads', 'Shoulders', 'Full Body'],
            source: 'CrossFit'
        },
        'Fast Band Rows': {
            category: 'Back',
            equipment: 'üü∞ Resistance Band + Door Anchor',
            difficulty: 'Intermediate',
            form: [
                '1. Attach band at chest height on door',
                '2. Stand facing door, hold band',
                '3. Arms extended in front',
                '4. Quickly pull band to chest',
                '5. Squeeze back hard',
                '6. Quick controlled return'
            ],
            tips: [
                '‚úì Speed is controlled, not wild',
                '‚úì Elbows pull close to body',
                '‚úì Explosive pull, controlled release',
                '‚úó Avoid: Excessive momentum',
                '‚úó Avoid: Sloppy form for speed'
            ],
            muscleGroups: ['Back', 'Lats', 'Biceps'],
            source: 'NASM'
        },
        'Lunge with Twist': {
            category: 'Full Body',
            equipment: 'üéØ Pilates Bar',
            difficulty: 'Intermediate',
            form: [
                '1. Step forward into lunge position',
                '2. Both knees at 90¬∞',
                '3. Hold pilates bar at chest',
                '4. Rotate torso over front leg',
                '5. Feel core and leg engagement',
                '6. Return to center and step back'
            ],
            tips: [
                '‚úì Controlled lunge first, then twist',
                '‚úì Twist from core, not arms',
                '‚úì Keep front knee aligned',
                '‚úó Avoid: Twisting before stable in lunge',
                '‚úó Avoid: Front knee past toes'
            ],
            muscleGroups: ['Quads', 'Core', 'Glutes'],
            source: 'NASM'
        },
        'Jumping Jacks': {
            category: 'Cardio',
            equipment: 'üõèÔ∏è Space',
            difficulty: 'Beginner',
            form: [
                '1. Stand with feet together, arms at sides',
                '2. Jump up while spreading feet shoulder-width',
                '3. Simultaneously raise arms to shoulder height',
                '4. Jump back to starting position',
                '5. Lower arms to sides',
                '6. Repeat in continuous motion'
            ],
            tips: [
                '‚úì Land on balls of feet for cushioning',
                '‚úì Keep core engaged',
                '‚úì Smooth, rhythmic movement',
                '‚úó Avoid: Slamming feet when landing',
                '‚úó Avoid: Incomplete arm raises'
            ],
            muscleGroups: ['Full Body', 'Cardio'],
            source: 'ACE Fitness'
        }
    };
    
    function generateExerciseLibrary() {
        const container = document.getElementById('exercise-library');
        let html = '<div class="space-y-4">';
        
        for (const [name, data] of Object.entries(exerciseLibrary)) {
            html += `
                <div class="bg-card-bg/80 rounded-lg border border-border p-4 sm:p-6 hover:border-accent transition">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-accent mb-2">${name}</h3>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="px-3 py-1 bg-accent/20 text-accent text-xs font-semibold rounded-full">${data.category}</span>
                                <span class="px-3 py-1 bg-metabolic/20 text-metabolic text-xs font-semibold rounded-full">${data.difficulty}</span>
                                <span class="px-3 py-1 bg-blue-500/20 text-blue-400 text-xs font-semibold rounded-full">${data.equipment}</span>
                            </div>
                        </div>
                        <span class="text-xs text-secondary italic">Source: ${data.source}</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-primary mb-3">üìã PROPER FORM:</h4>
                            <ol class="space-y-2">
                                ${data.form.map((step, i) => `<li class="text-secondary text-sm leading-relaxed">${step}</li>`).join('')}
                            </ol>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-primary mb-3">üí° PRO TIPS:</h4>
                            <div class="space-y-2">
                                ${data.tips.map(tip => `<p class="text-secondary text-sm leading-relaxed">${tip}</p>`).join('')}
                            </div>
                            <div class="mt-4 pt-4 border-t border-border">
                                <p class="text-xs text-secondary"><strong>Muscles:</strong> ${data.muscleGroups.join(', ')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // --- Date & Schedule Variables ---
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth(); // 0-11
    const day = today.getDate(); // 1-31
    const dateKey = `${year}-${month + 1}-${day}`; // Firestore document ID

    const LOCAL_STORAGE_KEY = 'ftber_progress';
    const ROUTINES_STORAGE_KEY = 'ftber_routines';
    const LANGUAGE_STORAGE_KEY = 'ftber_language';
    const schedulePattern = ['TORSO_PUSH', 'LEGS_ANKLES', 'YOGA_REST', 'TORSO_PULL', 'GLUTES_CORE', 'METABOLIC', 'REST'];
    const monthlySchedule = {};
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const dayOfWeek = date.getDay(); // 0 for Sunday, 1 for Monday...
        const patternIndex = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; // Adjust to make Monday the start of the week
        monthlySchedule[d] = schedulePattern[patternIndex];
    }

    // --- Language System ---
    const translations = {
        en: {
            today: 'Today',
            stats: 'Stats',
            calendar: 'Calendar',
            routines: 'Routines',
            library: 'Library',
            yoga: 'Yoga',
            weeklyStats: 'Weekly Statistics',
            weeklyCompletion: 'Weekly Completion',
            workoutsDone: 'Workouts Done',
            totalExercises: 'Total Exercises',
            streak: 'Streak',
            daysActive: 'Days active',
            dailyBreakdown: 'Daily Breakdown',
            lastSevenDays: 'Last 7 days',
            thisWeek: 'This week',
            completed: 'Completed',
            exercise: 'Exercise',
            sets: 'Sets',
            reps: 'Reps',
            rest: 'Rest',
            notes: 'Notes',
            done: 'Done',
            edit: 'Edit',
            dailyProgress: 'Daily Progress',
            equipmentNeeded: 'Equipment Needed',
            viewVisualGuide: 'View Visual Guide',
            routineMenu: 'Routine Menu',
            customWorkout: 'Create Custom Workout',
            selectRoutine: 'Select a routine to view',
            editExercise: 'Edit Exercise',
            deleteExercise: 'Delete Exercise',
            save: 'Save',
            cancel: 'Cancel',
            addExercise: 'Add Exercise',
            exerciseLibrary: 'Exercise Library',
            category: 'Category',
            equipment: 'Equipment',
            difficulty: 'Difficulty',
            muscleGroups: 'Muscle Groups',
            formSteps: 'Form Steps',
            proTips: 'Pro Tips',
            dumbbell: 'Dumbbell',
            pilatesBar: 'Pilates Bar',
            band: 'Band',
            kettlebell: 'Kettlebell',
            mat: 'Mat',
            doorAnchor: 'Door Anchor',
            beginner: 'Beginner',
            intermediate: 'Intermediate',
            advanced: 'Advanced',
            chest: 'Chest',
            shoulders: 'Shoulders',
            triceps: 'Triceps',
            back: 'Back',
            biceps: 'Biceps',
            forearms: 'Forearms',
            legs: 'Legs',
            glutes: 'Glutes',
            hamstrings: 'Hamstrings',
            calves: 'Calves',
            core: 'Core',
            push: 'üí™ Push & Wrists',
            legsAnkles: 'ü¶µ Legs & Ankles',
            pull: 'üèãÔ∏è‚Äç‚ôÇÔ∏è Pull & Wrists',
            glutesCore: 'üçë Glutes & Core',
            metabolic: '‚ö° Metabolic Circuit',
            yoga: 'üßò‚Äç‚ôÇÔ∏è Active Rest',
            rest: 'üò¥ Full Rest',
            chestShouldersTricepsStr: 'Chest, shoulders, triceps strength and wrist health.',
            legsGlutesStr: 'Legs, glutes strength and ankle stability.',
            backBicepsStr: 'Back, biceps strength and wrist health.',
            posteriorChainAbs: 'Strengthening the posterior chain and abdomen.',
            fatBurningCardio: 'Fat burning and cardiovascular endurance. Perform as a circuit.',
            recoveryYoga: 'Recovery day with Yoga and mobility. Check the Yoga tab.',
            recoveryGrowth: 'Recovery and Growth. Listen to your body!',
            torso: 'Torso',
            notas: 'Notes',
            exerciseLibraryDesc: 'Complete guide to all exercises with proper form and technique',
            recoveryYogaTitle: 'Recovery Yoga',
            posesComplementTitle: 'Poses to complement your training, improve flexibility, and speed up recovery.',
            weeklyStats: 'Weekly Statistics'
        },
        es: {
            today: 'Hoy',
            stats: 'Estad√≠sticas',
            calendar: 'Calendario',
            routines: 'Rutinas',
            library: 'Biblioteca',
            yoga: 'Yoga',
            weeklyStats: 'Estad√≠sticas Semanales',
            weeklyCompletion: 'Completitud Semanal',
            workoutsDone: 'Entrenamientos Realizados',
            totalExercises: 'Ejercicios Totales',
            streak: 'Racha',
            daysActive: 'D√≠as activos',
            dailyBreakdown: 'Desglose Diario',
            lastSevenDays: '√öltimos 7 d√≠as',
            thisWeek: 'Esta semana',
            completed: 'Completados',
            exercise: 'Ejercicio',
            sets: 'Series',
            reps: 'Repeticiones',
            rest: 'Descanso',
            notes: 'Notas',
            done: 'Hecho',
            edit: 'Editar',
            dailyProgress: 'Progreso Diario',
            equipmentNeeded: 'Equipamiento Necesario',
            viewVisualGuide: 'Ver Gu√≠a Visual',
            routineMenu: 'Men√∫ de Rutinas',
            customWorkout: 'Crear Entrenamiento Personalizado',
            selectRoutine: 'Selecciona una rutina para ver',
            editExercise: 'Editar Ejercicio',
            deleteExercise: 'Eliminar Ejercicio',
            save: 'Guardar',
            cancel: 'Cancelar',
            addExercise: 'A√±adir Ejercicio',
            exerciseLibrary: 'Biblioteca de Ejercicios',
            category: 'Categor√≠a',
            equipment: 'Equipamiento',
            difficulty: 'Dificultad',
            muscleGroups: 'Grupos Musculares',
            formSteps: 'Pasos de Forma',
            proTips: 'Consejos Pro',
            dumbbell: 'Mancernas',
            pilatesBar: 'Barra Pilates',
            band: 'Banda',
            kettlebell: 'Pesa Rusa',
            mat: 'Tapete',
            doorAnchor: 'Ancla de Puerta',
            beginner: 'Principiante',
            intermediate: 'Intermedio',
            advanced: 'Avanzado',
            chest: 'Pecho',
            shoulders: 'Hombros',
            triceps: 'Tr√≠ceps',
            back: 'Espalda',
            biceps: 'B√≠ceps',
            forearms: 'Antebrazos',
            legs: 'Piernas',
            glutes: 'Gl√∫teos',
            hamstrings: 'Isquiotibiales',
            calves: 'Pantorrillas',
            core: 'Core',
            push: 'üí™ Empuje y Mu√±ecas',
            legsAnkles: 'ü¶µ Piernas y Tobillos',
            pull: 'üèãÔ∏è‚Äç‚ôÇÔ∏è Tracci√≥n y Mu√±ecas',
            glutesCore: 'üçë Gl√∫teos y Core',
            metabolic: '‚ö° Circuito Metab√≥lico',
            yoga: 'üßò‚Äç‚ôÇÔ∏è Descanso Activo',
            rest: 'üò¥ Descanso Completo',
            chestShouldersTricepsStr: 'Fuerza de pecho, hombros, tr√≠ceps y salud de mu√±ecas.',
            legsGlutesStr: 'Fuerza de piernas, gl√∫teos y estabilidad de tobillos.',
            backBicepsStr: 'Fuerza de espalda, b√≠ceps y salud de mu√±ecas.',
            posteriorChainAbs: 'Fortalecimiento de la cadena posterior y abdomen.',
            fatBurningCardio: 'Quema de grasa y resistencia cardiovascular. Realizar como circuito.',
            recoveryYoga: 'D√≠a de recuperaci√≥n con Yoga y movilidad. Revisa la pesta√±a de Yoga.',
            recoveryGrowth: '¬°Recuperaci√≥n y Crecimiento. Escucha tu cuerpo!',
            torso: 'Torso',
            notas: 'Notas',
            exerciseLibraryDesc: 'Gu√≠a completa de todos los ejercicios con forma y t√©cnica adecuadas',
            recoveryYogaTitle: 'Yoga de Recuperaci√≥n',
            posesComplementTitle: 'Posturas para complementar tu entrenamiento, mejorar la flexibilidad y acelerar la recuperaci√≥n.',
            weeklyStats: 'Estad√≠sticas Semanales'
        }
    };

    let currentLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY) || 'en';

    function t(key) {
        return translations[currentLanguage]?.[key] || translations.en[key] || key;
    }

    function updateLanguageDisplay() {
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            el.textContent = t(key);
        });
        document.querySelectorAll('[data-routine-key]').forEach(el => {
            const routineKey = el.getAttribute('data-routine-key');
            const routine = routines[routineKey];
            if (routine && routine.title) {
                const title = typeof routine.title === 'function' ? routine.title() : routine.title;
                el.textContent = title.split(' ').slice(1).join(' '); // Remove emoji
            }
        });
        const langToggle = document.getElementById('lang-toggle');
        if (langToggle) {
            langToggle.textContent = currentLanguage === 'en' ? 'üåê ES' : 'üåê EN';
        }
    }

    function switchLanguage() {
        currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
        localStorage.setItem(LANGUAGE_STORAGE_KEY, currentLanguage);
        updateLanguageDisplay();
        // Re-render all visible content with new language
        const activeTab = document.querySelector('.nav-tab.tab-active');
        if (activeTab) {
            switchTab(activeTab.dataset.tab);
        }
    }

    // Exercise name translations
    const exerciseNames = {
        'Dumbbell Bench Press': { en: 'Dumbbell Bench Press', es: 'Press de Banco con Mancernas' },
        'Pilates Bar Shoulder Press': { en: 'Pilates Bar Shoulder Press', es: 'Press de Hombros con Barra Pilates' },
        'Band Flys': { en: 'Band Flys', es: 'Aperturas con Banda' },
        'Dumbbell Lateral Raises': { en: 'Dumbbell Lateral Raises', es: 'Elevaciones Laterales con Mancernas' },
        'Band Triceps Pushdowns': { en: 'Band Triceps Pushdowns', es: 'Fondos de Tr√≠ceps con Banda' },
        'Wrist Extension (Palms down)': { en: 'Wrist Extension (Palms down)', es: 'Extensi√≥n de Mu√±eca (Palmas abajo)' },
        'Pilates Bar Squat': { en: 'Pilates Bar Squat', es: 'Sentadilla con Barra Pilates' },
        'Dumbbell Romanian Deadlift': { en: 'Dumbbell Romanian Deadlift', es: 'Peso Muerto Rumano con Mancernas' },
        'Static Lunge (Ankle Focus)': { en: 'Static Lunge (Ankle Focus)', es: 'Estocada Est√°tica (Enfoque en Tobillo)' },
        'Banded Glute Bridge': { en: 'Banded Glute Bridge', es: 'Puente de Gl√∫teos con Banda' },
        'Calf Raises (Ankle Focus)': { en: 'Calf Raises (Ankle Focus)', es: 'Elevaciones de Pantorrilla (Enfoque en Tobillo)' },
        'Pilates Bar Lat Pulldown': { en: 'Pilates Bar Lat Pulldown', es: 'Jal√≥n de Espalda con Barra Pilates' },
        'Dumbbell Bent-Over Row': { en: 'Dumbbell Bent-Over Row', es: 'Remo Inclinado con Mancernas' },
        'Band Face Pulls': { en: 'Band Face Pulls', es: 'Jalones a la Cara con Banda' },
        'Pilates Bar Bicep Curl': { en: 'Pilates Bar Bicep Curl', es: 'Curl de B√≠ceps con Barra Pilates' },
        'Wrist Flexion (Palms up)': { en: 'Wrist Flexion (Palms up)', es: 'Flexi√≥n de Mu√±eca (Palmas arriba)' },
        'Pull Through': { en: 'Pull Through', es: 'Jal√≥n de Gl√∫teos' },
        'Banded Lateral Walk': { en: 'Banded Lateral Walk', es: 'Caminata Lateral con Banda' },
        'Pilates Bar Russian Twists': { en: 'Pilates Bar Russian Twists', es: 'Giros Rusos con Barra Pilates' },
        'Plank': { en: 'Plank', es: 'Plancha' },
        'Bird-Dog': { en: 'Bird-Dog', es: 'P√°jaro-Perro' },
        'Pilates Bar Thrusters': { en: 'Pilates Bar Thrusters', es: 'Thrusters con Barra Pilates' },
        'Fast Band Rows': { en: 'Fast Band Rows', es: 'Remos R√°pidos con Banda' },
        'Lunge with Twist': { en: 'Lunge with Twist', es: 'Estocada con Giro' },
        'Jumping Jacks': { en: 'Jumping Jacks', es: 'Saltos de Tijera' }
    };

    function getExerciseName(englishName) {
        if (currentLanguage === 'es' && exerciseNames[englishName]) {
            return exerciseNames[englishName].es;
        }
        return englishName;
    }

    // Exercise descriptions in both languages
    const exerciseDescriptions = {
        'Dumbbell Bench Press': { en: 'Chest base strength', es: 'Fortaleza base del pecho' },
        'Pilates Bar Shoulder Press': { en: 'Step on the band for resistance', es: 'P√°rate en la banda para resistencia' },
        'Band Flys': { en: 'Isolate and stretch chest', es: 'Aisla y estira el pecho' },
        'Dumbbell Lateral Raises': { en: 'Shoulder width', es: 'Ancho de hombros' },
        'Band Triceps Pushdowns': { en: 'Isolate triceps', es: 'A√≠sla tr√≠ceps' },
        'Wrist Extension (Palms down)': { en: 'Joint health, with pilates bar', es: 'Salud articular, con barra pilates' },
        'Pilates Bar Squat': { en: 'Step on band, bar on back', es: 'P√°rate en la banda, barra en la espalda' },
        'Dumbbell Romanian Deadlift': { en: 'Focus on hamstrings', es: 'Enfoque en isquiotibiales' },
        'Static Lunge (Ankle Focus)': { en: 'Control ankle stability', es: 'Controla la estabilidad del tobillo' },
        'Banded Glute Bridge': { en: 'Band on knees, push outwards', es: 'Banda en rodillas, empuja hacia afuera' },
        'Calf Raises (Ankle Focus)': { en: 'With pilates bar for resistance', es: 'Con barra pilates para resistencia' },
        'Pilates Bar Lat Pulldown': { en: 'High anchor on door', es: 'Anclaje alto en la puerta' },
        'Dumbbell Bent-Over Row': { en: 'Back strength and density', es: 'Fuerza y densidad de espalda' },
        'Band Face Pulls': { en: 'Shoulder health and posture', es: 'Salud de hombros y postura' },
        'Pilates Bar Bicep Curl': { en: 'Step on band for resistance', es: 'P√°rate en la banda para resistencia' },
        'Wrist Flexion (Palms up)': { en: 'Joint health, with pilates bar', es: 'Salud articular, con barra pilates' },
        'Pull Through': { en: 'Low anchor, focus on glutes', es: 'Anclaje bajo, enfoque en gl√∫teos' },
        'Banded Lateral Walk': { en: 'Band on knees or ankles', es: 'Banda en rodillas o tobillos' },
        'Pilates Bar Russian Twists': { en: 'Hold the bar, twist the torso', es: 'Sost√©n la barra, gira el torso' },
        'Plank': { en: 'Keep body straight', es: 'Mant√©n el cuerpo recto' },
        'Bird-Dog': { en: 'Slow and controlled movement', es: 'Movimiento lento y controlado' },
        'Pilates Bar Thrusters': { en: 'Squat + Shoulder Press', es: 'Sentadilla + Press de Hombros' },
        'Fast Band Rows': { en: 'Fast and steady pace', es: 'Ritmo r√°pido y constante' },
        'Lunge with Twist': { en: 'With pilates bar', es: 'Con barra pilates' },
        'Jumping Jacks': { en: 'Long rest at the end of the round', es: 'Descanso largo al final de la ronda' }
    };

    function getExerciseDescription(englishName) {
        if (currentLanguage === 'es' && exerciseDescriptions[englishName]) {
            return exerciseDescriptions[englishName].es;
        }
        return exerciseDescriptions[englishName]?.en || '';
    }
    
    // --- DOM Elements ---
    const tabs = document.querySelectorAll('.nav-tab');
    const contentSections = document.querySelectorAll('.content-section');
    const routineDetailsContainer = document.getElementById('routine-details-container');
    const hoyContainer = document.getElementById('hoy');
    const calendarBody = document.getElementById('calendar-body');
    const calendarTitle = document.getElementById('calendar-title');
    const mainContent = document.getElementById('main-content');
    const modal = document.getElementById('guide-modal');
    const guideTitle = document.getElementById('guide-title');
    const guideContent = document.getElementById('guide-content');
    const closeBtn = document.getElementById('close-guide-btn');
    const editModal = document.getElementById('edit-exercise-modal');
    const closeEditBtn = document.getElementById('close-edit-modal');
    const editForm = document.getElementById('edit-exercise-form');

    // --- Core Functions ---

    function createRoutineHeaderHTML(routineData, routineKey, isTodayView) {
        const isMetabolic = routineKey === 'METABOLIC';
        let progressHTML = '';
        if (isTodayView) {
            progressHTML = `
                <div class="mb-6">
                    <h3 class="text-center font-bold text-xl mb-3 text-primary">Daily Progress</h3>
                    <div id="progress-text" class="text-center font-bold text-lg mb-2 text-accent" style="text-shadow: var(--glow-accent);">0%</div>
                    <div class="progress-bar-container" style="height: 1rem;">
                        <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
            `;
        }

        let guideButtonHTML = '';
        if (routineData.hasGuide) {
            // Make the guide key dynamic instead of hardcoded
            const guideKey = Object.keys(guides).find(key => routineKey.includes(key));
            if (guideKey) {
                 guideButtonHTML = `<div class="text-center my-4"><button data-guide="${guideKey}" class="show-guide-btn bg-accent text-bg-color font-bold py-2 px-4 rounded-lg hover:bg-accent-hover transition-colors">${t('viewVisualGuide')}</button></div>`;
            }
        }

        const routineTitle = typeof routineData.title === 'function' ? routineData.title() : routineData.title;
        const routineDesc = typeof routineData.description === 'function' ? routineData.description() : routineData.description;

        return `<div class="bg-card-bg/80 p-4 sm:p-6 rounded-lg shadow-lg border ${isMetabolic ? 'metabolic-border metabolic-shadow' : 'border-border'}">
                    ${progressHTML}
                    <h2 class="text-2xl font-bold mb-1 text-center ${isMetabolic ? 'metabolic-text' : 'text-primary'}">${routineTitle}</h2>
                    <p class="text-center text-secondary mb-2">${routineDesc}</p>
                    ${guideButtonHTML}`;
    }

    function createRoutineTableHTML(exercises, isTodayView, routineKey) {
        const rows = exercises.map((ex, index) => `
            <tr class="border-b border-border last:border-b-0 hover:bg-black/20 transition">
                <td class="p-3 font-medium text-primary">
                    <div class="font-semibold">${getExerciseName(ex.name)}</div>
                    <div class="text-xs text-secondary">${getExerciseDescription(ex.name)}</div>
                </td>
                <td class="p-3 text-center text-secondary">${ex.series}</td>
                <td class="p-3 text-center text-secondary">${ex.reps}</td>
                <td class="p-3 text-center text-secondary">${ex.rest}</td>
                <td class="p-3 text-sm text-secondary">${ex.notes || ''}</td>
                ${isTodayView ? `<td class="p-3 text-center"><input type="checkbox" data-exercise-index="${index}" class="h-5 w-5 rounded bg-card-bg border-border text-accent focus:ring-accent"></td>` : `<td class="p-3 text-center"><button class="edit-exercise-btn text-accent hover:text-accent-hover" data-routine="${routineKey}" data-index="${index}" title="Edit">‚úé</button></td>`}
            </tr>
        `).join('');

        return `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-black/30"><tr><th class="p-3 font-semibold text-sm text-secondary uppercase">${t('exercise')}</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">${t('sets')}</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">${t('reps')}</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">${t('rest')}</th><th class="p-3 font-semibold text-sm text-secondary uppercase">${t('notes')}</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">${isTodayView ? t('done') : t('edit')}</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    }

    function createRoutineHTML(routineKey, isTodayView) {
        const routineData = routines[routineKey];
        if (!routineData || !routineData.details) return '';

        const isMetabolic = routineKey === 'METABOLIC';
        
        let progressHTML = '';
        const headerHTML = createRoutineHeaderHTML(routineData, routineKey, isTodayView);
        const tableHTML = createRoutineTableHTML(routineData.details.exercises, isTodayView, routineKey);
        
        // Get unique equipment needed
        const equipmentSet = new Set();
        routineData.details.exercises.forEach(ex => {
            if (ex.name.includes('Dumbbell')) equipmentSet.add('üèãÔ∏è Dumbbells');
            if (ex.name.includes('Pilates Bar')) equipmentSet.add('üéØ Pilates Bar');
            if (ex.name.includes('Band') || ex.name.includes('Banded')) equipmentSet.add('üü∞ Resistance Bands');
            if (ex.name.includes('Kettlebell')) equipmentSet.add('üîî Kettlebell');
            if (ex.name.includes('Plank') || ex.name.includes('Push-up')) equipmentSet.add('üõèÔ∏è Mat/Floor');
            if (ex.name.includes('Pull') || ex.name.includes('Lat')) equipmentSet.add('üö™ Door Anchor');
            if (ex.name.includes('Squat')) equipmentSet.add('üèãÔ∏è Dumbbells or Bar');
        });
        
        let equipmentHTML = '';
        if (equipmentSet.size > 0 && isTodayView) {
            equipmentHTML = `
                <div class="mt-6 p-4 bg-metabolic/10 border border-metabolic/30 rounded-lg">
                    <h4 class="font-bold text-metabolic mb-3">‚öôÔ∏è ${t('equipmentNeeded')}</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        ${Array.from(equipmentSet).map(eq => `<div class="flex items-center gap-2 text-sm text-secondary"><span class="text-base">${eq.split(' ')[0]}</span> <span>${eq.split(' ').slice(1).join(' ')}</span></div>`).join('')}
                    </div>
                </div>
            `;
        }
        
        const commonSectionsHTML = `
            <div class="mt-6 p-4 bg-accent/10 text-accent rounded-lg border border-accent/20">
                <h4 class="font-bold">‚ñ∂Ô∏è WARM-UP (10 MIN BEFORE)</h4>
                <p class="text-sm text-secondary">Joint mobility (wrists, ankles, hips), 5 min light cardio (Jumping Jacks, jogging in place), Bodyweight Squats, Cat-Cow.</p>
            </div>
            <div class="mt-4 p-4 bg-metabolic/10 text-metabolic rounded-lg border border-metabolic/20">
                <h4 class="font-bold">‚è∏Ô∏è COOL-DOWN (10 MIN AFTER)</h4>
                <p class="text-sm text-secondary">Gentle stretches for the muscles worked. Check the Yoga tab for specific ideas based on the routine.</p>
            </div>
        `;
        
        return headerHTML + tableHTML + equipmentHTML + commonSectionsHTML + `</div>`;
    }

    async function displayTodaysPlan() {
        const activityKey = monthlySchedule[day];
        const activity = routines[activityKey];
        const todayName = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        let content = '';
        if (activity.details) {
            content = `<div class="mb-6">
                        <div class="inline-block px-4 py-2 bg-accent/20 border border-accent rounded-full mb-4">
                            <p class="text-accent text-sm font-semibold uppercase tracking-wider">${todayName}</p>
                        </div>
                        <h2 class="text-4xl font-bold animated-text-glow mb-4">Today's Workout</h2>
                    </div>
                    ${createRoutineHTML(activityKey, true)}`;
        } else {
             content = `<div class="mb-6">
                            <div class="inline-block px-4 py-2 bg-accent/20 border border-accent rounded-full mb-4">
                                <p class="text-accent text-sm font-semibold uppercase tracking-wider">${todayName}</p>
                            </div>
                            <h2 class="text-4xl font-bold animated-text-glow mb-6">Today's Plan</h2>
                        </div>
                        <div class="relative overflow-hidden bg-card-bg/80 p-8 sm:p-12 rounded-2xl shadow-2xl border border-accent/30 backdrop-blur-sm">
                            <div class="absolute -right-10 -top-10 w-40 h-40 bg-accent/5 rounded-full blur-3xl"></div>
                            <div class="relative z-10">
                                <div class="mb-6">
                                    <div class="inline-block px-4 py-2 bg-${activity.title.includes('Rest') ? 'emerald' : 'metabolic'}-500/20 border border-${activity.title.includes('Rest') ? 'emerald' : 'metabolic'}-500 rounded-lg mb-4">
                                        <p class="text-${activity.title.includes('Rest') ? 'emerald' : 'metabolic'}-400 text-xs font-bold uppercase tracking-widest">${activity.title.includes('Rest') ? 'üõå Recovery' : '‚ö° Active Recovery'}</p>
                                    </div>
                                </div>
                                <h3 class="text-3xl sm:text-4xl font-bold mb-4" style="background: linear-gradient(135deg, #00D0FF, #9effff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${activity.title}</h3>
                                <p class="text-lg text-secondary leading-relaxed mb-6">${activity.description}</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-8">
                                    <div class="p-4 bg-accent/10 border border-accent/30 rounded-lg">
                                        <p class="text-accent text-sm font-semibold mb-2">FOCUS</p>
                                        <p class="text-secondary">Rest and recover to get stronger üí™</p>
                                    </div>
                                    <div class="p-4 bg-accent/10 border border-accent/30 rounded-lg">
                                        <p class="text-accent text-sm font-semibold mb-2">DURATION</p>
                                        <p class="text-secondary">Flexible - Listen to your body</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
        }
        hoyContainer.innerHTML = content;
    }

    function getStoredProgress() {
        const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
        try {
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Error parsing stored progress:", e);
            return {};
        }
    }

    function updateProgressUI() {
        const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
        const total = checkboxes.length;
        if (total === 0) return;

        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const percentage = Math.round((checked / total) * 100);
        
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        if (progressBar) progressBar.style.width = `${percentage}%`;
        if (progressText) progressText.textContent = `${percentage}% Completado`;
    }

    async function saveProgress() {
        const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
        if (checkboxes.length === 0) return;

        const progressState = Array.from(checkboxes).map(cb => cb.checked);
        const allProgress = getStoredProgress();
        allProgress[dateKey] = progressState;

        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allProgress));
        console.log(`Progreso guardado para ${dateKey}`);
    }

    async function loadProgress() {
        const allProgress = getStoredProgress();
        const todaysProgress = allProgress[dateKey];

        if (todaysProgress) {
            const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
            checkboxes.forEach((cb, index) => {
                if (todaysProgress[index]) {
                    cb.checked = true;
                }
            });
        }
        updateProgressUI();
    }

    async function updateGlobalProgress() {
        const allProgress = getStoredProgress();
        let totalExercisesInMonth = 0;
        let completedExercisesInMonth = 0;

        for (let d = 1; d <= daysInMonth; d++) {
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            if (routine && routine.details) {
                totalExercisesInMonth += routine.details.exercises.length;

                const progressKey = `${year}-${month + 1}-${d}`;
                const dayProgress = allProgress[progressKey];
                if (dayProgress) {
                    completedExercisesInMonth += dayProgress.filter(Boolean).length;
                }
            }
        }

        const globalPercentage = totalExercisesInMonth > 0 ? Math.round((completedExercisesInMonth / totalExercisesInMonth) * 100) : 0;
        
        const globalProgressBar = document.getElementById('global-progress-bar');
        const globalProgressText = document.getElementById('global-progress-text');

        if (globalProgressBar) globalProgressBar.style.width = `${globalPercentage}%`;
        if (globalProgressText) globalProgressText.textContent = `${globalPercentage}% Complete`;
    }

    function generateCalendar() {
        const monthName = today.toLocaleDateString('en-US', { month: 'long' });
        calendarTitle.textContent = `Plan for ${monthName} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

        calendarBody.innerHTML = '';
        for (let i = 0; i < offset; i++) {
            calendarBody.innerHTML += `<div class="bg-black/20 rounded-md"></div>`;
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const activityKey = monthlySchedule[d];
            const activity = routines[activityKey];
            const isToday = (d === day);
            const todayClass = isToday ? 'today' : '';
            const isMetabolic = activityKey === 'METABOLIC';

            // Handle title and description as functions
            const activityTitle = typeof activity.title === 'function' ? activity.title() : activity.title;
            const activityDesc = typeof activity.description === 'function' ? activity.description() : activity.description;

            let dayCell = `
                <div class="calendar-day bg-card-bg/80 p-2 rounded-md border border-border flex flex-col ${todayClass}">
                    <div class="font-bold text-sm text-primary">${d}</div>
                    <div class="text-xs mt-1 flex-grow">
                        <p class="font-semibold ${isMetabolic ? 'metabolic-text' : 'text-accent'}">${activityTitle}</p>
                        <p class="text-secondary hidden sm:block">${activityDesc}</p>
                    </div>
                </div>`;
            calendarBody.innerHTML += dayCell;
        }
    }

    function switchTab(tabName) {
        contentSections.forEach(section => section.classList.remove('active'));
        const activeSection = document.getElementById(tabName);
        if (activeSection) {
            activeSection.classList.add('active');
        }

        tabs.forEach(tab => {
            tab.classList.remove('tab-active');
            if (tab.dataset.tab === tabName) {
                tab.classList.add('tab-active');
            }
        });
    }

    function initModal() {
        mainContent.addEventListener('click', (e) => {
            const button = e.target.closest('.show-guide-btn');
            if (button) {
                const guideKey = button.dataset.guide;
                const guideData = guides[guideKey];
                if(guideData) {
                    // Handle title as function or string
                    const guideTitle_text = typeof guideData.title === 'function' 
                        ? guideData.title() 
                        : (typeof guideData.title === 'object' 
                            ? guideData.title[currentLanguage] || guideData.title.en 
                            : guideData.title);
                    guideTitle.textContent = guideTitle_text;
                    
                    // Handle content as function or string
                    const guideContent_html = typeof guideData.content === 'function' 
                        ? guideData.content() 
                        : guideData.content;
                    guideContent.innerHTML = guideContent_html;
                    modal.classList.add('active');
                }
            }
        });

        closeBtn.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    }

    // --- Statistics Functions ---
    function calculateWeeklyStats() {
        const allProgress = getStoredProgress();
        const today = new Date();
        let weeklyCompletion = 0;
        let workoutsDone = 0;
        let totalExercises = 0;
        let streak = 0;
        let lastCompletedDate = null;

        // Calculate stats for last 7 days
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const d = date.getDate();
            const m = date.getMonth() + 1;
            const y = date.getFullYear();
            const progressKey = `${y}-${m}-${d}`;
            
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            
            if (routine && routine.details) {
                const exerciseCount = routine.details.exercises.length;
                totalExercises += exerciseCount;

                const dayProgress = allProgress[progressKey] || [];
                const completedCount = dayProgress.filter(Boolean).length;
                
                if (completedCount > 0) {
                    weeklyCompletion += completedCount;
                    if (completedCount === exerciseCount) {
                        workoutsDone++;
                    }
                }
            }
        }

        // Calculate streak
        let currentDate = new Date();
        for (let i = 0; i < 365; i++) {
            const d = currentDate.getDate();
            const m = currentDate.getMonth() + 1;
            const y = currentDate.getFullYear();
            const progressKey = `${y}-${m}-${d}`;
            
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            
            if (routine && routine.details) {
                const dayProgress = allProgress[progressKey] || [];
                if (dayProgress.filter(Boolean).length > 0) {
                    streak++;
                } else {
                    break;
                }
            }
            
            currentDate.setDate(currentDate.getDate() - 1);
        }

        const weeklyPercentage = totalExercises > 0 ? Math.round((weeklyCompletion / totalExercises) * 100) : 0;

        return { weeklyPercentage, workoutsDone, totalExercises: weeklyCompletion, streak };
    }

    function updateStatsDashboard() {
        const stats = calculateWeeklyStats();
        document.getElementById('weekly-completion').textContent = `${stats.weeklyPercentage}%`;
        document.getElementById('workouts-done').textContent = stats.workoutsDone;
        document.getElementById('total-exercises').textContent = stats.totalExercises;
        document.getElementById('current-streak').textContent = stats.streak;

        // Update daily breakdown
        const breakdownContainer = document.getElementById('weekly-breakdown');
        const allProgress = getStoredProgress();
        breakdownContainer.innerHTML = '';

        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const d = date.getDate();
            const m = date.getMonth() + 1;
            const y = date.getFullYear();
            const progressKey = `${y}-${m}-${d}`;
            
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            
            if (routine && routine.details) {
                const exerciseCount = routine.details.exercises.length;
                const dayProgress = allProgress[progressKey] || [];
                const completedCount = dayProgress.filter(Boolean).length;
                const percentage = Math.round((completedCount / exerciseCount) * 100);

                const barColor = percentage === 100 ? 'bg-emerald-500' : percentage >= 50 ? 'bg-accent' : 'bg-orange-500';
                breakdownContainer.innerHTML += `
                    <div class="flex items-center gap-3">
                        <span class="w-12 text-sm font-semibold text-secondary">${dayName}</span>
                        <div class="flex-grow bg-black/30 rounded-full h-2">
                            <div class="${barColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                        <span class="w-12 text-right text-xs text-secondary">${completedCount}/${exerciseCount}</span>
                    </div>
                `;
            }
        }
    }

    // --- Exercise Editor Functions ---
    let currentEditingExercise = { routineKey: null, index: null };

    function openEditExerciseModal(routineKey, index) {
        currentEditingExercise = { routineKey, index };
        const routine = routines[routineKey];
        if (!routine || !routine.details || !routine.details.exercises[index]) return;

        const exercise = routine.details.exercises[index];
        document.getElementById('edit-exercise-name').value = exercise.name;
        document.getElementById('edit-exercise-series').value = exercise.series;
        document.getElementById('edit-exercise-reps').value = exercise.reps;
        document.getElementById('edit-exercise-rest').value = exercise.rest;
        document.getElementById('edit-exercise-notes').value = exercise.notes || '';

        editModal.classList.add('active');
    }

    function saveEditedExercise(e) {
        e.preventDefault();
        const { routineKey, index } = currentEditingExercise;
        if (!routineKey || index === null) return;

        const routine = routines[routineKey];
        if (!routine || !routine.details) return;

        routine.details.exercises[index] = {
            name: document.getElementById('edit-exercise-name').value,
            series: document.getElementById('edit-exercise-series').value,
            reps: document.getElementById('edit-exercise-reps').value,
            rest: document.getElementById('edit-exercise-rest').value,
            notes: document.getElementById('edit-exercise-notes').value
        };

        localStorage.setItem(ROUTINES_STORAGE_KEY, JSON.stringify(routines));
        editModal.classList.remove('active');

        // Refresh the routine display
        routineDetailsContainer.innerHTML = createRoutineHTML(routineKey, false);
    }

    function deleteExercise() {
        const { routineKey, index } = currentEditingExercise;
        if (!routineKey || index === null) return;

        if (confirm('Delete this exercise?')) {
            const routine = routines[routineKey];
            if (routine && routine.details) {
                routine.details.exercises.splice(index, 1);
                localStorage.setItem(ROUTINES_STORAGE_KEY, JSON.stringify(routines));
                editModal.classList.remove('active');
                routineDetailsContainer.innerHTML = createRoutineHTML(routineKey, false);
            }
        }
    }

    // --- Event Listeners ---
    function addEventListeners() {
        tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

        // Language toggle
        const langToggle = document.getElementById('lang-toggle');
        if (langToggle) {
            langToggle.addEventListener('click', switchLanguage);
        }

        document.getElementById('rutinas').addEventListener('click', (e) => {
            const button = e.target.closest('.routine-selector');
            if (button) {
                const routineKey = button.dataset.routine;
                routineDetailsContainer.innerHTML = createRoutineHTML(routineKey, false);
                if (window.innerWidth < 640) {
                    routineDetailsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
        
        routineDetailsContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-exercise-btn');
            if (editBtn) {
                const routineKey = editBtn.dataset.routine;
                const index = parseInt(editBtn.dataset.index);
                openEditExerciseModal(routineKey, index);
            }
        });
        
        document.querySelectorAll('.accordion-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                const icon = button.querySelector('span:last-child');
                const isExpanded = content.style.maxHeight;

                // Close all others
                document.querySelectorAll('.accordion-content').forEach(el => {
                    el.style.maxHeight = null;
                    const otherIcon = el.previousElementSibling.querySelector('span:last-child');
                    if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                });

                // Open the clicked one if it was closed
                if (!isExpanded) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    if (icon) icon.style.transform = 'rotate(180deg)';
                }
            });
        });
        
        hoyContainer.addEventListener('change', (e) => {
            if (e.target.matches('input[type="checkbox"]')) {
                saveProgress();
                updateProgressUI();
                updateGlobalProgress(); // Update global progress on change
                updateStatsDashboard(); // Update stats on change
            }
        });

        // Edit modal handlers
        editForm.addEventListener('submit', saveEditedExercise);
        document.getElementById('delete-exercise-btn').addEventListener('click', deleteExercise);
        closeEditBtn.addEventListener('click', () => editModal.classList.remove('active'));
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) editModal.classList.remove('active');
        });

        // ESC key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                modal.classList.remove('active');
                editModal.classList.remove('active');
            }
        });

        initModal();
    }

    // --- Simplified App Start ---
    async function initializeApp() {
        // Add all event listeners
        addEventListeners();
        
        // Load data and set initial state
        await loadProgress();
        displayTodaysPlan();
        generateCalendar();
        updateGlobalProgress();
        updateStatsDashboard(); // Initialize stats
        
        // Set initial UI state
        switchTab('hoy');
        routineDetailsContainer.innerHTML = createRoutineHTML('TORSO_PUSH', false);
        generateExerciseLibrary();
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            const swPath = getPath('/service-worker.js');
            navigator.serviceWorker.register(swPath).catch(err => {
                console.log('Service Worker registration failed:', err);
            });
        }
    }

    // --- App Entry Point ---
    document.addEventListener('DOMContentLoaded', () => {
        // Fix paths for different environments
        const manifestLink = document.getElementById('manifest-link');
        const logoImg = document.getElementById('logo-img');
        
        if (isLocalhost) {
            manifestLink.href = '/manifest.json';
            logoImg.src = '/imagenes/logo.png';
        }
        
        // Initialize language display
        updateLanguageDisplay();
        
        initializeApp();
    });

</script>

</body>
</html>