<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ft Ber Fitness - Plan RetroWave</title>
    <meta name="theme-color" content="#00D0FF">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="fitnesslogo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aldrich&family=Inter:wght@400;600&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #10001C;
            --card-bg: #1A0A2A;
            --text-primary: #F0E6FF;
            --text-secondary: #A094B7;
            --accent: #00D0FF;
            --accent-hover: #9effff;
            --metabolic: #FF00FF;
            --border: #3C1E5A;
            --glow-accent: 0 0 3px var(--accent), 0 0 6px var(--accent), 0 0 10px var(--accent);
            --glow-metabolic: 0 0 3px var(--metabolic), 0 0 6px var(--metabolic), 0 0 10px var(--metabolic);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            /* Updated background with logo and gradient */
            background-image: 
                linear-gradient(rgba(16, 0, 28, 0.95), rgba(16, 0, 28, 0.95)), /* Dark overlay for text readability */
                url('https://i.imgur.com/your-logo-image.png'), /* Replace with your uploaded logo URL */
                linear-gradient(var(--accent), transparent 1px),
                linear-gradient(90deg, var(--accent), transparent 1px);
            background-size: 
                cover, /* For the overlay */
                30% auto, /* Adjust logo size as needed */
                40px 40px,
                40px 40px;
            background-repeat: 
                no-repeat, 
                no-repeat, 
                repeat, 
                repeat;
            background-position: 
                center center, /* For the overlay */
                center 10%, /* Adjust logo position */
                -1px -1px,
                -1px -1px;
            background-blend-mode: overlay, normal, normal, normal; /* Blend the overlay with the logo */
            animation: bg-scroll 3s linear infinite;
        }
        @keyframes bg-scroll {
            0% { background-position: center center, center 10%, 0 0, 0 0; } /* Include logo position */
            100% { background-position: center center, center 10%, 40px 40px, 40px 40px; } /* Include logo position */
        }
        @keyframes text-glow {
            0%, 100% { text-shadow: 0 0 4px var(--accent), 0 0 8px var(--accent), 0 0 12px var(--accent); }
            50% { text-shadow: 0 0 8px var(--accent-hover), 0 0 16px var(--accent-hover), 0 0 24px var(--accent-hover); }
        }
        @keyframes box-glow {
            0%, 100% { box-shadow: 0 0 10px var(--accent), 0 0 15px var(--accent); border-color: var(--accent); }
            50% { box-shadow: 0 0 15px var(--accent-hover), 0 0 30px var(--accent-hover); border-color: var(--accent-hover); }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .main-container {
            background-color: rgba(16, 0, 28, 0.9);
            backdrop-filter: blur(5px);
        }
        h1 {
             font-family: 'Press Start 2P', cursive;
             color: var(--text-primary);
             text-shadow: var(--glow-accent);
             font-size: clamp(1.5rem, 5vw, 3rem);
        }
        .animated-text-glow {
            animation: text-glow 2.5s ease-in-out infinite;
        }
        .animated-box-glow {
            animation: box-glow 2.5s ease-in-out infinite;
        }
        h2, h3, h4, h5 {
             font-family: 'Aldrich', sans-serif;
             color: var(--text-primary);
             text-transform: uppercase;
        }
        .tab-active {
            border-color: var(--accent);
            color: var(--accent);
            text-shadow: var(--glow-accent);
        }
        .content-section { 
            display: none;
        }
        .content-section.active { 
            display: block;
            animation: fade-in 0.4s ease-in-out;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day { 
            min-height: 100px; 
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            border-color: var(--accent) !important;
            box-shadow: var(--glow-accent);
            z-index: 10;
        }
        .calendar-day-header {
            font-size: 0.75rem;
            text-align: center;
            padding: 4px 0;
            color: var(--text-secondary);
            font-family: 'Aldrich', sans-serif;
        }
        .today {
            border-width: 2px;
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(0, 208, 255, 0.7);
        }
        .progress-bar-container {
            background-color: #334155;
            border-radius: 9999px;
            height: 1.25rem;
            width: 100%;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: inset 0 0 5px #000;
        }
        .progress-bar {
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            box-shadow: var(--glow-accent);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(16, 0, 28, 0.8);
            backdrop-filter: blur(8px);
            display: none; /* Changed from opacity */
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0; /* Use opacity for transition */
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .modal-overlay.active {
            display: flex; /* Use display to show/hide */
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 60rem;
            color: var(--text-primary);
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .prose { color: var(--text-secondary); }
        .prose h3 { color: var(--text-primary); text-shadow: var(--glow-accent); }
        .prose h5 { color: var(--text-secondary); }
        .prose a { color: var(--accent); }
        .prose a:hover { color: var(--accent-hover); }
        .prose ul { list-style-type: '‚ö° '; }
        .prose hr { border-color: var(--border); }
        .img-placeholder {
            background-color: var(--bg-color);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            min-height: 200px;
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
        }
        .routine-selector, .nav-tab {
            transition: all 0.2s ease-in-out;
        }
        .routine-selector:hover, .nav-tab:hover {
            transform: translateY(-2px);
            text-shadow: var(--glow-accent);
        }
        .metabolic-text {
            color: var(--metabolic);
            text-shadow: var(--glow-metabolic);
        }
        .metabolic-border {
            border-color: var(--metabolic);
        }
        .metabolic-shadow {
            box-shadow: 0 0 12px rgba(255, 0, 255, 0.7);
        }
        .stats-card {
            background: linear-gradient(135deg, var(--card-bg), rgba(60, 30, 90, 0.5));
            border: 1px solid var(--accent);
            box-shadow: 0 0 8px rgba(0, 208, 255, 0.3);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        @media (max-width: 640px) {
            .calendar-grid {
                gap: 2px;
            }
            .calendar-day {
                min-height: 80px;
                font-size: 0.75rem;
            }
            h2, h3, h4, h5 {
                font-size: clamp(1rem, 3vw, 1.5rem);
            }
        }
        .edit-exercise-modal .modal-content {
            width: 90vw;
            max-width: 500px;
        }
        .routine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .routine-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto max-w-5xl p-4 sm:p-6 main-container rounded-lg shadow-2xl border border-border">
        
        <header class="text-center my-8">
            <!-- Removed the img tag for the logo, as it's now in the background --><h1 class="text-3xl sm:text-4xl animated-text-glow">Ft Ber Fitness</h1>
            <p class="text-lg text-secondary mt-2 font-['Aldrich'] uppercase">Your retro-futuristic training plan.</p>
        </header>

        <div class="mb-8 p-4 bg-card-bg/80 rounded-lg shadow-lg border border-border">
            <h2 class="text-center text-xl font-bold text-primary mb-3">Global Monthly Progress</h2>
            <div id="global-progress-text" class="text-center font-bold text-lg mb-2 text-accent" style="text-shadow: var(--glow-accent);">0%</div>
            <div class="progress-bar-container">
                <div id="global-progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
        </div>

        <nav class="flex justify-center border-b border-border mb-8">
            <div class="flex flex-wrap justify-center -mb-px">
                <button data-tab="hoy" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent">üóìÔ∏è Today</button>
                <button data-tab="stats" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent">üìä Stats</button>
                <button data-tab="calendario" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent">üìÖ Calendar</button>
                <button data-tab="rutinas" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent">üèãÔ∏è‚Äç‚ôÇÔ∏è Routines</button>
                <button data-tab="yoga" class="nav-tab text-md sm:text-lg py-3 px-3 sm:px-6 font-semibold border-b-2 border-transparent text-secondary hover:text-accent">üßò‚Äç‚ôÇÔ∏è Yoga</button>
            </div>
        </nav>

        <main id="main-content">
            <section id="hoy" class="content-section"></section>
            <section id="stats" class="content-section">
                <div class="bg-card-bg/80 p-4 sm:p-6 rounded-lg shadow-lg border border-border">
                    <h2 class="text-2xl font-bold mb-6 text-center">üìä Weekly Statistics</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Weekly Completion</p>
                            <div class="stat-number" id="weekly-completion">0%</div>
                            <p class="text-xs text-secondary mt-2">Last 7 days</p>
                        </div>
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Workouts Done</p>
                            <div class="stat-number" id="workouts-done">0</div>
                            <p class="text-xs text-secondary mt-2">This week</p>
                        </div>
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Total Exercises</p>
                            <div class="stat-number" id="total-exercises">0</div>
                            <p class="text-xs text-secondary mt-2">Completed</p>
                        </div>
                        <div class="stats-card p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-2">Streak</p>
                            <div class="stat-number" id="current-streak">0</div>
                            <p class="text-xs text-secondary mt-2">Days active</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-bold mb-4 text-primary">Daily Breakdown</h3>
                        <div id="weekly-breakdown" class="space-y-2"></div>
                    </div>
                </div>
            </section>
            <section id="calendario" class="content-section">
                 <div class="bg-card-bg/80 p-4 sm:p-6 rounded-lg shadow-lg border border-border">
                    <div class="text-center mb-6">
                        <h2 id="calendar-title" class="text-2xl font-bold"></h2>
                        <p class="text-secondary mt-1">A complete overview of your training month.</p>
                    </div>
                    <div class="calendar-grid font-semibold text-secondary">
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                        <div class="calendar-day-header">Sun</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
            </section>
            <section id="rutinas" class="content-section">
                <div class="mb-6 text-center">
                    <p class="text-secondary">Here you can check the details of each routine. Select one to see the exercises.</p>
                </div>
                <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                    <button data-routine="TORSO_PUSH" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md">üí™ Push</button>
                    <button data-routine="LEGS_ANKLES" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md">ü¶µ Legs & Ankles</button>
                    <button data-routine="TORSO_PULL" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md">üèãÔ∏è‚Äç‚ôÇÔ∏è Pull</button>
                    <button data-routine="GLUTES_CORE" class="routine-selector bg-card-bg hover:bg-border text-accent font-semibold py-2 px-4 border border-border rounded-lg shadow-md">üçë Glutes & Core</button>
                    <button data-routine="METABOLIC" class="routine-selector bg-card-bg hover:bg-border text-metabolic font-semibold py-2 px-4 border border-border rounded-lg shadow-md">‚ö° Metabolic</button>
                </div>
                <div id="routine-details-container"></div>
            </section>
            <section id="yoga" class="content-section space-y-4">
                 <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold">Recovery Yoga</h2>
                    <p class="text-secondary mt-1">Poses to complement your training, improve flexibility, and speed up recovery.</p>
                </div>
                <div class="bg-card-bg/80 p-4 rounded-lg shadow-sm border border-border">
                    <button class="accordion-toggle flex justify-between items-center w-full text-left text-xl font-semibold text-primary">
                        <span>üßò‚Äç‚ôÄÔ∏è Post-Push (Chest, Shoulders, Triceps)</span>
                        <span class="transform transition-transform duration-300">‚ñº</span>
                    </button>
                    <div class="accordion-content pt-2 prose max-w-none">
                        <ul>
                            <li><strong>Puppy Pose (Uttana Shishosana):</strong> Kneel and walk your hands forward, lowering your chest to the ground. Stretches shoulders and chest. Hold for 30-60 seconds.</li>
                            <li><strong>Cow Face Arms (Gomukhasana):</strong> Raise one arm, bend it so your hand touches your back. Bring the other arm from below and try to clasp hands. Stretches triceps and shoulders. Hold 30 sec per side.</li>
                            <li><strong>Wall Chest Stretch:</strong> Place your forearm on a wall at a 90-degree angle. Gently turn your body away for a deep pectoral stretch. Hold 30 sec per side.</li>
                        </ul>
                    </div>
                </div>
                 <div class="bg-card-bg/80 p-4 rounded-lg shadow-sm border border-border">
                    <button class="accordion-toggle flex justify-between items-center w-full text-left text-xl font-semibold text-primary">
                        <span>üßò‚Äç‚ôÇÔ∏è Post-Pull (Back, Biceps)</span>
                        <span class="transform transition-transform duration-300">‚ñº</span>
                    </button>
                    <div class="accordion-content pt-2 prose max-w-none">
                         <ul>
                            <li><strong>Cat-Cow (Marjaryasana-Bitilasana):</strong> On all fours, inhale to arch your back (Cow) and exhale to round it (Cat). Mobilizes and relaxes the entire spine. Perform 10-15 slow repetitions.</li>
                            <li><strong>Supine Spinal Twist (Supta Matsyendrasana):</strong> Lying down, bring one knee to your chest and then cross it over your body, extending the opposite arm. Relaxes the back and chest. Hold 30-60 sec per side.</li>
                            <li><strong>Wall Bicep Stretch:</strong> Standing, extend one arm and place your palm on the wall. Slowly turn your body away until you feel a stretch in your bicep and shoulder. Hold 30 sec per side.</li>
                        </ul>
                    </div>
                </div>
                 <div class="bg-card-bg/80 p-4 rounded-lg shadow-sm border border-border">
                    <button class="accordion-toggle flex justify-between items-center w-full text-left text-xl font-semibold text-primary">
                        <span>üßò‚Äç‚ôÄÔ∏è Post-Legs (Legs, Glutes)</span>
                        <span class="transform transition-transform duration-300">‚ñº</span>
                    </button>
                    <div class="accordion-content pt-2 prose max-w-none">
                        <ul>
                            <li><strong>Runner's Lunge (Anjaneyasana):</strong> From a low lunge position, rest your back knee on the floor. Keep your hands on the floor or on your front knee to stretch the hip flexor and quadriceps. Hold 30 sec per side.</li>
                            <li><strong>Eye of the Needle Pose (Sucirandhrasana):</strong> Lying down, cross one ankle over the opposite knee. Clasp the thigh of the bottom leg and gently pull it towards you to stretch the glute and piriformis. Hold 30-60 sec per side.</li>
                            <li><strong>Legs Up the Wall (Viparita Karani):</strong> Sit sideways against a wall, then swing your legs up the wall as you lie back. This is an excellent passive recovery pose for circulation. Hold for 3-5 minutes.</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for Exercise Guide --><div id="guide-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="guide-title" class="text-2xl font-bold"></h2>
                <button id="close-guide-btn" class="text-2xl font-bold text-secondary hover:text-white">&times;</button>
            </div>
            <div id="guide-content" class="prose max-w-none"></div>
        </div>
    </div>

    <!-- Modal for Exercise Editor -->
    <div id="edit-exercise-modal" class="modal-overlay edit-exercise-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Edit Exercise</h2>
                <button id="close-edit-modal" class="text-2xl font-bold text-secondary hover:text-white">&times;</button>
            </div>
            <form id="edit-exercise-form" class="space-y-4">
                <div>
                    <label class="block text-secondary mb-2">Exercise Name</label>
                    <input id="edit-exercise-name" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-secondary mb-2">Series</label>
                        <input id="edit-exercise-series" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                    </div>
                    <div>
                        <label class="block text-secondary mb-2">Reps</label>
                        <input id="edit-exercise-reps" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                    </div>
                </div>
                <div>
                    <label class="block text-secondary mb-2">Rest Time</label>
                    <input id="edit-exercise-rest" type="text" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" required>
                </div>
                <div>
                    <label class="block text-secondary mb-2">Notes</label>
                    <textarea id="edit-exercise-notes" class="w-full bg-bg-color border border-border rounded px-3 py-2 text-primary" rows="3"></textarea>
                </div>
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="flex-1 bg-accent text-bg-color font-bold py-2 rounded hover:bg-accent-hover transition">Save</button>
                    <button type="button" id="delete-exercise-btn" class="flex-1 bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition">Delete</button>
                </div>
            </form>
        </div>
    </div>

<!-- Firebase SDK Imports --><script type="module">

    // --- App Configuration ---
    const routines = {
        TORSO_PUSH: {
            title: 'üí™ Push & Wrists',
            hasGuide: false, // For now, will need new guides
            description: 'Chest, shoulders, triceps strength and wrist health.',
            details: {
                exercises: [
                    { name: 'Dumbbell Bench Press', series: 4, reps: '8-12', rest: '60s', notes: 'Chest base strength' },
                    { name: 'Pilates Bar Shoulder Press', series: 4, reps: '12-15', rest: '60s', notes: 'Step on the band for resistance' },
                    { name: 'Band Flys', series: 3, reps: '15-20', rest: '45s', notes: 'Isolate and stretch chest' },
                    { name: 'Dumbbell Lateral Raises', series: 3, reps: '15-20', rest: '45s', notes: 'Shoulder width' },
                    { name: 'Band Triceps Pushdowns', series: 3, reps: '15-20', rest: '45s', notes: 'Isolate triceps' },
                    { name: 'Wrist Extension (Palms down)', series: 3, reps: '15-20', rest: '30s', notes: 'Joint health, with pilates bar' }
                ]
            }
        },
        LEGS_ANKLES: {
            title: 'ü¶µ Legs & Ankles',
            hasGuide: true, // The LEGS guide is still relevant
            description: 'Legs, glutes strength and ankle stability.',
            details: {
                exercises: [
                    { name: 'Pilates Bar Squat', series: 4, reps: '12-15', rest: '60s', notes: 'Step on band, bar on back' },
                    { name: 'Dumbbell Romanian Deadlift', series: 3, reps: '12-15', rest: '75s', notes: 'Focus on hamstrings' },
                    { name: 'Static Lunge (Ankle Focus)', series: 3, reps: '10-12/side', rest: '60s', notes: 'Control ankle stability' },
                    { name: 'Banded Glute Bridge', series: 3, reps: '15-20', rest: '45s', notes: 'Band on knees, push outwards' },
                    { name: 'Calf Raises (Ankle Focus)', series: 4, reps: '20-25', rest: '45s', notes: 'With pilates bar for resistance' }
                ]
            }
        },
        TORSO_PULL: {
            title: 'üèãÔ∏è‚Äç‚ôÇÔ∏è Pull & Wrists',
            hasGuide: false,
            description: 'Back, biceps strength and wrist health.',
            details: {
                exercises: [
                    { name: 'Pilates Bar Lat Pulldown', series: 4, reps: '12-15', rest: '60s', notes: 'High anchor on door' },
                    { name: 'Dumbbell Bent-Over Row', series: 4, reps: '8-12', rest: '60s', notes: 'Back strength and density' },
                    { name: 'Band Face Pulls', series: 3, reps: '15-20', rest: '45s', notes: 'Shoulder health and posture' },
                    { name: 'Pilates Bar Bicep Curl', series: 3, reps: '12-15', rest: '45s', notes: 'Step on band for resistance' },
                    { name: 'Wrist Flexion (Palms up)', series: 3, reps: '15-20', rest: '30s', notes: 'Joint health, with pilates bar' }
                ]
            }
        },
        GLUTES_CORE: {
            title: 'üçë Glutes & Core',
            hasGuide: false,
            description: 'Strengthening the posterior chain and abdomen.',
            details: {
                exercises: [
                    { name: 'Pull Through', series: 4, reps: '15-20', rest: '60s', notes: 'Low anchor, focus on glutes' },
                    { name: 'Banded Lateral Walk', series: 3, reps: '12 steps/side', rest: '45s', notes: 'Band on knees or ankles' },
                    { name: 'Pilates Bar Russian Twists', series: 3, reps: '20 twists', rest: '45s', notes: 'Hold the bar, twist the torso' },
                    { name: 'Plank', series: 3, reps: '45-75s', rest: '60s', notes: 'Keep body straight' },
                    { name: 'Bird-Dog', series: 3, reps: '12/side', rest: '30s', notes: 'Slow and controlled movement' }
                ]
            }
        },
        METABOLIC: {
            title: '‚ö° Metabolic Circuit',
            hasGuide: false,
            description: 'Fat burning and cardiovascular endurance. Perform as a circuit.',
            details: {
                exercises: [
                    { name: 'Pilates Bar Thrusters', series: '4 Rounds', reps: '15', rest: '15s', notes: 'Squat + Shoulder Press' },
                    { name: 'Fast Band Rows', series: '4 Rounds', reps: '20', rest: '15s', notes: 'Fast and steady pace' },
                    { name: 'Lunge with Twist', series: '4 Rounds', reps: '10/side', rest: '15s', notes: 'With pilates bar' },
                    { name: 'Jumping Jacks', series: '4 Rounds', reps: '45s', rest: '90s', notes: 'Long rest at the end of the round' }
                ]
            }
        },
        YOGA_REST: { title: 'üßò‚Äç‚ôÇÔ∏è Active Rest', description: 'Recovery day with Yoga and mobility. Check the Yoga tab.' },
        REST: { title: 'üò¥ Full Rest', description: 'Recovery and Growth. Listen to your body!' }
    };

    const guides = {
        LEGS: {
            title: 'Visual Guide: Legs & Core',
            content: `
                <div class="space-y-8">
                    <!-- Squats --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"><div class="prose"><h3>1. Squats</h3><p><strong>Description:</strong> Fundamental exercise for strengthening legs and glutes.</p><h5>Technique:</h5><ul><li>Feet shoulder-width apart, chest up.</li><li>Lower hips back and down, keeping back straight.</li><li>Go down until thighs are parallel to the floor.</li><li>Push up from the heels.</li></ul><a href="https://www.youtube.com/watch?v=l7_B-mI4G6I" target="_blank">Watch on YouTube</a></div><div><img src="https://placehold.co/400x300/1A0A2A/F0E6FF?text=Squats" alt="Squat Image" class="rounded-lg shadow-lg w-full"></div></div><hr>
                    <!-- Romanian Deadlift --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"><div class="prose"><h3>2. Romanian Deadlift (RDL)</h3><p><strong>Description:</strong> Excellent for hamstrings, glutes, and the posterior chain.</p><h5>Technique:</h5><ul><li>Slight knee bend (not locked), straight back.</li><li>Initiate by pushing hips back.</li><li>Lower the weight close to your legs until you feel a stretch.</li><li>Come up by extending your hips.</li></ul><a href="https://www.youtube.com/watch?v=JCX0s_23b3A" target="_blank">Watch on YouTube</a></div><div><img src="https://placehold.co/400x300/1A0A2A/F0E6FF?text=RDL" alt="RDL Image" class="rounded-lg shadow-lg w-full"></div></div><hr>
                    <!-- Lunges --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"><div class="prose"><h3>3. Lunges</h3><p><strong>Description:</strong> Unilateral exercise that works quads, hamstrings, and glutes.</p><h5>Technique:</h5><ul><li>Take a long step forward.</li><li>Lower hips until both knees form a 90-degree angle.</li><li>Front knee aligned with the ankle.</li><li>Push off the front heel to return.</li></ul><a href="https://www.youtube.com/watch?v=zGq_T-gYQ9A" target="_blank">Watch on YouTube</a></div><div><img src="https://placehold.co/400x300/1A0A2A/F0E6FF?text=Lunges" alt="Lunge Image" class="rounded-lg shadow-lg w-full"></div></div><hr>
                    <!-- Glute Bridge --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"><div class="prose"><h3>4. Glute Bridge</h3><p><strong>Description:</strong> Activates and strengthens glutes and hamstrings with low impact.</p><h5>Technique:</h5><ul><li>Lie on your back, knees bent.</li><li>Lift hips to form a straight line from shoulders to knees.</li><li>Squeeze glutes at the top.</li></ul><a href="https://www.youtube.com/watch?v=8bbE64NuDTU" target="_blank">Watch on YouTube</a></div><div><img src="https://placehold.co/400x300/1A0A2A/F0E6FF?text=Glute+Bridge" alt="Glute Bridge Image" class="rounded-lg shadow-lg w-full"></div></div><hr>
                    <!-- Calf Raises --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"><div class="prose"><h3>5. Calf Raises</h3><p><strong>Description:</strong> Focuses on the calf muscles.</p><h5>Technique:</h5><ul><li>Standing, with or without an elevated surface.</li><li>Raise your heels as high as you can.</li><li>Lower slowly for a full stretch.</li></ul><a href="https://www.youtube.com/watch?v=3u_j7g-p4w4" target="_blank">Watch on YouTube</a></div><div><img src="https://placehold.co/400x300/1A0A2A/F0E6FF?text=Calf+Raises" alt="Calf Raise Image" class="rounded-lg shadow-lg w-full"></div></div><hr>
                    <!-- Plank --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"><div class="prose"><h3>6. Forearm Plank</h3><p><strong>Description:</strong> Strengthens the entire core.</p><h5>Technique:</h5><ul><li>Rest on forearms and toes.</li><li>Body in a straight line from head to heels.</li><li>Keep abdomen contracted.</li></ul><a href="https://www.youtube.com/watch?v=E_A3j3A-H7k" target="_blank">Watch on YouTube</a></div><div><img src="https://placehold.co/400x300/1A0A2A/F0E6FF?text=Plank" alt="Plank Image" class="rounded-lg shadow-lg w-full"></div></div><hr>
                    <!-- Bird-Dog --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"><div class="prose"><h3>7. Bird-Dog</h3><p><strong>Description:</strong> Improves core stability and coordination.</p><h5>Technique:</h5><ul><li>On all fours, back straight.</li><li>Extend one arm forward and the opposite leg back.</li><li>Maintain balance and return with control.</li></ul><a href="https://www.youtube.com/watch?v=2b_j_Yq-3Qc" target="_blank">Watch on YouTube</a></div><div><img src="https://placehold.co/400x300/1A0A2A/F0E6FF?text=Bird-Dog" alt="Bird-Dog Image" class="rounded-lg shadow-lg w-full"></div></div>
                </div>
            `
        }
    };
    
    // --- Date & Schedule Variables ---
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth(); // 0-11
    const day = today.getDate(); // 1-31
    const dateKey = `${year}-${month + 1}-${day}`; // Firestore document ID

    const LOCAL_STORAGE_KEY = 'ftber_progress';
    const ROUTINES_STORAGE_KEY = 'ftber_routines';
    const schedulePattern = ['TORSO_PUSH', 'LEGS_ANKLES', 'YOGA_REST', 'TORSO_PULL', 'GLUTES_CORE', 'METABOLIC', 'REST'];
    const monthlySchedule = {};
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const dayOfWeek = date.getDay(); // 0 for Sunday, 1 for Monday...
        const patternIndex = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; // Adjust to make Monday the start of the week
        monthlySchedule[d] = schedulePattern[patternIndex];
    }
    
    // --- DOM Elements ---
    const tabs = document.querySelectorAll('.nav-tab');
    const contentSections = document.querySelectorAll('.content-section');
    const routineDetailsContainer = document.getElementById('routine-details-container');
    const hoyContainer = document.getElementById('hoy');
    const calendarBody = document.getElementById('calendar-body');
    const calendarTitle = document.getElementById('calendar-title');
    const mainContent = document.getElementById('main-content');
    const modal = document.getElementById('guide-modal');
    const guideTitle = document.getElementById('guide-title');
    const guideContent = document.getElementById('guide-content');
    const closeBtn = document.getElementById('close-guide-btn');
    const editModal = document.getElementById('edit-exercise-modal');
    const closeEditBtn = document.getElementById('close-edit-modal');
    const editForm = document.getElementById('edit-exercise-form');

    // --- Core Functions ---

    function createRoutineHeaderHTML(routineData, routineKey, isTodayView) {
        const isMetabolic = routineKey === 'METABOLIC';
        let progressHTML = '';
        if (isTodayView) {
            progressHTML = `
                <div class="mb-6">
                    <h3 class="text-center font-bold text-xl mb-3 text-primary">Daily Progress</h3>
                    <div id="progress-text" class="text-center font-bold text-lg mb-2 text-accent" style="text-shadow: var(--glow-accent);">0%</div>
                    <div class="progress-bar-container" style="height: 1rem;">
                        <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
            `;
        }

        let guideButtonHTML = '';
        if (routineData.hasGuide) {
            // Make the guide key dynamic instead of hardcoded
            const guideKey = Object.keys(guides).find(key => routineKey.includes(key));
            if (guideKey) {
                 guideButtonHTML = `<div class="text-center my-4"><button data-guide="${guideKey}" class="show-guide-btn bg-accent text-bg-color font-bold py-2 px-4 rounded-lg hover:bg-accent-hover transition-colors">View Visual Guide</button></div>`;
            }
        }

        return `<div class="bg-card-bg/80 p-4 sm:p-6 rounded-lg shadow-lg border ${isMetabolic ? 'metabolic-border metabolic-shadow' : 'border-border'}">
                    ${progressHTML}
                    <h2 class="text-2xl font-bold mb-1 text-center ${isMetabolic ? 'metabolic-text' : 'text-primary'}">${routineData.title}</h2>
                    <p class="text-center text-secondary mb-2">${routineData.description}</p>
                    ${guideButtonHTML}`;
    }

    function createRoutineTableHTML(exercises, isTodayView, routineKey) {
        const rows = exercises.map((ex, index) => `
            <tr class="border-b border-border last:border-b-0 hover:bg-black/20 transition">
                <td class="p-3 font-medium text-primary">${ex.name}</td>
                <td class="p-3 text-center text-secondary">${ex.series}</td>
                <td class="p-3 text-center text-secondary">${ex.reps}</td>
                <td class="p-3 text-center text-secondary">${ex.rest}</td>
                <td class="p-3 text-sm text-secondary">${ex.notes || ''}</td>
                ${isTodayView ? `<td class="p-3 text-center"><input type="checkbox" data-exercise-index="${index}" class="h-5 w-5 rounded bg-card-bg border-border text-accent focus:ring-accent"></td>` : `<td class="p-3 text-center"><button class="edit-exercise-btn text-accent hover:text-accent-hover" data-routine="${routineKey}" data-index="${index}" title="Edit">‚úé</button></td>`}
            </tr>
        `).join('');

        return `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-black/30"><tr><th class="p-3 font-semibold text-sm text-secondary uppercase">Exercise</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">Sets</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">Reps</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">Rest</th><th class="p-3 font-semibold text-sm text-secondary uppercase">Notes</th><th class="p-3 font-semibold text-sm text-center text-secondary uppercase">${isTodayView ? 'Done' : 'Edit'}</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    }

    function createRoutineHTML(routineKey, isTodayView) {
        const routineData = routines[routineKey];
        if (!routineData || !routineData.details) return '';

        const isMetabolic = routineKey === 'METABOLIC';
        
        let progressHTML = '';
        const headerHTML = createRoutineHeaderHTML(routineData, routineKey, isTodayView);
        const tableHTML = createRoutineTableHTML(routineData.details.exercises, isTodayView, routineKey);
        const commonSectionsHTML = `
            <div class="mt-6 p-4 bg-accent/10 text-accent rounded-lg border border-accent/20">
                <h4 class="font-bold">‚ñ∂Ô∏è WARM-UP (10 MIN BEFORE)</h4>
                <p class="text-sm text-secondary">Joint mobility (wrists, ankles, hips), 5 min light cardio (Jumping Jacks, jogging in place), Bodyweight Squats, Cat-Cow.</p>
            </div>
            <div class="mt-4 p-4 bg-metabolic/10 text-metabolic rounded-lg border border-metabolic/20">
                <h4 class="font-bold">‚è∏Ô∏è COOL-DOWN (10 MIN AFTER)</h4>
                <p class="text-sm text-secondary">Gentle stretches for the muscles worked. Check the Yoga tab for specific ideas based on the routine.</p>
            </div>
        `;
        
        return headerHTML + tableHTML + commonSectionsHTML + `</div>`;
    }

    async function displayTodaysPlan() {
        const activityKey = monthlySchedule[day];
        const activity = routines[activityKey];
        const todayName = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        let content = '';
        if (activity.details) {
            content = `<div class="text-center mb-6">
                            <h2 class="text-3xl font-bold">Plan for Today</h2>
                            <p class="text-secondary">${todayName}</p>
                        </div>
                        ${createRoutineHTML(activityKey, true)}`;
        } else {
             content = `<div class="bg-card-bg/80 p-6 rounded-lg shadow-lg border border-border text-center">
                            <h2 class="text-3xl font-bold">Plan for Today</h2>
                            <p class="text-secondary mb-4">${todayName}</p>
                            <p class="text-2xl mt-4 text-accent" style="text-shadow: var(--glow-accent);">${activity.title}</p>
                            <p class="mt-2 text-primary">${activity.description}</p>
                        </div>`;
        }
        hoyContainer.innerHTML = content;
    }

    function getStoredProgress() {
        const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
        try {
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Error parsing stored progress:", e);
            return {};
        }
    }

    function updateProgressUI() {
        const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
        const total = checkboxes.length;
        if (total === 0) return;

        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const percentage = Math.round((checked / total) * 100);
        
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        if (progressBar) progressBar.style.width = `${percentage}%`;
        if (progressText) progressText.textContent = `${percentage}% Completado`;
    }

    async function saveProgress() {
        const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
        if (checkboxes.length === 0) return;

        const progressState = Array.from(checkboxes).map(cb => cb.checked);
        const allProgress = getStoredProgress();
        allProgress[dateKey] = progressState;

        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allProgress));
        console.log(`Progreso guardado para ${dateKey}`);
    }

    async function loadProgress() {
        const allProgress = getStoredProgress();
        const todaysProgress = allProgress[dateKey];

        if (todaysProgress) {
            const checkboxes = document.querySelectorAll('#hoy input[type="checkbox"]');
            checkboxes.forEach((cb, index) => {
                if (todaysProgress[index]) {
                    cb.checked = true;
                }
            });
        }
        updateProgressUI();
    }

    async function updateGlobalProgress() {
        const allProgress = getStoredProgress();
        let totalExercisesInMonth = 0;
        let completedExercisesInMonth = 0;

        for (let d = 1; d <= daysInMonth; d++) {
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            if (routine && routine.details) {
                totalExercisesInMonth += routine.details.exercises.length;

                const progressKey = `${year}-${month + 1}-${d}`;
                const dayProgress = allProgress[progressKey];
                if (dayProgress) {
                    completedExercisesInMonth += dayProgress.filter(Boolean).length;
                }
            }
        }

        const globalPercentage = totalExercisesInMonth > 0 ? Math.round((completedExercisesInMonth / totalExercisesInMonth) * 100) : 0;
        
        const globalProgressBar = document.getElementById('global-progress-bar');
        const globalProgressText = document.getElementById('global-progress-text');

        if (globalProgressBar) globalProgressBar.style.width = `${globalPercentage}%`;
        if (globalProgressText) globalProgressText.textContent = `${globalPercentage}% Complete`;
    }

    function generateCalendar() {
        calendarTitle.textContent = `Plan for ${today.toLocaleDateString('en-US', { month: 'long' })} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

        calendarBody.innerHTML = '';
        for (let i = 0; i < offset; i++) {
            calendarBody.innerHTML += `<div class="bg-black/20 rounded-md"></div>`;
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const activityKey = monthlySchedule[d];
            const activity = routines[activityKey];
            const isToday = (d === day);
            const todayClass = isToday ? 'today' : '';
            const isMetabolic = activityKey === 'METABOLIC';

            let dayCell = `
                <div class="calendar-day bg-card-bg/80 p-2 rounded-md border border-border flex flex-col ${todayClass}">
                    <div class="font-bold text-sm text-primary">${d}</div>
                    <div class="text-xs mt-1 flex-grow">
                        <p class="font-semibold ${isMetabolic ? 'metabolic-text' : 'text-accent'}">${activity.title}</p>
                        <p class="text-secondary hidden sm:block">${activity.description}</p>
                    </div>
                </div>`;
            calendarBody.innerHTML += dayCell;
        }
    }

    function switchTab(tabName) {
        contentSections.forEach(section => section.classList.remove('active'));
        const activeSection = document.getElementById(tabName);
        if (activeSection) {
            activeSection.classList.add('active');
        }

        tabs.forEach(tab => {
            tab.classList.remove('tab-active');
            if (tab.dataset.tab === tabName) {
                tab.classList.add('tab-active');
            }
        });
    }

    function initModal() {
        mainContent.addEventListener('click', (e) => {
            const button = e.target.closest('.show-guide-btn');
            if (button) {
                const guideKey = button.dataset.guide;
                const guideData = guides[guideKey];
                if(guideData) {
                    guideTitle.textContent = guideData.title;
                    guideContent.innerHTML = guideData.content;
                    modal.classList.add('active');
                }
            }
        });

        closeBtn.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    }

    // --- Statistics Functions ---
    function calculateWeeklyStats() {
        const allProgress = getStoredProgress();
        const today = new Date();
        let weeklyCompletion = 0;
        let workoutsDone = 0;
        let totalExercises = 0;
        let streak = 0;
        let lastCompletedDate = null;

        // Calculate stats for last 7 days
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const d = date.getDate();
            const m = date.getMonth() + 1;
            const y = date.getFullYear();
            const progressKey = `${y}-${m}-${d}`;
            
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            
            if (routine && routine.details) {
                const exerciseCount = routine.details.exercises.length;
                totalExercises += exerciseCount;

                const dayProgress = allProgress[progressKey] || [];
                const completedCount = dayProgress.filter(Boolean).length;
                
                if (completedCount > 0) {
                    weeklyCompletion += completedCount;
                    if (completedCount === exerciseCount) {
                        workoutsDone++;
                    }
                }
            }
        }

        // Calculate streak
        let currentDate = new Date();
        for (let i = 0; i < 365; i++) {
            const d = currentDate.getDate();
            const m = currentDate.getMonth() + 1;
            const y = currentDate.getFullYear();
            const progressKey = `${y}-${m}-${d}`;
            
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            
            if (routine && routine.details) {
                const dayProgress = allProgress[progressKey] || [];
                if (dayProgress.filter(Boolean).length > 0) {
                    streak++;
                } else {
                    break;
                }
            }
            
            currentDate.setDate(currentDate.getDate() - 1);
        }

        const weeklyPercentage = totalExercises > 0 ? Math.round((weeklyCompletion / totalExercises) * 100) : 0;

        return { weeklyPercentage, workoutsDone, totalExercises: weeklyCompletion, streak };
    }

    function updateStatsDashboard() {
        const stats = calculateWeeklyStats();
        document.getElementById('weekly-completion').textContent = `${stats.weeklyPercentage}%`;
        document.getElementById('workouts-done').textContent = stats.workoutsDone;
        document.getElementById('total-exercises').textContent = stats.totalExercises;
        document.getElementById('current-streak').textContent = stats.streak;

        // Update daily breakdown
        const breakdownContainer = document.getElementById('weekly-breakdown');
        const allProgress = getStoredProgress();
        breakdownContainer.innerHTML = '';

        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const d = date.getDate();
            const m = date.getMonth() + 1;
            const y = date.getFullYear();
            const progressKey = `${y}-${m}-${d}`;
            
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const routineKey = monthlySchedule[d];
            const routine = routines[routineKey];
            
            if (routine && routine.details) {
                const exerciseCount = routine.details.exercises.length;
                const dayProgress = allProgress[progressKey] || [];
                const completedCount = dayProgress.filter(Boolean).length;
                const percentage = Math.round((completedCount / exerciseCount) * 100);

                const barColor = percentage === 100 ? 'bg-emerald-500' : percentage >= 50 ? 'bg-accent' : 'bg-orange-500';
                breakdownContainer.innerHTML += `
                    <div class="flex items-center gap-3">
                        <span class="w-12 text-sm font-semibold text-secondary">${dayName}</span>
                        <div class="flex-grow bg-black/30 rounded-full h-2">
                            <div class="${barColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                        <span class="w-12 text-right text-xs text-secondary">${completedCount}/${exerciseCount}</span>
                    </div>
                `;
            }
        }
    }

    // --- Exercise Editor Functions ---
    let currentEditingExercise = { routineKey: null, index: null };

    function openEditExerciseModal(routineKey, index) {
        currentEditingExercise = { routineKey, index };
        const routine = routines[routineKey];
        if (!routine || !routine.details || !routine.details.exercises[index]) return;

        const exercise = routine.details.exercises[index];
        document.getElementById('edit-exercise-name').value = exercise.name;
        document.getElementById('edit-exercise-series').value = exercise.series;
        document.getElementById('edit-exercise-reps').value = exercise.reps;
        document.getElementById('edit-exercise-rest').value = exercise.rest;
        document.getElementById('edit-exercise-notes').value = exercise.notes || '';

        editModal.classList.add('active');
    }

    function saveEditedExercise(e) {
        e.preventDefault();
        const { routineKey, index } = currentEditingExercise;
        if (!routineKey || index === null) return;

        const routine = routines[routineKey];
        if (!routine || !routine.details) return;

        routine.details.exercises[index] = {
            name: document.getElementById('edit-exercise-name').value,
            series: document.getElementById('edit-exercise-series').value,
            reps: document.getElementById('edit-exercise-reps').value,
            rest: document.getElementById('edit-exercise-rest').value,
            notes: document.getElementById('edit-exercise-notes').value
        };

        localStorage.setItem(ROUTINES_STORAGE_KEY, JSON.stringify(routines));
        editModal.classList.remove('active');

        // Refresh the routine display
        routineDetailsContainer.innerHTML = createRoutineHTML(routineKey, false);
    }

    function deleteExercise() {
        const { routineKey, index } = currentEditingExercise;
        if (!routineKey || index === null) return;

        if (confirm('Delete this exercise?')) {
            const routine = routines[routineKey];
            if (routine && routine.details) {
                routine.details.exercises.splice(index, 1);
                localStorage.setItem(ROUTINES_STORAGE_KEY, JSON.stringify(routines));
                editModal.classList.remove('active');
                routineDetailsContainer.innerHTML = createRoutineHTML(routineKey, false);
            }
        }
    }

    // --- Event Listeners ---
    function addEventListeners() {
        tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

        document.getElementById('rutinas').addEventListener('click', (e) => {
            const button = e.target.closest('.routine-selector');
            if (button) {
                const routineKey = button.dataset.routine;
                routineDetailsContainer.innerHTML = createRoutineHTML(routineKey, false);
                if (window.innerWidth < 640) {
                    routineDetailsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
        
        routineDetailsContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-exercise-btn');
            if (editBtn) {
                const routineKey = editBtn.dataset.routine;
                const index = parseInt(editBtn.dataset.index);
                openEditExerciseModal(routineKey, index);
            }
        });
        
        document.querySelectorAll('.accordion-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                const icon = button.querySelector('span:last-child');
                const isExpanded = content.style.maxHeight;

                // Close all others
                document.querySelectorAll('.accordion-content').forEach(el => {
                    el.style.maxHeight = null;
                    const otherIcon = el.previousElementSibling.querySelector('span:last-child');
                    if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                });

                // Open the clicked one if it was closed
                if (!isExpanded) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    if (icon) icon.style.transform = 'rotate(180deg)';
                }
            });
        });
        
        hoyContainer.addEventListener('change', (e) => {
            if (e.target.matches('input[type="checkbox"]')) {
                saveProgress();
                updateProgressUI();
                updateGlobalProgress(); // Update global progress on change
                updateStatsDashboard(); // Update stats on change
            }
        });

        // Edit modal handlers
        editForm.addEventListener('submit', saveEditedExercise);
        document.getElementById('delete-exercise-btn').addEventListener('click', deleteExercise);
        closeEditBtn.addEventListener('click', () => editModal.classList.remove('active'));
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) editModal.classList.remove('active');
        });

        // ESC key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                modal.classList.remove('active');
                editModal.classList.remove('active');
            }
        });

        initModal();
    }

    // --- Simplified App Start ---
    async function initializeApp() {
        // Add all event listeners
        addEventListeners();
        
        // Load data and set initial state
        await loadProgress();
        displayTodaysPlan();
        generateCalendar();
        updateGlobalProgress();
        updateStatsDashboard(); // Initialize stats
        
        // Set initial UI state
        switchTab('hoy');
        routineDetailsContainer.innerHTML = createRoutineHTML('TORSO_PUSH', false);
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(err => {
                console.log('Service Worker registration failed:', err);
            });
        }
    }

    // --- App Entry Point ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });

</script>

</body>
</html>